window.log=function(){if(window.console)console.log(Array.prototype.slice.call(arguments))};var f2d=function(n){if(n<10)return"0"+n;return String(n)};var dt_to_Date=function(dt){var date=new Date(Date.UTC(parseInt("20"+dt[0]+dt[1],10),parseInt(dt[2]+dt[3],10)-1,parseInt(dt[4]+dt[5],10),parseInt(dt[6]+dt[7],10),parseInt(dt[8]+dt[9],10),parseInt(dt[10]+dt[11],10)));return date};var dt_to_date=function(dt){var date=dt_to_Date(dt);return f2d(date.getDate())+"/"+f2d(date.getMonth()+1)+"/"+date.getFullYear()};
var dt_to_time=function(dt){var date=dt_to_Date(dt);return date.toLocaleTimeString()};var dt_to_datetime=function(dt){return dt_to_date(dt)+" "+dt_to_time(dt)};var Date_to_date=function(date){return f2d(date.getDate())+"/"+f2d(date.getMonth()+1)+"/"+date.getFullYear()};var Date_to_time=function(date){return date.toLocaleTimeString()};var Date_to_datetime=function(date){return Date_to_date(date)+" "+Date_to_time(date)};
var td_to_hms=function(d){var minutes=(d-d%60)/60;var hours=(minutes-minutes%60)/60;minutes=minutes%60;var seconds=d%60;if(hours)return hours+" ч "+minutes+" мин "+seconds+" сек";else if(minutes)return minutes+" мин "+seconds+" сек";else return seconds+" сек"};
var td_to_time=function(d){var minutes=(d-d%60)/60;var hours=(minutes-minutes%60)/60;minutes=minutes%60;var seconds=d%60;var r="";if(hours<10)r+="0"+hours+":";else r+=hours+":";if(minutes<10)r+="0"+minutes+":";else r+=minutes+":";if(seconds<10)r+="0"+seconds;else r+=seconds;return r};var Date_to_daystart=function(d){var date=new Date(d);date.setHours(0);date.setMinutes(0);date.setSeconds(0);return date};
var Date_to_daystop=function(d){var date=new Date(d);date.setHours(23);date.setMinutes(59);date.setSeconds(59);return date};var Date_to_url=function(d){return f2d(d.getUTCFullYear()-2E3)+f2d(d.getUTCMonth()+1)+f2d(d.getUTCDate())+f2d(d.getUTCHours())+f2d(d.getUTCMinutes())+f2d(d.getUTCSeconds())};var ln_to_km=function(l){if(l>=1)return Math.round(l*10)/10+" км";else return Math.round(l*1E3)+" м"};
var geocode_to_addr=function(results){var comp={street_address:"",route:"",locality:"",sublocality:"",administrative_area_level_2:"",administrative_area_level_1:"",country:""};for(var i in results)for(var j in results[i].address_components){var c=results[i].address_components[j];comp[c.types[0]]=c.long_name}return""+comp.country+", "+comp.administrative_area_level_1+", "+(comp.locality==""?(comp.sublocality!=""?comp.sublocality:comp.administrative_area_level_2)+" район, ":"")+(comp.locality!=""?comp.locality+
", ":"")+comp.route+(comp.street_number!=""?", "+comp.street_number:"")};var geocode_to_addr2=function(results){for(var i in results){var r=results[i];if(r.types.indexOf("street_address")!=-1||r.types.indexOf("sublocality")!=-1||r.types.indexOf("locality")!=-1)return r.formatted_address}if(results[1])return results[1].formatted_address;else if(results[0])return results[0].formatted_address;return"Адрес неизвестен"};var config=config||{};config.updater={};config.updater.queue={};
config.updater.add=function(msg,foo){config.updater.queue[msg]=config.updater.queue[msg]||[];config.updater.queue[msg].push(foo)};config.updater.process=function(msg){if(config.updater.queue[msg.msg])for(var i in config.updater.queue[msg.msg])config.updater.queue[msg.msg][i](msg);if(config.updater.queue["*"])for(var i in config.updater.queue["*"])config.updater.queue["*"][i](msg)};
config.updater.add("*",function(msg){if(config.admin)if(msg.msg)message("Получено сообщени об обновлении:<b>"+msg.msg+"</b>")});config.updater.tabs=[];config.updater.add("changedesc",function(msg){for(var i in config.systems)if(config.systems[i].skey==msg.data.skey)config.systems[i].desc=msg.data.desc;if(msg.data.skey in config.sysbykey)config.sysbykey[msg.data.skey].desc=msg.data.desc});
config.syslist=function(options){var list=$("#"+options.id);var Make_SysList=function(){list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+s.imei+'" value="'+s.skey+'">'+s.desc+"</option>")}};Make_SysList();$(list).bind({change:options.change});config.updater.add("changeslist",function(msg){log("config.syslist: Update system list");Make_SysList()});config.updater.add("changedesc",function(msg){$(list).children('option[value="'+msg.data.skey+'"]').html(msg.data.desc)})};
var UpdateAccountSystemList=function(){if(config&&config.akey)$.getJSON("/api/info?akey="+config.akey,function(data){if(data){log("UpdateAccountSystemList data:",data);config.systems=[];config.sysbykey={};for(var i in data.info.account.systems){var s=data.info.account.systems[i];config.systems.push({"imei":s.imei,"skey":s.key,"desc":s.desc});config.sysbykey[s.key]={imei:s.imei,desc:s.desc}}config.updater.process({msg:"changeslist"})}})};UpdateAccountSystemList();
config.updater.add("change_slist",function(msg){log("BASE: Update system list");UpdateAccountSystemList()});log("root");(function(window){var document=window.document;var initHA=function(){var is_ie6=window.external&&typeof window.XMLHttpRequest=="undefined";var styles="div#messages{position:fixed;top:0px;right:0px;width:250px;margin:0px;padding:0px;background:transparent;z-index:2}"+"div#messages div{cursor: pointer;color:#fff;padding:7px;margin-bottom:7px;-moz-border-radius:5px;-webkit-border-radius:5px;-khtml-border-radius:5px;opacity:0.75;background:#888;font: normal 12px 'Georgia'}"+"div#messages div.error{background:#98001b}\tdiv#messages div.message{background:#0d8529}div#messages div.warning{background:#dd6; color:#333}";
var iestyles="body{position:relative}div#messages{position:absolute; -ms-filter:'progid:DXImageTransform.Microsoft.Alpha(Opacity=75)'; filter: alpha(opacity=75)}div#messages div{cursor: hand}";var addLoadEvent=function(func){var oldonload=window.onload;if(typeof window.onload!="function")window.onload=func;else window.onload=function(){if(oldonload)oldonload();func()}};var import_style=function(src){if(src==null||src==undefined)return;var imprt=document.createElement("style");imprt.setAttribute("type",
"text/css");if(imprt.styleSheet)imprt.styleSheet.cssText=src;else imprt.appendChild(document.createTextNode(src));document.getElementsByTagName("head")[0].appendChild(imprt)};var addAll=function(){var messageBox=document.createElement("div");messageBox.id="messages";if(document.body.firstChild)document.body.insertBefore(messageBox,document.body.firstChild);else document.body.appendChild(messageBox);import_style(styles);if(is_ie6)import_style(iestyles)};if(document.body==null)return addLoadEvent(function(){addAll()})};
initHA();var message=function(mtext,mtype,howlong){var mtype=mtype||"message";var howlong=howlong||8E3;if(document.getElementById("messages")==null){setTimeout(function(){message(mtext,mtype,howlong)},100);return}var alarm=document.createElement("div");alarm.className=mtype;alarm.innerHTML=mtext;alarm.onclick=function(){alarm.style.display="none"};alarm.del=function(){document.getElementById("messages").removeChild(alarm)};document.getElementById("messages").appendChild(alarm);setTimeout(alarm.del,
howlong)};window["message"]=message})(window);(function(window,$,undefined){var lists_count=0;function SysList(){lists_count+=1;this.listnum=lists_count;log("SysList: init",lists_count,this.listnum)}var rebuild=function(){log("SysList: rebuild",this,lists_count,this.listnum)};SysList.prototype.Rebuild=rebuild;window["SysList"]=SysList;$(document).ready(function(){rebuild()})})(window,jQuery);function MyMarker(map){this.map=map;this.div=null;this.arrdiv=null;this.title=null;this.point=null;this.infowindow=null;this.skey=null;this.setMap(map)}MyMarker.prototype=new google.maps.OverlayView;var add_geo_row=function(label,value){$("#tbl_info tbody").append("<tr><td>"+label+"</td><td><b>"+value+"</b></td></tr>")};
var more_info=function(data){$("#moreinfo").html("");add_geo_row("Спутники",data.point.sats);add_geo_row("Скорость",data.point.speed+"км/ч");add_geo_row("Основное питание",data.point.vout+"В");add_geo_row("Резервное питание",data.point.vin+"В");add_geo_row("Тип метки",data.point.fsource)};MyMarker.prototype.HideInfo=function(){if(this.infowindow)this.infowindow.close()};
MyMarker.prototype.Info=function(){var point=this.point;var skey=this.skey;if(this.infowindow)this.infowindow.close();this.infowindow=new google.maps.InfoWindow({content:'<div style="width: 220px; height: 160px; border: none;"><div class="info-header">'+dt_to_datetime(point.date)+"</div>"+'<table id="tbl_info" width="100%">'+"<tr><td>Направление:</td><td><b>"+point.angle.toFixed(0)+"°</b></td></tr>"+"<tr><td>Долгота:</td><td><b>"+point.lat().toFixed(5)+"</b></td></tr>"+"<tr><td>Широта:</td><td><b>"+
point.lng().toFixed(5)+"</b></td></tr>"+"</table>"+'<div id="moreinfo" title="Ожидайте, идет получение дополнительной информации."><center><img src="/images/loading.gif" /></center></div></div>',position:point});var self=this;$.getJSON("/api/geo/info?skey="+skey+"&point="+point.date,function(data){if(data.answer&&data.answer==="ok")if($("#tbl_info tbody"))$("#tbl_info tbody").ready(function(){more_info(data)})});this.infowindow.open(this.map)};
MyMarker.prototype.onAdd=function(){log("MyMarker.prototype.onAdd: This:",this);var div=document.createElement("div");div.marker=this;div.setAttribute("class","mymarker");var arrdiv=document.createElement("div");arrdiv.setAttribute("class","mymarker-arrow");div.appendChild(arrdiv);div.addEventListener("click",function(e){this.marker.Info()},false);if(0){div.addEventListener("mouseover",function(e){arrdiv=document.getElementById("arrowdiv");if(arrdiv==null){arrdiv=document.createElement("div");arrdiv.setAttribute("id",
"arrowdiv");arrdiv.setAttribute("class","arrowdiv");panes.overlayMouseTarget.appendChild(arrdiv)}arrdiv.setAttribute("style","-webkit-transform: rotate("+this.marker.angle+"deg);z-index:-1;");var overlayProjection=this.marker.getProjection();arrdiv.style.left=parseInt(this.marker.div.style.left,10)-13+"px";arrdiv.style.top=parseInt(this.marker.div.style.top,10)-13+"px"},false);div.addEventListener("mouseout",function(e){arrdiv=document.getElementById("arrowdiv");if(arrdiv)arrdiv.style.display="none"},
false)}if(0){var arrdiv=document.createElement("div");arrdiv.setAttribute("class","arrowdiv");arrdiv.setAttribute("style","-webkit-transform: rotate("+this.angle+"deg);z-index:-1;");if(this.i%8)arrdiv.style.display="none"}this.div=div;this.arrdiv=arrdiv;var panes=this.getPanes();this.panes=panes;panes.overlayImage.appendChild(div)};MyMarker.prototype.setTitle=function(title){this.div.setAttribute("title",title);this.title=title};MyMarker.prototype.setSysKey=function(skey){this.skey=skey};
MyMarker.prototype.setPosition=function(point){this.point=point;this.arrdiv.setAttribute("style","-webkit-transform: rotate("+point.angle+"deg);z-index:-1;");this.setTitle(dt_to_datetime(point.date));this.draw()};MyMarker.prototype.onRemove=function(){this.div.removeChild(this.arrdiv);this.div.parentNode.removeChild(this.div);this.arrdiv=null;this.div=null};MyMarker.prototype.draw=function(){log("MyMarker.prototype.draw: This:",this)};(function(){function LastMarker(options){this.div=null;this.arrdiv=null;this.options=options;this.position=options.position;this.point=options.point;this.color=options.color||"green";this.desc=options.desc||"Не определено";this.skey=options.skey;this.setMap(options.map)}LastMarker.prototype=new google.maps.OverlayView;LastMarker.prototype.Info=function(){if(0){var point=this.point;var skey=this.skey;log("skey = "+skey);if(this.infowindow)this.infowindow.close();this.infowindow=new google.maps.InfoWindow({content:'<div style="width: 220px; height: 220px; border: none;"><div class="info-header">'+
dt_to_datetime(point.date)+"</div>"+'<table id="tbl_info" width="100%">'+"<tr><td>Направление:</td><td><b>"+point.angle.toFixed(0)+"°</b></td></tr>"+"<tr><td>Долгота:</td><td><b>"+point.lat().toFixed(5)+"</b></td></tr>"+"<tr><td>Широта:</td><td><b>"+point.lng().toFixed(5)+"</b></td></tr>"+"</table>"+'<div id="moreinfo" title="Ожидайте, идет получение дополнительной информации."><center><img src="/images/loading.gif" /></center></div></div>',position:point});var self=this;$.getJSON("/api/geo/info?skey="+
skey+"&point="+point.date,function(data){log("JSON data: ",data);if(data.answer&&data.answer==="ok")if($("#tbl_info tbody"))$("#tbl_info tbody").ready(function(){log("JSON data: jquery domready.");more_info(data)})});this.infowindow.open(map)}};var SVG={};SVG.ns="http://www.w3.org/2000/svg";SVG.xlinkns="http://www.w3.org/1999/xlink";LastMarker.prototype.onAdd=function(){var div=document.createElement("div");div.marker=this;div.setAttribute("class","lastmarker");div.setAttribute("title",this.options.desc+
"\n"+this.point.time);div.setAttribute("skey",this.skey);var label=document.createElement("div");label.setAttribute("class","lastmarker-label");label.innerHTML=this.options.desc;var control=document.createElement("div");control.setAttribute("class","lastmarker-control");label.appendChild(control);div.appendChild(label);var svg=document.createElementNS(SVG.ns,"svg:svg");svg.setAttribute("style","margin: -8px -8px -8px -8px");svg.setAttribute("width","32px");svg.setAttribute("height","32px");svg.setAttributeNS("http://www.w3.org/2000/xmlns/",
"xmlns:xlink",SVG.xlinkns);var g=document.createElementNS(SVG.ns,"g");g.setAttributeNS(null,"transform","translate(16,16)");var shape=document.createElementNS(SVG.ns,"polyline");shape.setAttributeNS(null,"points","-8,-4 0,-15 8,-4");shape.setAttributeNS(null,"fill","none");shape.setAttributeNS(null,"stroke","black");shape.setAttributeNS(null,"stroke-width","2px");shape.setAttributeNS(null,"transform","rotate("+this.point.course+")");this.shape=shape;g.appendChild(shape);svg.appendChild(g);div.appendChild(svg);
div.addEventListener("click",function(e){log("lastmarker: click",e)},false);var me=this;div.addEventListener("mouseover",function(e){var panel="";panel+="<table><tbody>";panel+="<tr><td>Время</td><td>"+dt_to_datetime(me.point.time)+"</td></tr>";panel+="<tr><td>Скорость</td><td>"+me.point.speed+"</td></tr>";panel+="<tr><td>Осн.питание</td><td>"+me.point.vout+"</td></tr>";panel+="<tr><td>Рез.питание</td><td>"+me.point.vin+"</td></tr>";panel+="<tr><td>Спутники</td><td>"+me.point.sats+"</td></tr>";panel+=
"<tr><td>Топливо</td><td>-</td></tr>";panel+="</tbody></table>";control.innerHTML=panel},false);div.addEventListener("mouseout",function(e){},false);if(0){var arrdiv=document.createElement("div");arrdiv.setAttribute("class","arrowdiv");arrdiv.setAttribute("style","-webkit-transform: rotate("+this.angle+"deg);z-index:-1;");if(this.i%8)arrdiv.style.display="none"}this.div=div;this.label=label;this.control=null;var panes=this.getPanes();this.panes=panes;panes.overlayImage.appendChild(div)};LastMarker.prototype.setPosition=
function(point,position){this.position=position;this.point=point;this.draw()};LastMarker.prototype.onRemove=function(){this.div.removeChild(this.arrdiv);this.div.parentNode.removeChild(this.div);this.arrdiv=null;this.div=null};LastMarker.prototype.draw=function(){if(this.position){var overlayProjection=this.getProjection();var divpx=overlayProjection.fromLatLngToDivPixel(this.position);var div=this.div;div.style.left=divpx.x-8+"px";div.style.top=divpx.y-8+"px";if(this.shape)this.shape.setAttributeNS(null,
"transform","rotate("+this.point.course+")")}};window["LastMarker"]=LastMarker})();(function($,undefined){var PROP_NAME="gmap";function GMap(){this.debug=false;this._curInst=null;this._mainDivId="gmap";this.regional=[];this.regional[""]={closeText:"Close"};this._defaults={pos:new google.maps.LatLng(48.5,34.599),maptype:google.maps.MapTypeId.ROADMAP,zoom:10,marker:"none",markertitme:"Ooooops!"};this.Image_Stop=new google.maps.MarkerImage("/images/marker-stop.png",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));this.Image_Halt=new google.maps.MarkerImage("/images/marker-halt.png",
new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.extend(this._defaults,this.regional[""])}$.extend(GMap.prototype,{markerClassName:"hasGMap",_widgetGMap:function(){return this.dpDiv},_getInst:function(target){try{return $.data(target,PROP_NAME)}catch(err){throw"Missing instance data for this gmap";}},_setPos:function(inst,date,noChange){},_setPosGMap:function(target,pos){var inst=this._getInst(target);if(inst)this._setPos(inst,pos);else;},_destroyGMap:function(target){var $target=
$(target);var inst=$.data(target,PROP_NAME);if(!$target.hasClass(this.markerClassName)){log("GMAP error: not a map");return}var nodeName=target.nodeName.toLowerCase();$.removeData(target,PROP_NAME);$target.removeClass(this.markerClassName).empty()},_optionGMap:function(target,name,value){var inst=this._getInst(target);if(arguments.length==2&&typeof name=="string")return name=="defaults"?$.extend({},$.gmap._defaults):inst?name=="all"?$.extend({},inst.settings):this._get(inst,name):null},_get:function(inst,
name){return inst.settings[name]!==undefined?inst.settings[name]:this._defaults[name]},_attachMap:function(target,settings){var nodeName=target.nodeName.toLowerCase();var id=this._mainDivId=target.id;var divSpan=$(target);var inst=$.data(target,PROP_NAME,$.extend({},this._defaults,settings||{}));inst.settings=$.extend({},settings||{});var mapdiv=document.createElement("div");mapdiv.id=this._mainDivId+"_m";mapdiv.className="map-container";var controldiv=document.createElement("div");controldiv.className=
"map-control";controldiv.innerHTML=""+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_map" value="0" name="'+this._mainDivId+'_type" checked="checked" /><label for="'+this._mainDivId+'btn_map">Карта</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_sat" value="1" name="'+this._mainDivId+'_type" /><label for="'+this._mainDivId+'btn_sat">Спутник</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_hybr" value="2" name="'+this._mainDivId+
'_type" /><label for="'+this._mainDivId+'btn_hybr">Гибрид</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_terr" value="3" name="'+this._mainDivId+'_type" /><label for="'+this._mainDivId+'btn_terr">Рельеф</label>';divSpan.append(mapdiv);divSpan.append(controldiv);divSpan.addClass(this.markerClassName);var mapOptions={center:inst.settings.pos||new google.maps.LatLng(48.5,34.599),mapTypeId:inst.settings.maptype||google.maps.MapTypeId.ROADMAP,mapTypeControl:false,scaleControl:true,
disableDoubleClickZoom:true,draggableCursor:"default",zoom:inst.settings.zoom};var map=new google.maps.Map(mapdiv,mapOptions);inst.settings.map=map;$(controldiv).buttonset();$(controldiv).find("input").change(function(){switch($(this).attr("value")){case "0":map.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case "1":map.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case "2":map.setMapTypeId(google.maps.MapTypeId.HYBRID);break;case "3":map.setMapTypeId(google.maps.MapTypeId.TERRAIN);break}})}});
$.fn.gmap=function(options){if(!$.gmap.initialized)$.gmap.initialized=true;var otherArgs=Array.prototype.slice.call(arguments,1);if(options=="option"&&arguments.length==2&&typeof arguments[1]=="string")return $.gmap["_"+options+"GMap"].apply($.gmap,[this[0]].concat(otherArgs));return this.each(function(){typeof options=="string"?$.gmap["_"+options+"GMap"].apply($.gmap,[this].concat(otherArgs)):$.gmap._attachMap(this,options)})};$.gmap=new GMap;$.gmap.initialized=false;$.gmap.version="0.0.2";$.gmap.images=
{};$.gmap.images["start"]=new google.maps.MarkerImage("/images/marker-start.png?v=1",new google.maps.Size(24,20),new google.maps.Point(0,0),new google.maps.Point(11,19));$.gmap.images["finish"]=new google.maps.MarkerImage("/images/marker-finish.png?v=1",new google.maps.Size(28,20),new google.maps.Point(0,0),new google.maps.Point(14,19));$.gmap.images["begin"]=new google.maps.MarkerImage("/images/marker-begin.png?v=1",new google.maps.Size(30,20),new google.maps.Point(0,0),new google.maps.Point(15,
19));$.gmap.images["end"]=new google.maps.MarkerImage("/images/marker-end.png?v=1",new google.maps.Size(30,20),new google.maps.Point(0,0),new google.maps.Point(15,19));$.gmap.images["stop"]=new google.maps.MarkerImage("/images/marker-stop.png?v=1",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["halt"]=new google.maps.MarkerImage("/images/marker-halt.png?v=1",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["alarm"]=
new google.maps.MarkerImage("/images/marker-alarm.png?v=3",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["center"]=new google.maps.MarkerImage("/images/marker-center.png?v=1",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(15,15))})(jQuery);(function($,undefined){var alertcnt=0;var geocoder;if("google"in window)geocoder=new google.maps.Geocoder;window.config["informer"]={};config.updater.add("inform",function(msg){log("Inform: update",msg);if(msg.data.skey in window.config.informer){var infs=window.config.informer[msg.data.skey];for(var i in infs)if(infs[i].msg==msg.data.msg){infs[i].callback();delete infs[i]}}});var push_informer=function(skey,msg,callback){if(!(skey in window.config.informer))window.config.informer[skey]=[];window.config.informer[skey].push({"msg":msg,
"callback":callback})};window.config["alarm"]={};var remove_alert_icon=function(skey){$('div#alert_container>span[skey="'+skey+'"]').remove()};var show_alarm_window=function(skey,update){var data=window.config.alarm[skey];if(update){var sound=new Audio;sound.src="sound/alarm."+(sound.canPlayType("audio/ogg")?"ogg":sound.canPlayType("audio/mp3")?"mp3":"wav");sound.play()}if(update){data.dthistory=data.dthistory||[];data.dthistory.push(data.dt)}data.position=new google.maps.LatLng(data.lpos[0],data.lpos[1]);
if($("#alarmdlg_"+skey).length>0){if($(data.dialog).dialog("isOpen")){if(update)$(data.dialog).parent().children().first().children().first().effect("pulsate")}else $(data.dialog).dialog("open");data.map.panTo(data.position);data.marker.setPosition(data.position)}else{var messageBox=document.createElement("div");messageBox.id="alarmdlg_"+skey;messageBox.className="alertmsg";messageBox.innerHTML="Система: <b>"+window.config.sysbykey[skey].desc+"</b>"+"<br/>Идентификатор: <b>"+data.fid+"</b>";if(document.body.firstChild)document.body.insertBefore(messageBox,
document.body.firstChild);else document.body.appendChild(messageBox);data.datetime=document.createElement("div");messageBox.appendChild(data.datetime);data.addres=document.createElement("div");messageBox.appendChild(data.addres);var dmap=document.createElement("div");dmap.id="alarmmap_"+String((new Date).getTime());dmap.className="alertmap";messageBox.appendChild(dmap);var $map=$(dmap).gmap({pos:data.position,zoom:15,marker:"center"});data.map=$($map).gmap("option","map");data.marker=new google.maps.Marker({position:data.position,
map:data.map,title:"Последнее известное положение.",icon:$.gmap.images["alarm"],draggable:false});alertcnt++;window.config.alarm[skey].dialog=$(messageBox).dialog({title:'<span class="ui-icon ui-icon-alert" style="display:inline-block;"></span> <span style="color:red;">Внимание! Нажата тревожная кнопка.</span>',resizable:false,modal:false,autoOpen:true,width:630,height:420,buttons:[{text:"Подтверждение",click:function(event,ui){var btn=event.currentTarget;var cncl_btn=event.currentTarget.nextSibling;
var dialog=this;log($(dialog).dialog("option","buttons"));console.dir($(dialog).dialog("option","buttons"));$(btn).button("option",{icons:{primary:"ui-icon-gear"},label:"Отправка подтверждения...",disabled:true});$.getJSON("/api/alarm/confirm?akey="+window.config.akey+"&imei="+config.sysbykey[skey].imei,function(data){if(data.answer&&data.answer==="ok"){$(btn).button("option",{icons:{primary:"ui-icon-zoomin"},label:"Ожидание ответа...",disabled:true});push_informer(skey,"ALARM_CONFIRM",function(){log("Inform: wait-callback done.");
$(btn).button("option",{icons:{primary:"ui-icon-flag"},label:"Подтверждено!",disabled:true});window.config.alarm[skey].confirmed=true;window.config.alarm[skey].confirmby=window.config.user.nickname;window.config.alarm[skey].confirmwhen=Date_to_url(new Date);$(cncl_btn).button("option",{disabled:false});add_alert_icon(skey)})}})}},{text:"Отбой тревоги",click:function(event,ui){var btn=event.currentTarget;var conf_btn=event.currentTarget.previousSibling;var dialog=this;$(btn).button("option",{icons:{primary:"ui-icon-gear"},
label:"Отправка отмены...",disabled:true});$.getJSON("/api/alarm/cancel?akey="+window.config.akey+"&imei="+window.config.sysbykey[skey].imei,function(data){if(data.answer&&data.answer==="ok"){$(btn).button("option",{icons:{primary:"ui-icon-zoomin"},label:"Ожидание ответа...",disabled:true});push_informer(skey,"ALARM_CANCEL",function(){log("Inform: wait-callback done.");$(btn).button("option",{icons:{primary:"ui-icon-flag"},label:"Тревога отменена!",disabled:true});$(conf_btn).button("option",{disabled:true});
remove_alert_icon(skey);delete window.config.alarm[skey];$(dialog).dialog("destroy");$("#alarmdlg_"+skey).remove()})}})}},{text:"Центровать на большой карте",click:function(){$(this).dialog("close");if($("#tabs").tabs("option","selected")!=0){$("#tabs").bind("tabsshow",function(event,ui){log("binded tab show");config.map.panTo(data.position);config.map.setZoom(15);$("#tabs").unbind(event)});$("#tabs").tabs("select",0)}else{config.map.panTo(data.position);config.map.setZoom(15)}}}],open:function(event,
ui){var btns=$(this).parent().find("button");if(window.config.alarm[skey].confirmed){log("find key:",this,$(this)[0],$(this).parent().find("button"));$(btns[0]).button("option",{disabled:true});$(btns[1]).button("option",{disabled:false})}else $(btns[1]).button("option",{disabled:true});var position=$(this).dialog("option","position");position.offset=""+alertcnt*16+" "+alertcnt*16;$(this).dialog("option","position",position);$(this).parent().css("border","3px solid red");$(this).parent().children().first().children().first().effect("pulsate")},
close:function(event,ui){alertcnt--;if(alertcnt<0)alertcnt=0}})}var sp="";var title="Тревога в:";if(data.dthistory.length>0)for(var i in data.dthistory){title+="\r\n"+dt_to_datetime(data.dthistory[i]);sp+="+"}data.datetime.innerHTML="Время: <b>"+dt_to_datetime(data.dt)+'</b><span style="cursor: pointer;" title="'+title+'">'+sp+"</span>";if(data.position.lat()==0&&data.position.lng()==0){data.addres.innerHTML="Положение объекта неизвестно. Отсутствует сигнал GPS.  "+'<span style="display:inline-block;border:1px solid black;cursor:pointer;border-radius:4px;" spid="2" title="Определить по вышкам сотовой связи (приблизительно)">GSM</span>';
$(data.addres).find('span[spid="1"]').click(function(){log("Show last")});$(data.addres).find('span[spid="2"]').click(function(){log("Show GPRS",data.ceng);$.getJSON("/api/gmap/ceng?akey="+window.config.akey+"&ceng="+data.ceng,function(rdata){if(rdata.answer&&rdata.answer==="ok"){data.position=new google.maps.LatLng(rdata.loc[0],rdata.loc[1]);data.addres.innerHTML="Положение объекта по вышкам GSM: "+rdata.loc;data.map.panTo(data.position);if(geocoder)geocoder.geocode({"latLng":data.position},function(results,
status){if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);data.addres.innerHTML="Адрес: <b>"+address+"</b>";data.addres.title="Нажмите чтобы центровать на миникарте.";data.addres.style.cursor="pointer";$(data.addres).bind("click",function(event){data.map.panTo(data.position)})}else;})}})})}else if(geocoder)geocoder.geocode({"latLng":data.position},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);data.addres.innerHTML=
"Адрес: <b>"+address+"</b>";data.addres.title="Нажмите чтобы центровать на миникарте.";data.addres.style.cursor="pointer";$(data.addres).bind("click",function(event){data.map.panTo(data.position)})}else;})};var add_alert_icon=function(skey){var ttle="Тревога "+dt_to_datetime(window.config.alarm[skey].dt);if(window.config.alarm[skey].confirmed)ttle+="\r\nТревога подтверждена оператором "+window.config.alarm[skey].confirmby;if($('div#alert_container>span[skey="'+skey+'"]').length>0)$('div#alert_container>span[skey="'+
skey+'"]').remove();$("div#alert_container").append('<span skey="'+skey+'" title="'+ttle+'">!</span>');$('div#alert_container>span[skey="'+skey+'"]').click(function(){show_alarm_window(skey,false)}).mouseenter(function(ev){var msg="Система:<b>"+window.config.sysbykey[skey].desc+"</b><br/>"+"Время:<b>"+dt_to_datetime(window.config.alarm[skey].dt)+"</b><br/>";if(window.config.alarm[skey].confirmed)msg+="Тревога подтверждена оператором:<b>"+window.config.alarm[skey].confirmby+"</b><br />"+dt_to_datetime(window.config.alarm[skey].confirmwhen)+
"<br/>";$(map).append('<div id="alarm_popup">'+msg+"</div>")}).mouseleave(function(){$("#alarm_popup").remove()}).mousemove(function(ev){$("#alarm_popup").css("left",ev.clientX-$("#alarm_popup").width()/2+"px")})};var show_alert_icons=function(){$.getJSON("/api/alarm/get?akey="+window.config.akey,function(data){if(data.answer&&data.answer==="ok"){log("alarms:",data);for(var i in data.alarms){var d=data.alarms[i];window.config.alarm[d.skey]=window.config.alarm[d.skey]||{};$.extend(window.config.alarm[d.skey],
d);add_alert_icon(d.skey)}}})};window.config.alarm.show_alert_icons=show_alert_icons;config.updater.add("addlog",function(msg){log("BASE: Alert message",msg);if(msg.data["mtype"]!="alarm")return;window.config.alarm[msg.data.skey]=window.config.alarm[msg.data.skey]||{};$.extend(window.config.alarm[msg.data.skey],msg.data.data);window.config.alarm[msg.data.skey].lpos=[msg.data.data.lat,msg.data.data.lon];add_alert_icon(msg.data.skey);show_alarm_window(msg.data.skey,true)})})(jQuery);(function(window,$){var document=window.document;var sendGet=function(url){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.send()};var sendPost=function(url,body){var xhr=new XMLHttpRequest;xhr.open("POST",url,true);xhr.send(body)};var saveconfig=function(it,val){$("#button_config_restart").button("option","disabled",true);if(val)config.ui[it]=val;$.ajax({url:"/api/system/config?akey="+config.akey,dataType:"json",data:config.ui,type:"POST",success:function(){$("#button_config_restart").button("option",
"disabled",false)}})};var ConfigList=new SysList;var UpdateSysList=function(){};if(0)var UpdateSysList=function(){$.getJSON("/api/info?akey="+config.akey,function(data){if(data){$("#config_sys_list").empty();for(var i in data.info.account.systems){var s=data.info.account.systems[i];$("#config_sys_list").append('<li class="ui-widget ui-widget-content ui-widget-header" imei="'+s.imei+'"><span class="ui-icon ui-icon-arrowthick-2-n-s mm msp"></span>'+'<span class="bico hl mm" title="Выбрать пиктограмму">P</span>'+
(config.admin?'<span class="bpurge hl mm" title="Удалить GPS данные!">D</span>':"")+'<span class="bconf hl mm" title="Настроить систему">C</span>'+'<span class="spanbrd" title="IMEI">'+s.imei+'</span><span class="spanbrd" title="Телефон">'+(s.phone!="None"?s.phone:"не определен")+"</span> <desc>"+s.desc+"</desc>"+'<button class="key bdesc" title="Изменить описание">...</button>'+'<button class="key bzone" title="Привязать ГЕО-зону">З</button>'+(config.admin?'<button class="key calarm" title ="Принудительная отмена тревоги">x!</button>':
"")+'<button class="key bdel" title="Отказаться от слежения за системой">X</button>'+"</li>")}$("#config_sys_list .calarm").button().click(function(){var par=$(this).parent();var imei=par.attr("imei");log("imei",imei);$.getJSON("/api/alarm/cancel?akey="+window.config.akey+"&imei="+imei,function(data){})});$("#config_sys_list .bdesc").button().click(function(){var par=$(this).parent();var imei=par.attr("imei");var desc=par.find("desc").html();var dialog=$("#config_dialog_sys_desc");dialog.find("label").html(imei);
dialog.find("textarea").val(desc);dialog.dialog("open")});$("#config_sys_list .bzone").button().click(function(){var par=$(this).parent();var imei=par.attr("imei");$("#config_zone_link_imei").html(imei);var desc=par.find("desc").html();$("#config_zone_link_desc").html(desc);var dialog=$("#config_zone_link");dialog.dialog("open")});$("#config_sys_list .bconf").button().click(function(){var par=$(this).parent();var imei=par.attr("imei");var desc=par.find("desc").html();log("TBD! config",i);if($("#config_params").length===
0)var div=$("body").append('<div id="config_params">'+'<div id="config_params_body">Загрузка данных с сервера...</div>'+"</div>");else $("#config_params_body").html("Загрузка данных с сервера...");$.getJSON("/api/sys/config?cmd=get&imei="+imei,function(data){if(data.answer=="ok")if(data.config.length===0)$("#config_params_body").empty().html("Нет параметров. Возможно система еще не сохранила параметры.<br/>Можно послать SMS на номер системы с текстом <strong>saveconfig</strong> для принудительного сохранения параметров.");
else{var rows='<table class="tview"><thead><tr><th>№</th><th>Имя</th><th>Описание<span id="config_params_show_all" title="Показать все" class="cursor_pointer">...</span></th><th>Значение</th><th>Заводская установка</th><th>Очередь</th></tr></thead><tbody>';var index=1;for(var i in data.config){var v=data.config[i];rows+='<tr name="'+v[0]+'"'+(v[1].desc?"":' class="config_hide"')+">";rows+="<td>"+index+"</td>";rows+="<td>"+v[0]+"</td>";if(config.admin)rows+='<td class="cfg_changeble">'+(v[1].desc||
"-")+"</td>";else rows+="<td>"+(v[1].desc||"-")+"</td>";rows+='<td class="cfg_changeble'+(v[1].wait?" wait":"")+'">'+v[1].value+"</td>";rows+="<td>"+v[1]["default"]+"</td><td>"+(v[1].wait?v[1].wait:"")+"</td></tr>";index+=1}rows+="</tbody></table>";$("#config_params_body").empty().append(rows);$("#config_params").dialog("option","position","center");$("#config_params_show_all").click(function(){$(".config_hide").removeClass("config_hide");$("#config_params").dialog("option","position","center")});
var tb=$("#config_params_body table tbody");tb.find("tr").find("td:first").next().next().click(function(){if(config.admin){var name=$(this).parent().attr("name");var pvalue=$(this).html();var nvalue=prompt("Введите описание для '"+name+"'",pvalue);if(nvalue&&nvalue!=pvalue){$(this).html(nvalue);sendGet("/api/param/desc?name="+name+"&value="+nvalue)}}}).next().click(function(){var name=$(this).parent().attr("name");var pvalue=$(this).html();var nvalue=prompt("Введите значение для '"+name+"'",pvalue);
if(nvalue&&nvalue!=pvalue){$(this).next().next().html(nvalue);$(this).addClass("wait");sendGet("/api/sys/config?cmd=set&imei="+imei+"&name="+name+"&value="+nvalue)}})}});$("div#config_params_body").css("max-height",$(window).height()-200);$("#config_params").dialog({width:"90%",modal:true,autoOpen:true,title:desc,buttons:{"Отменить задание на изменение параметров":function(){sendGet("/api/sys/config?cmd=cancel&imei="+imei);$(this).dialog("close")},"Закрыть":function(){$(this).dialog("close")}}})});
if(config.admin)$("#config_sys_list .bpurge").button().css("color","red").click(function(){var imei=$(this).parent().attr("imei");if($("#config_purgegps").length===0){$("body").append('<div id="config_purgegps">'+"Удаление GPS данных для системы<br/><strong><label></label></strong><br/><br/>"+'<span style="color: red">Внимание!</span> Данные старее выбранной даты будут удалены.'+'<input type="text" id="config_purgegps_alternate" disabled=sidabled size="30"/>'+'<div id="config_purgegps"></div>'+"</div>");
var div=$("#config_purgegps");$("#config_purgegps").datepicker({altField:"#config_purgegps_alternate",altFormat:"dd.mm.yy DD"})}$("#config_purgegps label").first().html(imei+":"+$(this).parent().children("desc").html());$("#config_purgegps").dialog({autoOpen:true,title:"Удаление GPS данных",modal:true,minHeight:390,buttons:{"Отмена":function(){$(this).dialog("close")},"Выполнить!":function(){var dateto=$.datepicker.formatDate("ymmdd000000",$("#config_purgegps").datepicker("getDate"));$.getJSON("/api/geo/del?imei="+
imei+"&to="+dateto,function(data){if(data.answer=="ok")alert("Удаление данных поставлено в очередь. Это может потребовать некоторого времени.");else alert("Ошибка:\r\n"+data.result)});$(this).dialog("close")}}})});$("#config_sys_list .bico").button().click(function(){alert("В разработке")});$("#config_sys_list .bdel").button().click(function(){$("#config_del_imei").html($(this).parent().attr("imei"));$("#config_del_desc").html($(this).parent().find("desc").html());$("#config_dialog_delsys").dialog("open")})}})};
$(document).ready(function(){UpdateSysList();$("#config_button_sys_add").click(function(){$("#config_dialog_addsys").dialog("open")});$("textarea").keypress(function(ev){if(ev.which==13){$(this).parents('div[role="dialog"]').find("button").first().click();return false}return true});$("#config_dialog_addsys").dialog({width:400,height:200,modal:true,autoOpen:false,buttons:{"Добавить систему.":function(){var imei=$("#config_dialog_addsys #config_addsys_imei").val();$.getJSON("/api/sys/add?akey="+config.akey+
"&imei="+imei,function(data){if(data.result){var result=data.result;if(result=="not found")$("#dialog_addsys_not_found").dialog("open");else if(result=="already")$("#dialog_addsys_already").dialog("open");else if(result=="added")UpdateSysList()}});$(this).dialog("close")},"Отменить":function(){$(this).dialog("close")}}});$("#config_dialog_sys_desc").dialog({width:500,height:150,modal:true,autoOpen:false,buttons:{"Применить изменения.":function(){var dialog=$(this);var imei=dialog.find("label").html();
var desc=dialog.find("textarea").val();$.getJSON("/api/sys/desc?akey="+config.akey+"&imei="+imei+"&desc="+desc,function(data){if(data.result){var result=data.result;if(result=="disabled");else if(result=="ok")$("#config_sys_list").find('li[imei="'+imei+'"]>desc').html(desc)}});$(this).dialog("close")},"Отменить":function(){$(this).dialog("close")}}});var add_zone_rule=function(){var tbody=$("#config_zone_link table tbody");var select_zone='<select name="config_select_zone_list" style="width:100%;" title="Выберите зону" onchange="/*UpdateGroupList();*/">'+
'\t<option value="zz0">Зона 1</option>'+'\t<option value="zz1">Зона 2</option>'+'\t<option value="zz2">Зона 3</option>'+"</select>";var select_event='<select name="config_select_event_list" style="width:100%;" title="Группа" onchange="/*UpdateGroupList();*/">'+'\t<option value="0" title="Cообщение будет отражено в отчетах и в событиях">"Тихое" оповещение при покидании зоны</option>'+'\t<option value="1" title="Cообщение будет выведено на экран всем пользователям, наблюдающим за системой">"Cрочное" оповещение при покидании зоны</option>'+
'\t<option value="2">"Тихое" оповещение о вхождении в зону</option>'+'\t<option value="3">"Срочное" оповещение о вхождении в зону</option>'+'\t<option value="4">Начало трека при покидании зоны</option>'+'\t<option value="5">Конец трека при вхождении в зону</option>'+'\t<option value="6">Событие 6</option>'+'\t<option value="7">Событие 7</option>'+'\t<option value="8">Событие 8</option>'+'\t<option value="9">Событие 9</option>'+'\t<option value="10">Событие 10</option>'+"</select>";tbody.append("<tr><td>"+
select_zone+"</td><td>"+select_event+'</td><td>00:00:00</td><td>23:59:59</td><td>норма</td><td><button class="key">.</button></td></tr>');$("#config_zone_link table tbody tr:last td:last button").button({text:false,icons:{primary:"ui-icon-close"}}).click(function(){$(this).parent().parent().remove()})};window["config_delete_zone_rule"]=function(){};$("#config_zone_link_add_rule").click(function(){add_zone_rule()});$("#config_zone_link").dialog({width:800,height:650,modal:true,autoOpen:false,open:function(event,
ui){$(this).dialog("option","position","center")},buttons:{"Закрыть":function(){$(this).dialog("close")}}});$("#dialog_addsys_not_found").dialog({modal:true,autoOpen:false,buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog_addsys_already").dialog({modal:true,autoOpen:false,buttons:{Ok:function(){$(this).dialog("close")}}});$("#popup-sys").dialog({modal:true,autoOpen:false});$("#popup-sys li").button();$("#config_dialog_delsys").dialog({modal:true,autoOpen:false,buttons:{"Нет":function(){$(this).dialog("close")},
"Да, отказаться от слежения":function(){var imei=$("#config_del_imei").html();$.getJSON("/api/sys/del?akey="+config.akey+"&imei="+imei,function(data){UpdateSysList()});$(this).dialog("close")}}});$("#config_list").accordion({fillSpace:true,collapsible:true});$("#config_sys_list").sortable({handle:".msp",revert:true,scrollSpeed:5,stop:function(event,ui){var imei=ui.item.attr("imei");var index=ui.item.index();$.getJSON("/api/sys/sort?akey="+config.akey+"&imei="+imei+"&index="+index,function(data){if(data.result)log("Set new position for "+
imei+" to "+index)})}});$('#config_list select#config_set_theme option[value="'+config.ui.theme+'"]').attr("selected","selected");$("#config_list #config_set_theme").bind("change",function(){var themename=$(this).attr("value");saveconfig("theme",themename);var hl=$("head #themecss");hl.attr("href","/plugins/jquery-ui-themes-1.8.9/jquery-ui-themes-1.8.9/themes/"+themename+"/jquery.ui.all.css")});config.ui.trackcolor=config.ui.trackcolor||"#dc00dc";$("#colorpickerHolder div").css("backgroundColor",
config.ui.trackcolor);$("#colorpickerHolder").ColorPicker({color:config.ui.trackcolor,onShow:function(colpkr){$(colpkr).fadeIn(100);return false},onHide:function(colpkr){$(colpkr).fadeOut(100);saveconfig("trackcolor",null);return false},onChange:function(hsb,hex,rgb){config.ui.trackcolor="#"+hex;$("#colorpickerHolder div").css("backgroundColor",config.ui.trackcolor)}});$("#button_config_restart").click(function(){window.location.href=window.location.href});if(config.admin){$("button.dbg_send_msg").click(function(){var imei=
$(this).attr("imei");var text=$(this).attr("value");sendGet("/addlog?imei="+imei+"&text="+text)});$("button.dbg_send_cfg").click(function(){var imei=$(this).attr("imei");var text="";for(var i=0;i<100;i++)text+="dbg.name."+i+" INT "+i*10+" 10\n";sendPost("/config?cmd=save&imei="+imei,text)})}$(".cfg_iframe").click(function(){if($(this).find("div").length==0)$(this).append('<div><iframe src="'+$(this).attr("value")+'" style="width:100%; height: 70%;">'+'Ваш браузер не поддерживает iframe. Сожалеем, но единственным выходом является использование другого браузера. Мы рекомендуем <a href="http://www.google.com/chrome?hl=ru">Google Chrome.</a>'+
"</iframe></div>");else $(this).find("div").remove()});$(window).resize(function(){if(config.tab==4)$("#config_list").accordion("resize")});setTimeout(function(){$("#config_list").accordion("resize")},1E3);config.updater.tabs[4]=function(){$("#config_list").accordion("resize")}})})(this,jQuery);(function(){$(document).ready(function(){var $gmap=null;var gmap=null;var gmarker;var $p=$("#geos_body table tr:first th:last")[0];var tbody=$("#geos_body table tbody");var skey;var fsource={"0":"-",1:"SUDDENSTOP",2:"STOPACC",3:"TIMESTOPACC",4:"SLOW",5:"TIMEMOVE",6:"START",7:"TIMESTOP",8:"ANGLE",9:"DELTALAT",10:"DELTALONG",11:"DELTA"};var td=function(value){var res="";$.each(value,function(i,v){res+="<td>"+v+"</td>"});return res};var genReport=function(){log("GEOS: Update report");skey=$("#geos_syslist").val();
var type=$("#geos_type_last").attr("checked");var date;if(type)date=new Date;else{date=$("#geos_datepicker").datepicker("getDate");if(!date)return;log("date",date)}$.getJSON("/api/geo/report",{skey:skey,from:Date_to_url(Date_to_daystart(date)),to:Date_to_url(Date_to_daystop(date))},function(data){if(data.answer&&data.answer=="ok"){var vdata={vout:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0},vin:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0},speed:{data:new google.visualization.DataTable,
vmin:1E3,vmax:-1E3,vsum:0},sats:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0}};vdata.vout.data.addColumn("string","x");vdata.vin.data.addColumn("string","x");vdata.speed.data.addColumn("string","x");vdata.sats.data.addColumn("string","x");vdata.vout.data.addColumn("number","Основное питание");vdata.vin.data.addColumn("number","Резервное питание");vdata.speed.data.addColumn("number","Скорость");vdata.sats.data.addColumn("number","Спутники");var phm="";var vcnt=0;var p;var _slice=
5,_tail="";if(data.points.length>200){_slice=4;_tail="0"}var add_data=function(name,digits){var value=parseFloat((vdata[name].vsum/vcnt).toFixed(digits));vdata[name].data.addRow([dt_to_time(p[0]).slice(0,_slice)+_tail,value]);vdata[name].vsum=0;vdata[name].vmin=Math.min(vdata[name].vmin,value);vdata[name].vmax=Math.max(vdata[name].vmax,value)};tbody.empty();for(var i in data.points){p=data.points[i];var row="<tr>";row+=td([dt_to_time(p[0]),p[1].toFixed(5),p[2].toFixed(5),p[3],p[6].toFixed(1),p[4].toFixed(1),
p[5].toFixed(2),fsource[p[7]]]);row+="</tr>";tbody.prepend(row);vdata.vout.vsum+=p[4];vdata.vin.vsum+=p[5];vdata.speed.vsum+=p[6];vdata.sats.vsum+=p[3];vcnt+=1;if(phm!=dt_to_time(p[0]).slice(0,_slice)){phm=dt_to_time(p[0]).slice(0,_slice);add_data("vout",2);add_data("vin",3);add_data("speed",2);add_data("sats",2);vcnt=0}}var draw_data=function(name,title){$("#geos_vis_"+name).empty();if(vdata[name].data.getNumberOfRows()>0){var chart=new google.visualization.LineChart(document.getElementById("geos_vis_"+
name));chart.draw(vdata[name].data,{curveType:"function",title:title,width:700,height:400,vAxis:{minValue:vdata[name].vmin,maxValue:vdata[name].vmax},chartArea:{left:40,top:20,width:650,height:330},legend:"none",hAxis:{slantedTextAngle:90}})}};draw_data("vout","Основное питание");draw_data("vin","Резервное питание");draw_data("speed","Скорость (средняя)");draw_data("sats","Спутники (усредненное значение)")}var $p=$("#geos_body table tr:first th:last")[0];$("#geomap").css("left",$p.offsetLeft+$p.offsetWidth);
$("#geos_body table tr").unbind("mouseover");$("#geos_body table tr").bind("mouseover",function(){if($(this).children()[1]&&$(this).children()[2]){var lat=parseFloat($(this).children()[1].innerHTML);var lon=parseFloat($(this).children()[2].innerHTML);if(!isNaN(lat)&&!isNaN(lon)){var pos=new google.maps.LatLng(lat,lon);gmap.panTo(pos);gmarker.setPosition(pos)}}})})};$("span.showchart").click(function(){var name=$(this).attr("value");log("showchart",name);$(".geos_vis").hide();$("#geos_vis_"+name).show();
$("#geos_previev").show("fast")});config.updater.add("geo_change",function(msg){log("GEOS: geo_change: ",msg.data);if(skey==msg.data.skey)if($("#geos_type_last").attr("checked"))genReport()});config.syslist({id:"geos_syslist",change:function(){genReport()}});genReport();$("#geos_viewtype").buttonset({}).change(function(){genReport()});$("#geos_datepicker").datepicker()})})();(function(window,$,undefined){var document=window.document;if(!("zones"in window.config))window.config["zones"]={};var zones=window.config["zones"];var update_zone_list=function(){$("#map_zones_list").empty();for(var i in zones){var zone=zones[i];if(zone.type=="poligon")$("#map_zones_list").append('<li zkey="'+i+'"> Полигон, вершин: '+zone.poligon.getPath().length+'<span title="Удалить зону." style="display: inline-block;float:right;" class="ui-icon ui-icon-close" foo="del"></li>')}$("#map_zones_list li").click(function(ev){var zkey=
$(this).attr("zkey");var zone=zones[zkey];if(zone.type=="poligon"){var bounds=new google.maps.LatLngBounds;var path=zone.poligon.getPath();log("path",path);for(var i=0;i<path.length;i++)bounds.extend(path.getAt(i));log("Show bounds",bounds);window.config.map.fitBounds(bounds)}}).mouseover(function(ev){var zkey=$(this).attr("zkey");var zone=zones[zkey];if(zone.type=="poligon")zone.poligon.setOptions({strokeWeight:4})}).mouseout(function(ev){var zkey=$(this).attr("zkey");var zone=zones[zkey];if(zone.type==
"poligon")zone.poligon.setOptions({strokeWeight:1})});$("#map_zones_list li span[foo=del]").click(function(ev){var zkey=$(this).parent().attr("zkey");log("Delete Geo-zone ",zkey);$.getJSON("/api/zone/del",{zkey:zkey},function(data){log("ok deleted Geo-zone ",data);var zone=zones[zkey];if(zone.type=="poligon")zone.poligon.setMap(null);$("#map_zones_list li[zkey="+zkey+"]").remove();delete zone.poligon;zone=null;delete zones[zkey]})})};$.getJSON("/api/zone/get",function(data){if(data.answer&&data.answer==
"ok"){for(var i in zones)if(zones[i].type=="poligon"){zones[i].poligon.setMap(null);delete zones[i]}for(var i in data.zones){var zone=data.zones[i];if(zone.type=="poligon"){var path=[];for(var j in zone.points)path.push(new google.maps.LatLng(zone.points[j][0],zone.points[j][1]));var poligon=new google.maps.Polygon({path:path,clickable:false,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.35});poligon["zkey"]=zone.zkey;zones[zone.zkey]={"type":"poligon","poligon":poligon}}}update_zone_list()}});
function ZoneKit(){}var zone_showed=false;ZoneKit.prototype.Show=function(){if(!zone_showed){zone_showed=true;$("#map_zone_show>span").css("background-color","lime");for(var i in zones)if(zones[i].type=="poligon")zones[i].poligon.setMap(window.config.map)}else{zone_showed=false;$("#map_zone_show>span").css("background-color","");for(var i in zones)if(zones[i].type=="poligon")zones[i].poligon.setMap(null)}};var track_edit_mode=false;ZoneKit.prototype.AddPoligon=function(){var poligon;var events={};
var start_add_zone=function(){track_edit_mode=true;$("#map_zone_add>span").css("background-color","lime");message("Создавайте зону указывая на карте последовательность вершин многоугольника левой клавишей мыши. Завершение создания зоны - правая клавиша мыши.")};var stop_add_zone=function(){track_edit_mode=false;$("#map_zone_add>span").css("background-color","");google.maps.event.removeListener(events.click);google.maps.event.removeListener(events.move);var vertices=poligon.getPath();vertices.pop();
var points=[];for(var i=0;i<vertices.length;i++){var p=vertices.getAt(i);points.push([p.lat(),p.lng()])}$.ajax({url:"/api/zone/add?akey="+window.config.akey,dataType:"json",data:{type:"poligon",points:JSON.stringify(points)},type:"post",success:function(data){if(data&&data.answer=="ok"){poligon["zkey"]=data.zkey;if(!("zones"in config))config["zones"]={};zones[data.zkey]={type:"poligon",poligon:poligon};update_zone_list()}}})};if(!track_edit_mode){start_add_zone();var init_path=[];poligon=new google.maps.Polygon({clickable:false,
strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.35,map:window.config.map});log("self",self);events.click=google.maps.event.addListener(window.config.map,"click",function(event){var vertices=poligon.getPath();vertices.push(event.latLng);if(vertices.length==1)vertices.push(event.latLng)});events.move=google.maps.event.addListener(window.config.map,"mousemove",function(event){var vertices=poligon.getPath();if(vertices.length>1)vertices.setAt(vertices.length-1,
event.latLng)});google.maps.event.addListenerOnce(window.config.map,"rightclick",stop_add_zone)}else stop_add_zone()};var zones_activate=function(){for(var i in zones){var zone=zones[i];if(zone.type=="poligon"){zone.poligon.setOptions({clickable:true});var eventsclick=google.maps.event.addListener(zone.poligon,"mouseover",function(event){if("zkey"in this)$("#map_zones_list li[zkey="+this.zkey+"]").addClass("highlight");this.setOptions({strokeWeight:4})});var eventsleave=google.maps.event.addListener(zone.poligon,
"mouseout",function(event){if("zkey"in this)$("#map_zones_list li[zkey="+this.zkey+"]").removeClass("highlight");this.setOptions({strokeWeight:1})})}}};var zones_deactivate=function(){for(var i in zones){var zone=zones[i];if(zone.type=="poligon")zone.poligon.setOptions({clickable:false,strokeWeight:1})}};ZoneKit.prototype.Edit=function(){if($("#zone_panel").css("display")=="none"){$("#map_zone_edit>span").css("background-color","lime");$("#zone_panel").show("fast");zones_activate()}else{$("#map_zone_edit>span").css("background-color",
"");$("#zone_panel").hide("fast");zones_deactivate()}};window["ZoneKit"]=ZoneKit})(window,jQuery);(function(window,$,undefined){var document=window.document;var directionsDisplay=null;var directionsService=new google.maps.DirectionsService;var map;var oldDirections=[];var currentDirections=null;var initRoute=function(){directionsDisplay=new google.maps.DirectionsRenderer({"map":window.config.map,"preserveViewport":true,"draggable":true});directionsDisplay.setPanel(document.getElementById("directions_panel"));google.maps.event.addListener(directionsDisplay,"directions_changed",function(){if(currentDirections){oldDirections.push(currentDirections);
setUndoDisabled(false)}currentDirections=directionsDisplay.getDirections()});setUndoDisabled(true)};var calcRoute=function(start,end){var request={origin:start,destination:end,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.METRIC,region:"de"};directionsService.route(request,function(response,status){if(status==google.maps.DirectionsStatus.OK)directionsDisplay.setDirections(response)})};var undo=function(){currentDirections=null;directionsDisplay.setDirections(oldDirections.pop());
if(!oldDirections.length)setUndoDisabled(true)};var setUndoDisabled=function(value){document.getElementById("dir_panel_undo").disabled=value};function DirKit(){$("#dir_panel_undo").click(undo)}var track_mode=false;var events={fclick:null,sclick:null};DirKit.prototype.Route=function(){var start_marker=null;if(!track_mode){track_mode=true;message("Укажите начальную точку трека.");$("#map_track_calc>span").css("background-color","lime");events.fclick=google.maps.event.addListenerOnce(window.config.map,
"click",function(event){var start=event.latLng;start_marker=new google.maps.Marker({position:start,map:window.config.map,title:"",icon:$.gmap.images["start"],draggable:true});message("Укажите конечную точку трека.");events.sclick=google.maps.event.addListenerOnce(window.config.map,"click",function(event){var end=event.latLng;start_marker.setMap(null);start_marker=null;if(!directionsDisplay)initRoute();calcRoute(start,end);$("#dir_panel").show("fast")})})}else{track_mode=false;$("#dir_panel").hide("fast");
google.maps.event.removeListener(events.fclick);if(events.sclick!=null)google.maps.event.removeListener(events.sclick);if(start_marker){start_marker.setMap(null);start_marker=null}$("#map_track_calc>span").css("background-color","")}};window["DirKit"]=DirKit})(window,jQuery);(function(){var map=null;var show_bounds=false;var geocoder;var ruler1=null;var skey=null;var prev_minp=-1;var flightPlanCoordinates=[];var showed_path=[];var flightPath=null;var flightPathBounds=null;var stop_markers=[];var PROFILE=false;function Profile(name){if(!PROFILE)return;this.name=name;this.start=new Date;log("Profile: "+name+" start ")}Profile.prototype.show=function(){if(!PROFILE)return;var end=new Date;var time=end.getTime()-this.start.getTime();log("Profile: "+this.name+" - "+time+" ms")};
var main_bound_rectangle=null;var sub_bounds=[];var sub_bound_rectangles=[];var sub_bound_indexes=[];var search_bound_rectangle=null;var GetPath=function(skey_,from,to){skey=skey_;ruler1.setSysKey(skey);$.getJSON("/api/geo/get?skey="+skey+"&from="+from+"&to="+to,function(data){if(data.answer&&data.points.length>0)ParcePath(data)})};var dt_to_Date=function(d){return new Date(Date.UTC(parseInt("20"+d[0]+d[1],10),parseInt(d[2]+d[3],10)-1,parseInt(d[4]+d[5],10),parseInt(d[6]+d[7],10),parseInt(d[8]+d[9],
10),parseInt(d[10]+d[11],10)))};var stop_infowindow;var marker_start=null;var marker_finish=null;var ParcePath=function(data){var profile=new Profile("GetPath");profile.show();flightPlanCoordinates=[];for(var i in data.points){var l=new google.maps.LatLng(data.points[i][1],data.points[i][2],false);l.date=data.points[i][0];l.angle=data.points[i][3];l.zoom=data.points[i][4];flightPlanCoordinates.push(l)}flightPathBounds=new google.maps.LatLngBounds(new google.maps.LatLng(data.bounds.sw[0],data.bounds.sw[1]),
new google.maps.LatLng(data.bounds.ne[0],data.bounds.ne[1]));map.fitBounds(flightPathBounds);profile.show();sub_bounds=[];sub_bound_indexes=[];for(var i in data.subbounds){sub_bounds.push(new google.maps.LatLngBounds(new google.maps.LatLng(data.subbounds[i].sw[0],data.subbounds[i].sw[1]),new google.maps.LatLng(data.subbounds[i].ne[0],data.subbounds[i].ne[1])));sub_bound_indexes.push(data.subbounds[i].i)}if(show_bounds){for(var i in sub_bounds)if(sub_bound_rectangles.length<=i)sub_bound_rectangles.push(new google.maps.Rectangle({bounds:sub_bounds[i],
map:map,clickable:false,fillColor:"#00FF00",fillOpacity:0.1,strokeColor:"#00FF00",strokeOpacity:1,strokeWeight:1}));else sub_bound_rectangles[i].setBounds(sub_bounds[i]);if(sub_bound_rectangles.length>sub_bounds.length)for(var i=sub_bounds.length;i<sub_bound_rectangles.length;i++)sub_bound_rectangles[i].setBounds(null)}profile.show();for(var i in stop_markers)stop_markers[i].setMap(null);stop_markers=[];for(var i in data.stops){var dstop=dt_to_Date(data.points[data.stops[i].i][0]);var dstart=dt_to_Date(data.points[data.stops[i].s][0]);
var dt=(dstart-dstop)/1E3;var tp="";var icon;if(dt>5*60){tp="стоянка ";icon=$.gmap.images["stop"]}else{tp="остановка ";icon=$.gmap.images["halt"]}var marker=new google.maps.Marker({position:new google.maps.LatLng(data.stops[i].p[0],data.stops[i].p[1]),map:map,title:tp+td_to_hms(dt)+"\n"+dt_to_datetime(data.points[data.stops[i].i][0])+"..."+dt_to_datetime(data.points[data.stops[i].s][0]),icon:icon,draggable:false});google.maps.event.addListener(marker,"click",function(moev){if(1){var position=this.position;
geocoder.geocode({"latLng":this.position},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);if(stop_infowindow)stop_infowindow.close();stop_infowindow=new google.maps.InfoWindow({content:address,position:position});stop_infowindow.open(map)}else alert("Geocoder failed due to: "+status)})}});stop_markers.push(marker)}if(data.points.length>0){if(marker_start)marker_start.setMap(null);if(marker_finish)marker_finish.setMap(null);marker_start=new google.maps.Marker({position:new google.maps.LatLng(data.points[0][1],
data.points[0][2]),map:map,title:"Начало трека: "+dt_to_datetime(data.points[0][0]),icon:$.gmap.images["begin"],draggable:false});if($("#datepicker").datepicker("getDate").toDateString()!=(new Date).toDateString())marker_finish=new google.maps.Marker({position:new google.maps.LatLng(data.points[data.points.length-1][1],data.points[data.points.length-1][2]),map:map,title:"Конец трека: "+dt_to_datetime(data.points[data.points.length-1][0]),icon:$.gmap.images["end"],draggable:false})}profile.show();
DrawPlyline();PathRebuild()};var once=true;var PathRebuild=function(){var profile=new Profile("PathRebuild");var mapzoom=map.getZoom();showed_path=[];for(var i=0;i<flightPlanCoordinates.length;i++){var p=flightPlanCoordinates[i];if(p.zoom<=mapzoom)showed_path.push(p)}profile.show();if(flightPath)flightPath.setPath(showed_path);profile.show();if(config.admin)$("#mark1").html("Точек в треке: "+showed_path.length+"/"+flightPlanCoordinates.length);else $("#mark1").html("Точек в треке: "+flightPlanCoordinates.length)};
var UpdateMarker=function(moev){var start=new Date;if(showed_path.length==0)return;var mapzoom=map.getZoom();var size=0.0030*Math.pow(2,13-mapzoom);if(size<1.0E-4)size=1.0E-4;var clat=Math.cos(moev.latLng.lat()*Math.PI/180);if(clat<1.0E-4)clat=1.0E-4;var bound=new google.maps.LatLngBounds(new google.maps.LatLng(moev.latLng.lat()-size*clat,moev.latLng.lng()-size),new google.maps.LatLng(moev.latLng.lat()+size*clat,moev.latLng.lng()+size));if(show_bounds)if(!search_bound_rectangle)search_bound_rectangle=
new google.maps.Rectangle({bounds:bound,map:map,fillColor:"#00FFFF",fillOpacity:0.1,strokeColor:"#00FFFF",strokeOpacity:1,strokeWeight:1});else search_bound_rectangle.setBounds(bound);var total_points=0;var mind=1E9;var minp=0;if(sub_bound_indexes.length!=0)for(var i in sub_bounds)if(bound.intersects(sub_bounds[i])){if(show_bounds)sub_bound_rectangles[i].setOptions({strokeWeight:3,fillOpacity:0.3});total_points+=sub_bound_indexes[i].length;for(var j in sub_bound_indexes[i]){var p=flightPlanCoordinates[sub_bound_indexes[i][j]];
if(bound.contains(p)){var d=distance(moev.latLng,p);if(d<mind){mind=d;minp=sub_bound_indexes[i][j]}}}}else if(show_bounds)sub_bound_rectangles[i].setOptions({strokeWeight:1,fillOpacity:0.1});if(minp!=prev_minp){ruler1.setPosition(flightPlanCoordinates[minp]);prev_minp=minp;ruler1.HideInfo()}var end=new Date;var time=end.getTime()-start.getTime();if(config.admin)$("#mark2").html("in s/bounds: "+total_points+" time: "+time)};var once_map_style=true;var CreateMap=function(){geocoder=new google.maps.Geocoder;
var $map=$("#map").gmap({pos:new google.maps.LatLng(35.5,48.5),zoom:10,markertitme:"aaa"});map=$($map).gmap("option","map");config.map=map;google.maps.event.addListener(map,"zoom_changed",function(){PathRebuild()});google.maps.event.addListener(map,"mousemove",UpdateMarker);log("create MyMarker");ruler1=new MyMarker(map)};var lastpos={};var CreateLastMarker=function(p){if(p.data==null)return;var pos=new google.maps.LatLng(p.data.point.lat,p.data.point.lon);var tail_path=[];for(var j in p.data.tail)tail_path.push(new google.maps.LatLng(p.data.tail[j][1],
p.data.tail[j][2]));if(lastpos[p.skey]){lastpos[p.skey].position=pos;lastpos[p.skey].marker.setPosition(p.data.point,pos);if(0)lastpos[p.skey].tail.setPath(tail_path)}else{if(0){var tailPath=new google.maps.Polyline({path:tail_path,strokeColor:config.ui.trackcolor||"#dc00dc",strokeOpacity:1,strokeWeight:3});tailPath.setMap(map)}var last_pos_marker=new LastMarker({point:p.data.point,position:pos,map:map,desc:p.desc,skey:p.skey});lastpos[p.skey]={position:pos,marker:last_pos_marker}}};var GetLastPositions=
function(akey){$.getJSON("/api/geo/last?akey="+akey,function(data){if(data.answer&&data.answer=="ok")for(var i in data.geo)CreateLastMarker(data.geo[i])});config.updater.add("geo_change",function(msg){var skey=msg.data.skey;$.getJSON("/api/geo/last?akey="+akey+"&skey="+skey,function(data){CreateLastMarker(data.geo[0])})})};var distance=function(p1,p2){var R=6371;var dLat=(p2.lat()-p1.lat())*Math.PI/180;var dLon=(p2.lng()-p1.lng())*Math.PI/180;var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(p1.lat()*
Math.PI/180)*Math.cos(p2.lat()*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d};var DrawPlyline=function(){if(flightPath)return;flightPath=new google.maps.Polyline({strokeColor:config.ui.trackcolor||"#dc00dc",strokeOpacity:1,strokeWeight:3});flightPath.setMap(map);if(0){google.maps.event.addListener(flightPath,"click",function(moev){});google.maps.event.addListener(flightPath,"mouseover",function(moev){});google.maps.event.addListener(flightPath,
"mouseout",function(moev){})}};var ClearPath=function(skey){var profile=new Profile("Clear path");showed_path=[];if(flightPath)flightPath.setPath(showed_path);for(var i in stop_markers)stop_markers[i].setMap(null);stop_markers=[];profile.show()};var prev_sender=null;var SetDay=function(skey,start,stop){GetPath(skey,Date_to_url(start),Date_to_url(stop))};var dbg_data=null;var DayList=function(skey,month){$.getJSON("/api/geo/dates?skey="+skey+"&month="+month,function(data){dbg_data=data;if(data.answer){config.daylist=
config.daylist||{};config.daylist.skey=skey;config.daylist.year=data.year;config.daylist.month=data.month;config.daylist.days=data.days;$("#datepicker").datepicker("refresh")}})};var params={changedEl:"select",scrollArrows:true};var UpdateDayList=function(){var date=$("#datepicker").datepicker("getDate");if(!config.cur_month)config.cur_month=$.datepicker.formatDate("yymm",date);DayList(config.skey,config.cur_month)};$(document).ready(function(){config.cur_month=null;CreateMap();$("#date_tabs").tabs();
$("#nav_map").button("option","disabled",true);$.datepicker.setDefaults($.datepicker.regional["ru"]);$("#datepicker").datepicker({altField:"#alternate",altFormat:"yymmdd",minDate:"-12m +0w",maxDate:"+0m +0w",hideIfNoPrevNext:true,onSelect:function(dateText,inst){var start=$(this).datepicker("getDate");var stop=new Date(start);stop.setHours(23);stop.setMinutes(59);stop.setSeconds(59);SetDay(config.skey,start,stop)},onChangeMonthYear:function(year,month,inst){config.cur_month=""+year+(month<10?"0"+
month:month);UpdateDayList()},beforeShowDay:function(date){if(!config.daylist||config.daylist.year!=date.getFullYear()||config.daylist.month!=date.getMonth()+1)return[false,"","Загрузка информации с сервера..."];var da=date.getDate();if(config.daylist.days.indexOf(da)!=-1)return[true];else return[false,"","В этот день система не выходила на связь"]}});$(".panel_control").click(function(){var panel=$(this).parent();if(panel.hasClass("stat-hided")){panel.removeClass("stat-hided");$(this).find("span").removeClass("ui-icon-circle-triangle-w").addClass("ui-icon-circle-triangle-e");
$("#map").removeClass("stat-hided")}else{panel.addClass("stat-hided");$(this).find("span").removeClass("ui-icon-circle-triangle-e").addClass("ui-icon-circle-triangle-w");$("#map").addClass("stat-hided")}});GetLastPositions(config.akey);UpdateDayList(config.skey)});var UpdateGroupList=function(){var group=$("#group_list").attr("value");log("Select group:"+group)};var Map_SysList=function(list){list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<li class="ui-widget ui-state-default" imei="'+
s.imei+'" skey="'+s.skey+'">'+'  <span class="ui-icon ui-icon-zoomin" title="Центровать последнее положение на карте"></span>'+s.desc+"</li>")}list.find("li").click(function(){$(this).parent().find("li").removeClass("ui-state-highlight");$(this).addClass("ui-state-highlight");config.skey=this.attributes["skey"].value;UpdateDayList();if(lastpos[config.skey])map.panTo(lastpos[config.skey].position)}).mouseover(function(){var skey=$(this).attr("skey");$(".lastmarker").removeClass("lastup");$('.lastmarker[skey="'+
skey+'"]').addClass("lastup")}).mouseout(function(){$('.lastmarker[skey="'+$(this).attr("skey")+'"]').removeClass("lastup")}).find("span").click(function(){})};$(document).ready(function(){var list=$("ul#map_ul_sys");Map_SysList(list);config.updater.add("changedesc",function(msg){$(list).find('li[skey="'+msg.data.skey+'"]').html('  <span class="ui-icon ui-icon-zoomin" title="Центровать последнее положение на карте"></span>'+msg.data.desc).find("span").click(function(){var skey=$(this).parent().attr("skey");
map.panTo(lastpos[skey].position)})});config.updater.add("changeslist",function(msg){Map_SysList(list)});config.updater.tabs[0]=function(){google.maps.event.trigger(map,"resize")};$("#map_btn_cleartrack").click(function(){if(flightPath)flightPath.setPath([]);if(marker_start)marker_start.setMap(null);if(marker_finish)marker_finish.setMap(null);flightPlanCoordinates=[];showed_path=[]});var zonekit=new ZoneKit;$("#map_zone_show").click(zonekit.Show);$("#map_zone_add").click(zonekit.AddPoligon);$("#map_zone_edit").click(zonekit.Edit);
var dirkit=new DirKit;$("#map_track_calc").click(dirkit.Route);window.config.alarm.show_alert_icons()})})();(function(){var geocoder;var adrlist=[];var getGeocode=function(adrlist,i,recur){if(adrlist[i].stop)log("stop: "+i);if(geocoder)geocoder.geocode({"latLng":new google.maps.LatLng(adrlist[i].pos[0],adrlist[i].pos[1])},function(results,status){if(adrlist[i].stop){log("stop2: "+i);return}if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);$("#"+adrlist[i].id).html(address).attr("title","");delete adrlist[i];var empty=true;for(var j in adrlist){empty=false;break}if(empty==true)$(".control").show()}else if(recur)adrlist[i].cb=
setTimeout(function(){getGeocode(adrlist,i,recur-1)},6E3);else log("Error geocoding at "+i+" with ")});else delete adrlist[i]};var genReport=function(skey,start,stop,title){for(var i in adrlist){clearInterval(adrlist[i].cb);adrlist[i].stop=true}$("#report_header").html("Отчет для системы "+config.sysbykey[skey].desc+" за "+title+"");$("#report tbody").empty();$.getJSON("/api/report/get?skey="+skey+"&from="+start+"&to="+stop,function(data){log("getJSON parce");if(data.answer=="ok"){log("Show report...");
$("#report_total_dist").html(ln_to_km(data.summary.length));$("#report_total_movetime").html(td_to_hms(data.summary.movetime));$("#report_total_avspeed").html(data.summary.speed.toFixed(1)+" км/ч");$("#report_total_stoptime").html(td_to_hms(data.summary.stoptime));$("#report_total_maxspeed").html(data.summary.maxspeed.toFixed(1)+" км/ч");var tbody=$("#report tbody");adrlist=[];var cur_date="";if(data.report.length==0)tbody.append("<tr><td>Нет данных.</td></tr>");for(var i in data.report){var ad_id=
"ad_"+i;var rec=data.report[i];var tp;switch(rec.type){case "move":if(rec.duration==0)continue;tp="Движение</td><td>"+ln_to_km(rec.length)+", "+rec.speed.toFixed(1)+" км/ч";break;case "stop":if(rec.duration<5*60)tp="Остановка";else tp="Стоянка";adrlist.push({pos:rec.start.pos,id:ad_id,stop:false});tp+='</td><td id="'+ad_id+'" title="Дождитесь окончания обновления">'+rec.start.pos;break;default:tp="Неизвестное событие ("+rec.type+")"}var events="";for(var j in rec.events){log("Event: ",j,rec.events[j]);
switch(j){case "path_break":events+='<span class="ui-icon ui-icon-alert" style="float:right;" title="Разрыв или повреждение трека. Данные отчета могут быть не точными." value="'+rec.events[j]+'"></span>';break}}if(cur_date!=dt_to_date(rec.start.time)){cur_date=dt_to_date(rec.start.time);tbody.append('<tr><td colspan="4" style="padding-top: 8px; padding-bottom: 8px; font-weight: bold;">'+cur_date+"</td></tr>")}tbody.append("<tr>"+"<td>"+'\t<\!--button class="ctl" style="float: left;"><span class="ui-icon ui-icon-cancel" title="Убрать из отчета информацию о движении"></span></button>'+
'\t<button class="ctl" style="float: left;"><span class="ui-icon ui-icon-locked" title="Оставить в отчете только информацию о движении"></span></button--\>'+'\t<\!--button class="ctl" style="float: left;"><span class="ui-icon ui-icon-zoomin" title="Показать этот путь на карте" onclick="showMap('+rec.start.pos+",'Стоянка "+td_to_hms(rec.duration)+" с "+dt_to_time(rec.start.time)+" по "+dt_to_time(rec.stop.time)+"', "+rec.start.time+');"></span></button--\>'+'\t<button class="ctl" style="float: left;"><span class="ui-icon ui-icon-zoomin" title="Показать на карте" onclick="showMap2(\''+
rec.start.time+"','"+rec.stop.time+"', '"+rec.type+"');\"></span></button>"+tp+events+"</td>"+"<td>"+dt_to_time(rec.start.time)+" - "+dt_to_time(rec.stop.time)+"</td>"+"<td>"+""+td_to_time(rec.duration)+"</td>"+"</tr>")}$(tbody).children("tr").click(function(){$(this).css("font-weight","bold")});for(var i in adrlist){if(i==0)$(".control").hide();(function(i){adrlist[i].cb=setTimeout(function(){getGeocode(adrlist,i,50)},1E3)})(i)}$(".ctl").button()}})};var purgeReport=function(){$("#report tbody").empty()};
var showMap2=function(from,to,type){var map_div=$("#map_preview");if(map_div.length==0){var div=$("body").append('<div id="map_overlay" class="ui-widget-overlay"></div>').append('<div id="map_preview" style="">Загрузка карты, ожидайте...</div>');var map_div=$("#map_preview");$("#map_preview").append('<div id="rmap"></div>').append('<div id="map_close" style="position: absolute; top: -10px; left: 50%; margin-left: -20px;"><span class="ui-icon ui-icon-close"></span></div>');$("#map_close").button().click(function(){$("#rmap").gmap("destroy");
$("#map_preview").remove();$("#map_overlay").remove()});$.getJSON("/api/geo/get?skey="+config.skey+"&from="+from+"&to="+to+"&options=nosubbounds",function(data){if(data.answer&&data.points.length>0){log("ShowMap2:",data);var $map=$("#rmap").gmap({pos:new google.maps.LatLng(data.points[0][1],data.points[0][2]),zoom:15,marker:"center"});var map=$($map).gmap("option","map");if(type=="move"){map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(data.bounds.sw[0],data.bounds.sw[1]),new google.maps.LatLng(data.bounds.ne[0],
data.bounds.ne[1])));var path=[];for(var i in data.points){var l=new google.maps.LatLng(data.points[i][1],data.points[i][2],false);path.push(l)}var flightPath=new google.maps.Polyline({map:map,path:path,strokeColor:config.ui.trackcolor||"#dc00dc",strokeOpacity:1,strokeWeight:3});var marker_start=new google.maps.Marker({position:new google.maps.LatLng(path[0].lat(),path[0].lng()),map:map,title:"Старт: "+dt_to_datetime(data.points[0][0]),icon:$.gmap.images["begin"],draggable:false});var marker_finish=
new google.maps.Marker({position:new google.maps.LatLng(path[path.length-1].lat(),path[path.length-1].lng()),map:map,title:"Финиш: "+dt_to_datetime(data.points[path.length-1][0]),icon:$.gmap.images["end"],draggable:false})}else var marker_stop=new google.maps.Marker({position:new google.maps.LatLng(data.points[0][1],data.points[0][2]),map:map,title:"Стoянка: "+"\n"+dt_to_datetime(data.points[0][0])+"..."+dt_to_datetime(data.points[data.points.length-1][0]),icon:$.gmap.images["stop"],draggable:false})}})}};
window["showMap2"]=showMap2;if(0)var showMap=function(lat,lon,title){var map_div=$("#map_preview");if(map_div.length==0){div=$("body").append('<div id="map_overlay" class="ui-widget-overlay"></div>').append('<div id="map_preview" style="">Ошибка отображения карты</div>');var map_div=$("#map_preview");$("#map_preview").append('<div id="rmap"></div>').append('<div id="map_close" style="position: absolute; top: -10px; left: 50%; margin-left: -20px;"><span class="ui-icon ui-icon-close"></span></div>');
console.log();var $map=$("#rmap").gmap({pos:new google.maps.LatLng(lat,lon),zoom:15,marker:"center",markertitme:title});var map=$($map).gmap("option","map");$("#map_close").button().click(function(){$("#map_preview").gmap("destroy");$("#map_preview").remove();$("#map_overlay").remove()})}log(map_div)};var Report_Make_SysList=function(list){list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+s.imei+'" value="'+s.skey+'">'+s.desc+"</option>")}};$(document).ready(function(){if("google"in
window)geocoder=new google.maps.Geocoder;$("#nav_reports").button("option","disabled",true);$("#button_report_type_div").buttonset();$("#button_report_type_day").bind("change",function(){$("#report_div_type_interval").hide("slow");$("#report_div_type_day").show("slow");log("Boo")});$("#button_report_type_interval").bind("change",function(){$("#report_div_type_day").hide("slow");$("#report_div_type_interval").show("slow");log("Boo")});$(".control").button();$.datepicker.setDefaults($.datepicker.regional["ru"]);
$("#total tbody tr td").bind("click",function(me){log(me)});if(0){var list=$("#rep_syslist");Report_Make_SysList(list);config.updater.add("changedesc",function(msg){log("LOGS: Update descriptions");$(list).find('option[value="'+msg.data.skey+'"]').html(msg.data.desc)});config.updater.add("changeslist",function(msg){Report_Make_SysList(list)})}$("#report_date_by_day").datepicker({altField:"#report_dlg_byday_alternate",altFormat:"DD, d MM, yy"});$("#report_dlg_byday").dialog({modal:true,autoOpen:false,
buttons:{"Отмена":function(){$(this).dialog("close")},"Построить отчет":function(){$(this).dialog("close");var start=$("#report_date_by_day").datepicker("getDate");var stop=new Date(start);stop.setHours(23);stop.setMinutes(59);stop.setSeconds(59);log("start:",start,"stop:",stop);config.skey=$("#report_dlg_byday_syslist").val();genReport(config.skey,Date_to_url(start),Date_to_url(stop),$.datepicker.formatDate("dd/mm/yy",start))}},open:function(event,ui){log("Dialog open:",this,ui,event);var list=$("#report_dlg_byday_syslist");
list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+s.imei+'" value="'+s.skey+'"'+(s.skey==config.skey?" selected":"")+">"+s.desc+"</option>")}}});var dates=$("#report_date_by_int_from, #report_date_by_int_to").datepicker({altFormat:"DD, d MM, yy",onSelect:function(selectedDate){var option=this.id=="report_date_by_int_from"?"minDate":"maxDate",instance=$(this).data("datepicker");date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,
selectedDate,instance.settings);dates.not(this).datepicker("option",option,date)}});$("#report_date_by_int_from").datepicker("option","altField","#report_dlg_byint_alternate_from");$("#report_date_by_int_to").datepicker("option","altField","#report_dlg_byint_alternate_to");$("#report_dlg_byint").dialog({modal:true,autoOpen:false,width:600,buttons:{"Отмена":function(){$(this).dialog("close")},"Построить отчет":function(){var start=$("#report_date_by_int_from").datepicker("getDate");var stop=$("#report_date_by_int_to").datepicker("getDate");
var time_from=$("#report_dlg_byint_time_from").val();var time_to=$("#report_dlg_byint_time_to").val();log(time_from,/^\d\d:\d\d:\d\d$/.test(time_from),time_to,/^\d\d:\d\d:\d\d$/.test(time_to));if(!/^\d\d:\d\d:\d\d$/.test(time_from)||!/^\d\d:\d\d:\d\d$/.test(time_to)){alert("Время должно задаваться в формате ЧЧ:MM:CC");return}$(this).dialog("close");config.skey=$("#report_dlg_byint_syslist").val();start.setHours(parseInt(time_from.slice(0,2),10));start.setMinutes(parseInt(time_from.slice(3,5),10));
start.setSeconds(parseInt(time_from.slice(6,8),10));stop.setHours(parseInt(time_to.slice(0,2),10));stop.setMinutes(parseInt(time_to.slice(3,5),10));stop.setSeconds(parseInt(time_to.slice(6,8),10));genReport(config.skey,Date_to_url(start),Date_to_url(stop)," интервал с "+Date_to_datetime(start)+" по "+Date_to_datetime(stop))}},open:function(event,ui){log("Dialog open:",this,ui,event);var list=$("#report_dlg_byint_syslist");list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+
s.imei+'" value="'+s.skey+'"'+(s.skey==config.skey?" selected":"")+">"+s.desc+"</option>")}}});$("#report_btn_do_by_day").button({icons:{primary:"ui-icon-note"}}).click(function(){$("#report_dlg_byday").dialog("open")}).next().button({icons:{primary:"ui-icon-note"}}).click(function(){$("#report_dlg_byint").dialog("open")});if(1)$("#report_export_xls").button().click(function(){var tbody=$("#report tbody");log("export to XLS tbody:",tbody);var rows=[];var format5=function(n){if(n<10)return"0000"+n;
else if(n<100)return"000"+n;else if(n<1E3)return"00"+n;else if(n<1E4)return"0"+n;else return""+n};$("#report tbody tr").each(function(ind,el){var line=[];$(el).children("td").each(function(tdi,tdel){line.push(tdel.textContent)});rows.push(line)});log("rows:",rows);$.ajax({url:"/export/xls",type:"post",data:{data:JSON.stringify(rows)},success:function(data,textStatus,jqXHR){var val=$.parseJSON(data);log("ok, data:",data,"val:",val);$("#export_iframe").attr("src","/export/get/"+encodeURI($("#report_header").text().replace(/[\/:?\\<*>|"']/gi,
"-"))+".xls?key="+val.key);log("header",$("#report_header").html())}})})})})();(function($){var log_line=function(d){var row="<td>"+dt_to_datetime(d.time)+"</td><td>"+d.text+"<\!--td>"+d.label+"</td--\>";if(config.admin)row+='<td class="del_log" title="Удалить сообщение\nБез подтверждения!" id="dellog_'+d.key+'" key="'+d.key+'"><span class="ui-icon ui-icon-close"></span></td>';return row};var UpdateDelProc=function(){$("td.del_log").unbind("click");$("td.del_log").bind("click",function(){var row=this;$(row).parent().remove();$.getJSON("/api/logs/del?skey="+config.skey+"&lkey="+
$(this).attr("key"),function(data){log("dellog complete");if(data.answer&&data.answer=="ok");})})};var UpdateLog=function(){log("UpdateLog");var table=$("#log_table tbody");table.empty();$.getJSON("/api/logs/get?skey="+config.skey,function(data){log("getJSON parce");if(data.answer&&data.answer=="ok")for(var i in data.logs)table.append("<tr>"+log_line(data.logs[i])+"</tr>");UpdateDelProc()})};var Log_Make_SysList=function(list){list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+
s.imei+'" value="'+s.skey+'">'+s.desc+"</option>")}};$(document).ready(function(){UpdateLog();config.syslist({id:"log_syslist",change:function(){log("LOG syslist change");config.skey=$(this).attr("value");UpdateLog()}});config.updater.add("addlog",function(msg){if(msg.data.skey==config.skey){$("#log_table tbody tr:first").before("<tr>"+log_line(msg.data)+"</tr>");UpdateDelProc()}})})})(jQuery);
