window.log=function(){if(window.console)console.log(Array.prototype.slice.call(arguments))};window.document.onselectstart=function(){return false};if("google"in window&&"maps"in google);else{var fileref=document.createElement("script");fileref.setAttribute("type","text/javascript");fileref.setAttribute("src","/js/googlemaps/js.js");document.getElementsByTagName("head")[0].appendChild(fileref)}if("google"in window&&"load"in google)google.load("visualization","1",{packages:["corechart"]});else alert("Сервер Google недоступен. \n1. Проверьте интернет-соединение. \n2. Обновите страницу (F5).");
var theme_css=document.createElement("link");theme_css.id="themecss";theme_css.setAttribute("rel","stylesheet");theme_css.setAttribute("type","text/css");config.setTheme=function(themename){theme_css.setAttribute("href","/plugins/jquery-ui-themes-1.8.16/jquery-ui-themes-1.8.16/themes/"+themename+"/jquery-ui.css");localStorage.setItem("account.theme",themename)};var def_theme=localStorage.getItem("account.theme")||"cupertino";config.setTheme(def_theme);
if(!document.getElementById("themecss")){var h0=document.getElementsByTagName("head")[0];h0.insertBefore(theme_css,h0.firstChild)}
config.inits.push(function(){log("base.js init",config);if(!window.config)alert("Ошибка инициализации. Проверьте интернет соединение.");else if(window.config.answer=="no")window.location.href=window.config.user.login_url;if(config.account.systems.length==0)config.skey=null;else config.skey=config.account.systems[0].skey;config.sysbykey={};for(var i in config.account.systems){var sys=config.account.systems[i];config.sysbykey[sys.skey]=sys}config.user=config.account.user;config.username=config.account.user.nickname;
config.admin=config.account.user.admin;config.systems=config.account.systems;config.ui=config.account.config;config.akey=config.account.key;console.log("Init config:",config);config.setTheme(config.account.config.theme);$("#a_login").attr("href",window.config.account.user.logout_url);$("#a_login").html(window.config.account.user.nickname)});var f2d=function(n){if(n<10)return"0"+n;return String(n)};
var dt_to_Date=function(dt){var date=new Date(Date.UTC(parseInt("20"+dt[0]+dt[1],10),parseInt(dt[2]+dt[3],10)-1,parseInt(dt[4]+dt[5],10),parseInt(dt[6]+dt[7],10),parseInt(dt[8]+dt[9],10),parseInt(dt[10]+dt[11],10)));return date};var dt_to_date=function(dt){var date=dt_to_Date(dt);return f2d(date.getDate())+"/"+f2d(date.getMonth()+1)+"/"+date.getFullYear()};var dt_to_time=function(dt){var date=dt_to_Date(dt);return date.toLocaleTimeString()};
var dt_to_datetime=function(dt){return dt_to_date(dt)+" "+dt_to_time(dt)};var Date_to_date=function(date){return f2d(date.getDate())+"/"+f2d(date.getMonth()+1)+"/"+date.getFullYear()};var Date_to_time=function(date){return date.toLocaleTimeString()};var Date_to_datetime=function(date){return Date_to_date(date)+" "+Date_to_time(date)};
var td_to_hms=function(d){var minutes=(d-d%60)/60;var hours=(minutes-minutes%60)/60;minutes=minutes%60;var seconds=d%60;if(hours)return hours+" ч "+minutes+" мин "+seconds+" сек";else if(minutes)return minutes+" мин "+seconds+" сек";else return seconds+" сек"};
var td_to_time=function(d){var minutes=(d-d%60)/60;var hours=(minutes-minutes%60)/60;minutes=minutes%60;var seconds=d%60;var r="";if(hours<10)r+="0"+hours+":";else r+=hours+":";if(minutes<10)r+="0"+minutes+":";else r+=minutes+":";if(seconds<10)r+="0"+seconds;else r+=seconds;return r};var Date_to_daystart=function(d){var date=new Date(d);date.setHours(0);date.setMinutes(0);date.setSeconds(0);return date};
var Date_to_daystop=function(d){var date=new Date(d);date.setHours(23);date.setMinutes(59);date.setSeconds(59);return date};var Date_to_url=function(d){return f2d(d.getUTCFullYear()-2E3)+f2d(d.getUTCMonth()+1)+f2d(d.getUTCDate())+f2d(d.getUTCHours())+f2d(d.getUTCMinutes())+f2d(d.getUTCSeconds())};var DateDiff=function(d){};var ln_to_km=function(l){if(l>=1)return Math.round(l*10)/10+" км";else return Math.round(l*1E3)+" м"};
var geocode_to_addr=function(results){var comp={street_address:"",route:"",locality:"",sublocality:"",administrative_area_level_2:"",administrative_area_level_1:"",country:""};for(var i in results)for(var j in results[i].address_components){var c=results[i].address_components[j];comp[c.types[0]]=c.long_name}return""+comp.country+", "+comp.administrative_area_level_1+", "+(comp.locality==""?(comp.sublocality!=""?comp.sublocality:comp.administrative_area_level_2)+" район, ":"")+(comp.locality!=""?comp.locality+
", ":"")+comp.route+(comp.street_number&&comp.street_number!=""?", "+comp.street_number:"")};if(0)var geocode_to_addr2=function(results){for(var i in results){var r=results[i];if(r.types.indexOf("street_address")!=-1||r.types.indexOf("sublocality")!=-1||r.types.indexOf("locality")!=-1)return r.formatted_address}if(results[1])return results[1].formatted_address;else if(results[0])return results[0].formatted_address;return"Адрес неизвестен"};
(function(window,$,undefined){google.maps.LatLng.prototype.toArray=function(){return[this.lat(),this.lng()]};google.maps.LatLngBounds.prototype.toArray=function(){return[this.getSouthWest().toArray(),this.getNorthEast().toArray()]};if(!google.maps.Polygon.prototype.getBounds)google.maps.Polygon.prototype.getBounds=function(latLng){var bounds=new google.maps.LatLngBounds;var paths=this.getPaths();var path;for(var p=0;p<paths.getLength();p++){path=paths.getAt(p);for(var i=0;i<path.getLength();i++)bounds.extend(path.getAt(i))}return bounds};
if(!google.maps.Polyline.prototype.getBounds)google.maps.Polyline.prototype.getBounds=function(latLng){var bounds=new google.maps.LatLngBounds;var path=this.getPath();for(var i=0;i<path.getLength();i++)bounds.extend(path.getAt(i));return bounds};if(!google.maps.Polygon.prototype.contains)google.maps.Polygon.prototype.contains=function(latLng){if(this.getBounds&&!this.getBounds().contains(latLng))return false;var lat=latLng.lat();var lng=latLng.lng();var paths=this.getPaths();var path,pathLength,inPath,
i,j,vertex1,vertex2;for(var p=0;p<paths.getLength();p++){path=paths.getAt(p);pathLength=path.getLength();j=pathLength-1;inPath=false;for(i=0;i<pathLength;i++){vertex1=path.getAt(i);vertex2=path.getAt(j);if(vertex1.lng()<lng&&vertex2.lng()>=lng||vertex2.lng()<lng&&vertex1.lng()>=lng)if(vertex1.lat()+(lng-vertex1.lng())/(vertex2.lng()-vertex1.lng())*(vertex2.lat()-vertex1.lat())<lat)inPath=!inPath;j=i}if(inPath)return true}return false};$(document).ready(function(){if(document.body.clientWidth<document.width-
8||document.body.clientWidth>document.width+8){var msg=document.createElement("div");msg.style.cssText="position: absolute; top: 30%; left: 30%; width: 30%; min-height: 30%; background: white; z-index: 2000; border: 1px solid black; border-radius: 8px; padding: 10px; box-shadow: 0px 0px 10px #404040;";msg.innerHTML='<b>Масштабирование страницы не рекомендуется.<br />Это может привести к серьезному снижению производительности.</b><br /> Установите масштаб 100%.<br />Нажмите Ctrl+0 (нажмите клавишу Ctrl, и не отпуская, нажмите клавишу "ноль").';
document.body.appendChild(msg);var notcare=document.createElement("button");notcare.style["margin-top"]="30px";notcare.innerHTML="Да я осознаю возможные трудности и изменил масштаб умышленно.";msg.appendChild(notcare);var t=setInterval(function(){if(document.body.clientWidth>document.width-8&&document.body.clientWidth<document.width+8){document.body.removeChild(msg);clearInterval(t)}},1E3);notcare.addEventListener("click",function(){document.body.removeChild(msg);clearInterval(t)})}});var favicon;
var faviconCtx;favicon=document.createElement("canvas"),faviconCtx=favicon.getContext("2d");favicon.width=favicon.height=16;window.config.working=function(){var workingdiv=document.getElementById("working");workingdiv.style.display="inline";faviconCtx.clearRect(0,0,16,16).prop("fillStyle","#0a0").roundRect(0,0,16,16,2).fill();document.querySelector('link[rel="shortcut icon"]').setAttribute("href",favicon.toDataURL())};window.config.workingdone=function(){var workingdiv=document.getElementById("working");
workingdiv.style.display="none";faviconCtx.clearRect(0,0,16,16).prop("fillStyle","#0ab").roundRect(0,0,16,16,2).fill();document.querySelector('link[rel="shortcut icon"]').setAttribute("href",favicon.toDataURL())};var appCache=window.applicationCache;window.addEventListener("load",function(e){window.applicationCache.addEventListener("updateready",function(e){if(window.applicationCache.status==window.applicationCache.UPDATEREADY){window.applicationCache.swapCache();if(confirm("Доступна новая версия сайта. Перезагрузить страницу?"))window.location.reload()}else;
},false)},false);config.helper={empty:function(element){while(element.firstChild)element.removeChild(element.firstChild)},postJSON:function(url,data,callback){config.working();var formData=new FormData;for(k in data)if(typeof data[k]=="object")formData.append(k,JSON.stringify(data[k]));else formData.append(k,data[k]);var xhr=new XMLHttpRequest;xhr.open("POST",url,true);xhr.onreadystatechange=function(){if(xhr.readyState===xhr.DONE){if(xhr.status===200||xhr.status===304)callback(JSON.parse(xhr.responseText));
config.workingdone()}};xhr.send(formData)},getJSON:function(url,callback){config.working();var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200||xhr.status===304)callback(JSON.parse(xhr.responseText));config.workingdone()}};xhr.send(null)}};config.helper.element_by_html=function(htmlString){var tempDiv=document.createElement("div");tempDiv.innerHTML="<br>"+htmlString;tempDiv.removeChild(tempDiv.firstChild);if(tempDiv.childNodes.length==
1)return tempDiv.removeChild(tempDiv.firstChild);else{var fragment=doc.createDocumentFragment();while(tempDiv.firstChild)fragment.appendChild(tempDiv.firstChild);return fragment}};var clone=function(o){if(!o||"object"!==typeof o)return o;var c="function"===typeof o.pop?[]:{};for(var p in o)if(o.hasOwnProperty(p)){var v=o[p];if(v&&"object"===typeof v)c[p]=clone(v);else c[p]=v}return c};config.helper.clone=clone})(window,jQuery);(function(window,$,undefined){var config=window.config;config.updater={};config.updater.queue={};config.updater.add=function(msg,foo){config.updater.queue[msg]=config.updater.queue[msg]||[];config.updater.queue[msg].push(foo)};config.updater.process=function(msg){if(config.updater.queue[msg.msg])for(var i in config.updater.queue[msg.msg])config.updater.queue[msg.msg][i](msg);if(config.updater.queue["*"])for(var i in config.updater.queue["*"])config.updater.queue["*"][i](msg)};config.updater.add("*",
function(msg){});config.updater.tabs=[];function UpdaterInit(){var uuid=(new Date).getTime().toString(36)+Math.floor(Math.random()*2147483648).toString(36);$.getJSON("/api/channel/gettoken?uuid="+uuid,function(data){if(data.token!="disabled"){var token=data.token;log("Token goted:"+token,"uuid="+uuid);var onOpened=function(){log("goog.appengine.Channel: onOpened ("+token+")")};var onMessage=function(m){var msg=JSON.parse(m.data);log("goog.appengine.Channel: onMessage",token,msg);msg.map(function f(m){config.updater.process(m)})};
var onError=function(){log("goog.appengine.Channel: onError")};var onClose=function(){log("goog.appengine.Channel: onClose (TBD! Reconnect?)");var msg=document.createElement("div");msg.style.cssText="position: absolute; top: 30%; left: 30%; width: 30%; min-height: 30%; background: white; z-index: 2000; border: 1px solid black; border-radius: 8px; padding: 10px; box-shadow: 0px 0px 10px #404040;";msg.innerHTML="<b>Утеряно соединение с сервером.<br />Для восстановления соединения перезагрузите страницу.</b><br />Нажмите F5.";
document.body.appendChild(msg);var notcare=document.createElement("button");notcare.style["margin-top"]="30px";notcare.innerHTML="Перезагрузить.";msg.appendChild(notcare);notcare.addEventListener("click",function(){document.body.removeChild(msg);window.location.reload()})};if(window.location.hostname=="localhost")goog.appengine.Socket.POLLING_TIMEOUT_MS=15E3;var channel=new goog.appengine.Channel(token);var socket=channel.open();socket.onopen=onOpened;socket.onmessage=onMessage;socket.onerror=onError;
socket.onclose=onClose}else log("channel api is disabled")})}$(document).ready(function(){UpdaterInit()});if(0){var BlobBuilder=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;var bb=new BlobBuilder;bb.append("onmessage = function(e) { postMessage('msg from worker'); }");var blobURL=(window.URL||window.webkitURL).createObjectURL(bb.getBlob());log("blobURL",blobURL);var worker=new Worker(blobURL);worker.onmessage=function(e){log("worker in main",e)};worker.postMessage()}})(window,
jQuery);(function(window){var document=window.document;var initHA=function(){var is_ie6=window.external&&typeof window.XMLHttpRequest=="undefined";var styles="div#messages{position:fixed;top:0px;right:0px;width:250px;margin:0px;padding:0px;background:transparent;z-index:1000}"+"div#messages div{cursor: pointer;color:#fff;padding:7px;margin-bottom:7px;-moz-border-radius:5px;-webkit-border-radius:5px;-khtml-border-radius:5px;opacity:0.75;background:#888;font: normal 12px 'Georgia'}"+"div#messages div.error{background:#98001b}\tdiv#messages div.message{background:#0d8529}div#messages div.warning{background:#dd6; color:#333}";
var iestyles="body{position:relative}div#messages{position:absolute; -ms-filter:'progid:DXImageTransform.Microsoft.Alpha(Opacity=75)'; filter: alpha(opacity=75)}div#messages div{cursor: hand}";var addLoadEvent=function(func){var oldonload=window.onload;if(typeof window.onload!="function")window.onload=func;else window.onload=function(){if(oldonload)oldonload();func()}};var import_style=function(src){if(src==null||src==undefined)return;var imprt=document.createElement("style");imprt.setAttribute("type",
"text/css");if(imprt.styleSheet)imprt.styleSheet.cssText=src;else imprt.appendChild(document.createTextNode(src));document.getElementsByTagName("head")[0].appendChild(imprt)};var addAll=function(){var messageBox=document.createElement("div");messageBox.id="messages";if(document.body.firstChild)document.body.insertBefore(messageBox,document.body.firstChild);else document.body.appendChild(messageBox);import_style(styles);if(is_ie6)import_style(iestyles)};addAll()};initHA();var message=function(mtext,
mtype,howlong){var mtype=mtype||"message";var howlong=howlong||8E3;if(document.getElementById("messages")==null){setTimeout(function(){message(mtext,mtype,howlong)},100);return}var alarm=document.createElement("div");alarm.className=mtype;alarm.innerHTML=mtext;alarm.onclick=function(){alarm.style.display="none"};alarm.del=function(){document.getElementById("messages").removeChild(alarm)};document.getElementById("messages").appendChild(alarm);setTimeout(alarm.del,howlong)};window["message"]=message})(window);(function(window,$,undefined){var document=window.document;var lists_count=0;config.updater.add("change_desc",function(msg){config.sysbykey[msg.skey].desc=msg.data.desc});config.updater.add("change_slist",function(msg){log("global SysList: change_slist.",msg);switch(msg.data.type){case "Adding":if(!(msg.data.system.key in config.sysbykey)){var system=config.helper.clone(msg.data.system);config.account.systems.push(system);config.sysbykey[system.key]=system}break}});var tags={};config.inits.push(function(){for(var k in config.account.systems)for(var t in config.account.systems[k].tags)tags[config.account.systems[k].tags[t]]=
1});function SysList(elementid,handlers){var me=this;me.handlers={};for(var k in me.default_handlers)me.handlers[k]=me.default_handlers[k];for(var k in handlers)me.handlers[k]=handlers[k];lists_count+=1;me.listnum=lists_count;me.elementid=elementid;log("SysList: init",elementid);me.element=document.getElementById(me.elementid);me.nodename=me.element.nodeName.toLowerCase();me.Rebuild();if(me.handlers.taggroupid){me.taggroup=document.getElementById(me.handlers.taggroupid);log("exist",me.taggroup)}else if(me.nodename==
"select")me.taggroup=document.createElement("select");if(me.taggroup){var tagHTML="<option>Все</option>";for(var t in tags)tagHTML+="<option>"+t+"</option>";me.taggroup.innerHTML=tagHTML;if(me.nodename=="select")me.element.parentNode.insertBefore(me.taggroup,me.element);me.taggroup.addEventListener("change",function(e){var index=this.selectedIndex;var tag=this.value;for(var i=0,l=me.element.childNodes.length;i<l;i++){var node=me.element.childNodes[i];if(index==0||config.sysbykey[node.dataset.skey].tags.indexOf(tag)!=
-1)node.style.display="";else node.style.display="none"}if(me.nodename=="select"){me.element.selectedIndex=0;var evt=document.createEvent("HTMLEvents");evt.initEvent("change",true,true);me.element.dispatchEvent(evt)}if(me.handlers.tagchange)me.handlers.tagchange.call(me,tag,index)});config.updater.add("change_tag",function(msg){log("SysList: change_tag. Update system tags.",msg);config.sysbykey[msg.skey].tags=msg.data.tags.slice();for(var t in msg.data.tags){log("tag",t,msg.data.tags[t]);if(!(msg.data.tags[t]in
tags)){tags[msg.data.tags[t]]=1;me.taggroup.appendChild(new Option(msg.data.tags[t]));log("append",me.taggroup)}}})}if(me.nodename=="select")me.element.addEventListener("change",function(e){me.handlers.select(window.config.account.systems[e.target.selectedIndex])});config.updater.add("change_slist",function(msg){me.Rebuild()});config.updater.add("change_desc",function(msg){me.handlers.change.call(me,msg.skey,msg.data.desc)})}SysList.prototype.default_handlers={start:function(){this.element=this.element||
document.getElementById(this.elementid);while(this.element.firstChild)this.element.removeChild(this.element.firstChild)},element:function(s){if(/^select$/i.test(this.element.nodeName)){var option=document.createElement("option");option.title="IMEI: "+s.imei.replace(/-.*/,"");option.innerHTML=s.desc;return option}else log("SysList: Warning! You must define handlers.item method")},finish:function(){},select:function(system){},change:function(skey,desc){var node=this.element.querySelector('*[data-skey="'+
skey+'"]');[].forEach.call(node.childNodes,function(el){if(el.nodeType===Node.TEXT_NODE)el.data=desc;else if(el.classList.contains("description"))el.innerText=desc})},additem:function(s){var el=this.handlers.element.call(this,s);el.dataset.skey=s.key;el.dataset.imei=s.imei;this.element.appendChild(el)},remove:function(skey){log("SysList: Warning! You must define remove handler")}};SysList.prototype.Rebuild=function(){log("SysList.prototype.Rebuild");this.handlers.start.call(this);for(var i in window.config.account.systems){var s=
window.config.account.systems[i];this.handlers.additem.call(this,s)}this.handlers.finish.call(this)};config.updater.add("changedesc",function(msg){for(var i in config.systems)if(config.systems[i].skey==msg.data.skey)config.systems[i].desc=msg.data.desc;if(msg.data.skey in config.sysbykey)config.sysbykey[msg.data.skey].desc=msg.data.desc});window["SysList"]=SysList})(window,jQuery);function MyMarker(map){this.map=map;this.div=null;this.arrdiv=null;this.title=null;this.point=null;this.infowindow=null;this.skey=null;this.setMap(map)}MyMarker.prototype=new google.maps.OverlayView;var add_geo_row=function(label,value){$("#tbl_info tbody").append("<tr><td>"+label+"</td><td><b>"+value+"</b></td></tr>")};
var more_info=function(data){$("#moreinfo").html("");add_geo_row("Спутники",data.point.sats);add_geo_row("Скорость",data.point.speed+"км/ч");add_geo_row("Основное питание",data.point.vout+"В");add_geo_row("Резервное питание",data.point.vin+"В");add_geo_row("Тип метки",data.point.fsource)};MyMarker.prototype.HideInfo=function(){if(this.infowindow)this.infowindow.close()};
MyMarker.prototype.Info=function(){var point=this.point;var skey=this.skey;if(this.infowindow)this.infowindow.close();this.infowindow=new google.maps.InfoWindow({content:'<div style="width: 220px; height: 160px; border: none;"><div class="info-header">'+dt_to_datetime(point.date)+"</div>"+'<table id="tbl_info" width="100%">'+"<tr><td>Направление:</td><td><b>"+point.angle.toFixed(0)+"°</b></td></tr>"+"<tr><td>Долгота:</td><td><b>"+point.lat().toFixed(5)+"</b></td></tr>"+"<tr><td>Широта:</td><td><b>"+
point.lng().toFixed(5)+"</b></td></tr>"+"</table>"+'<div id="moreinfo" title="Ожидайте, идет получение дополнительной информации."><center><img src="/images/loading.gif" /></center></div></div>',position:point});var self=this;$.getJSON("/api/geo/info?skey="+skey+"&point="+point.date,function(data){if(data.answer&&data.answer==="ok")if($("#tbl_info tbody"))$("#tbl_info tbody").ready(function(){more_info(data)})});this.infowindow.open(this.map)};
MyMarker.prototype.onAdd=function(){var div=document.createElement("div");div.marker=this;div.setAttribute("class","mymarker");var arrdiv=document.createElement("div");arrdiv.setAttribute("class","mymarker-arrow");div.appendChild(arrdiv);div.addEventListener("click",function(e){this.marker.Info()},false);if(0){div.addEventListener("mouseover",function(e){arrdiv=document.getElementById("arrowdiv");if(arrdiv==null){arrdiv=document.createElement("div");arrdiv.setAttribute("id","arrowdiv");arrdiv.setAttribute("class",
"arrowdiv");panes.overlayMouseTarget.appendChild(arrdiv)}arrdiv.setAttribute("style","-webkit-transform: rotate("+this.marker.angle+"deg);z-index:-1;");var overlayProjection=this.marker.getProjection();arrdiv.style.left=parseInt(this.marker.div.style.left,10)-13+"px";arrdiv.style.top=parseInt(this.marker.div.style.top,10)-13+"px"},false);div.addEventListener("mouseout",function(e){arrdiv=document.getElementById("arrowdiv");if(arrdiv)arrdiv.style.display="none"},false)}if(0){var arrdiv=document.createElement("div");
arrdiv.setAttribute("class","arrowdiv");arrdiv.setAttribute("style","-webkit-transform: rotate("+this.angle+"deg);z-index:-1;");if(this.i%8)arrdiv.style.display="none"}this.div=div;this.arrdiv=arrdiv;var panes=this.getPanes();this.panes=panes;panes.overlayImage.appendChild(div)};MyMarker.prototype.setTitle=function(title){this.div.setAttribute("title",title);this.title=title};MyMarker.prototype.setSysKey=function(skey){this.skey=skey};
MyMarker.prototype.setPosition=function(point){this.point=point;this.arrdiv.setAttribute("style","-webkit-transform: rotate("+point.angle+"deg);z-index:-1;");this.setTitle(dt_to_datetime(point.date));this.draw()};MyMarker.prototype.onRemove=function(){this.div.removeChild(this.arrdiv);this.div.parentNode.removeChild(this.div);this.arrdiv=null;this.div=null};
MyMarker.prototype.draw=function(){if(this.point){var overlayProjection=this.getProjection();var divpx=overlayProjection.fromLatLngToDivPixel(this.point);var div=this.div;div.style.left=divpx.x-8+"px";div.style.top=divpx.y-8+"px"}};(function(){function LastMarker(options){this.div=null;this.arrdiv=null;this.options=options;this.position=options.position;this.point=options.point;this.color=options.color||"green";this.desc=options.desc||"Не определено";this.skey=options.skey;this.setMap(options.map)}LastMarker.prototype=new google.maps.OverlayView;LastMarker.prototype.Info=function(){if(0){var point=this.point;var skey=this.skey;log("skey = "+skey);if(this.infowindow)this.infowindow.close();this.infowindow=new google.maps.InfoWindow({content:'<div style="width: 220px; height: 220px; border: none;"><div class="info-header">'+
dt_to_datetime(point.date)+"</div>"+'<table id="tbl_info" width="100%">'+"<tr><td>Направление:</td><td><b>"+point.angle.toFixed(0)+"°</b></td></tr>"+"<tr><td>Долгота:</td><td><b>"+point.lat().toFixed(5)+"</b></td></tr>"+"<tr><td>Широта:</td><td><b>"+point.lng().toFixed(5)+"</b></td></tr>"+"</table>"+'<div id="moreinfo" title="Ожидайте, идет получение дополнительной информации."><center><img src="/images/loading.gif" /></center></div></div>',position:point});var self=this;$.getJSON("/api/geo/info?skey="+
skey+"&point="+point.date,function(data){log("JSON data: ",data);if(data.answer&&data.answer==="ok")if($("#tbl_info tbody"))$("#tbl_info tbody").ready(function(){log("JSON data: jquery domready.");more_info(data)})});this.infowindow.open(map)}};var SVG={};SVG.ns="http://www.w3.org/2000/svg";SVG.xlinkns="http://www.w3.org/1999/xlink";LastMarker.prototype.onAdd=function(){var div=document.createElement("div");div.marker=this;div.setAttribute("class","lastmarker");div.setAttribute("title",this.options.desc+
"\n"+this.point.time);div.setAttribute("skey",this.skey);var label=document.createElement("div");label.setAttribute("class","lastmarker-label");label.innerHTML=this.options.desc;var control=document.createElement("div");control.setAttribute("class","lastmarker-control");label.appendChild(control);div.appendChild(label);var svg=document.createElementNS(SVG.ns,"svg:svg");svg.setAttribute("style","margin: -8px -8px -8px -8px");svg.setAttribute("width","32px");svg.setAttribute("height","32px");svg.setAttributeNS("http://www.w3.org/2000/xmlns/",
"xmlns:xlink",SVG.xlinkns);var g=document.createElementNS(SVG.ns,"g");g.setAttributeNS(null,"transform","translate(16,16)");var shape=document.createElementNS(SVG.ns,"polyline");shape.setAttributeNS(null,"points","-8,-4 0,-15 8,-4");shape.setAttributeNS(null,"fill","none");shape.setAttributeNS(null,"stroke","black");shape.setAttributeNS(null,"stroke-width","2px");shape.setAttributeNS(null,"transform","rotate("+this.point.course+")");this.shape=shape;g.appendChild(shape);svg.appendChild(g);div.appendChild(svg);
div.addEventListener("click",function(e){log("lastmarker: click",e)},false);var me=this;div.addEventListener("mouseover",function(e){var panel="";panel+="<table><tbody>";panel+="<tr><td>Время</td><td>"+dt_to_datetime(me.point.time)+"</td></tr>";panel+="<tr><td>Скорость</td><td>"+me.point.speed+"</td></tr>";panel+="<tr><td>Осн.питание</td><td>"+me.point.vout+"</td></tr>";panel+="<tr><td>Рез.питание</td><td>"+me.point.vin+"</td></tr>";panel+="<tr><td>Спутники</td><td>"+me.point.sats+"</td></tr>";panel+=
"<tr><td>Топливо</td><td>-</td></tr>";panel+="</tbody></table>";control.innerHTML=panel},false);div.addEventListener("mouseout",function(e){},false);if(0){var arrdiv=document.createElement("div");arrdiv.setAttribute("class","arrowdiv");arrdiv.setAttribute("style","-webkit-transform: rotate("+this.angle+"deg);z-index:-1;");if(this.i%8)arrdiv.style.display="none"}this.div=div;this.label=label;this.control=null;var panes=this.getPanes();this.panes=panes;panes.overlayImage.appendChild(div)};LastMarker.prototype.setPosition=
function(point,position){this.position=position;this.point=point;this.draw()};LastMarker.prototype.onRemove=function(){this.div.removeChild(this.arrdiv);this.div.parentNode.removeChild(this.div);this.arrdiv=null;this.div=null};LastMarker.prototype.draw=function(){if(this.position){var overlayProjection=this.getProjection();var divpx=overlayProjection.fromLatLngToDivPixel(this.position);var div=this.div;div.style.left=divpx.x-8+"px";div.style.top=divpx.y-8+"px";if(this.shape)this.shape.setAttributeNS(null,
"transform","rotate("+this.point.course+")")}};window["LastMarker"]=LastMarker})();(function($,undefined){var PROP_NAME="gmap";function GMap(){this.debug=false;this._curInst=null;this._mainDivId="gmap";this.regional=[];this.regional[""]={closeText:"Close"};this._defaults={pos:new google.maps.LatLng(48.370848,32.717285),zoom:6,maptype:google.maps.MapTypeId.ROADMAP,marker:"none",markertitme:"Ooooops!"};this.Image_Stop=new google.maps.MarkerImage("/images/marker-stop.png",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));this.Image_Halt=new google.maps.MarkerImage("/images/marker-halt.png",
new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.extend(this._defaults,this.regional[""])}$.extend(GMap.prototype,{markerClassName:"hasGMap",_widgetGMap:function(){return this.dpDiv},_getInst:function(target){try{return $.data(target,PROP_NAME)}catch(err){throw"Missing instance data for this gmap";}},_setPos:function(inst,date,noChange){},_setPosGMap:function(target,pos){var inst=this._getInst(target);if(inst)this._setPos(inst,pos);else;},_destroyGMap:function(target){var $target=
$(target);var inst=$.data(target,PROP_NAME);if(!$target.hasClass(this.markerClassName)){log("GMAP error: not a map");return}var nodeName=target.nodeName.toLowerCase();$.removeData(target,PROP_NAME);$target.removeClass(this.markerClassName).empty()},_optionGMap:function(target,name,value){var inst=this._getInst(target);if(arguments.length==2&&typeof name=="string")return name=="defaults"?$.extend({},$.gmap._defaults):inst?name=="all"?$.extend({},inst.settings):this._get(inst,name):null},_get:function(inst,
name){return inst.settings[name]!==undefined?inst.settings[name]:this._defaults[name]},_attachMap:function(target,settings){var nodeName=target.nodeName.toLowerCase();var id=this._mainDivId=target.id;var divSpan=$(target);var inst=$.data(target,PROP_NAME,$.extend({},this._defaults,settings||{}));inst.settings=$.extend({},settings||{});var mapdiv=document.createElement("div");mapdiv.id=this._mainDivId+"_m";mapdiv.className="map-container";var controldiv=document.createElement("div");controldiv.className=
"map-control";controldiv.innerHTML=""+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_map" value="0" name="'+this._mainDivId+'_type" checked="checked" /><label for="'+this._mainDivId+'btn_map">Карта</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_sat" value="1" name="'+this._mainDivId+'_type" /><label for="'+this._mainDivId+'btn_sat">Спутник</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_hybr" value="2" name="'+this._mainDivId+
'_type" /><label for="'+this._mainDivId+'btn_hybr">Гибрид</label>'+'<input type="radio" class="btn_map_type" id="'+this._mainDivId+'btn_terr" value="3" name="'+this._mainDivId+'_type" /><label for="'+this._mainDivId+'btn_terr">Рельеф</label>';divSpan.append(mapdiv);divSpan.append(controldiv);divSpan.addClass(this.markerClassName);var mapOptions={center:inst.settings.pos||new google.maps.LatLng(48.5,34.599),mapTypeId:inst.settings.maptype||google.maps.MapTypeId.ROADMAP,mapTypeControl:false,scaleControl:true,
disableDoubleClickZoom:true,draggableCursor:"default",zoom:inst.settings.zoom};var map=new google.maps.Map(mapdiv,mapOptions);inst.settings.map=map;$(controldiv).buttonset();$(controldiv).find("input").change(function(){switch($(this).attr("value")){case "0":map.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case "1":map.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case "2":map.setMapTypeId(google.maps.MapTypeId.HYBRID);break;case "3":map.setMapTypeId(google.maps.MapTypeId.TERRAIN);break}})}});
$.fn.gmap=function(options){if(!$.gmap.initialized)$.gmap.initialized=true;var otherArgs=Array.prototype.slice.call(arguments,1);if(options=="option"&&arguments.length==2&&typeof arguments[1]=="string")return $.gmap["_"+options+"GMap"].apply($.gmap,[this[0]].concat(otherArgs));return this.each(function(){typeof options=="string"?$.gmap["_"+options+"GMap"].apply($.gmap,[this].concat(otherArgs)):$.gmap._attachMap(this,options)})};$.gmap=new GMap;$.gmap.initialized=false;$.gmap.version="0.0.2";$.gmap.images=
{};$.gmap.images["start"]=new google.maps.MarkerImage("/images/marker-start.png?v=1",new google.maps.Size(24,20),new google.maps.Point(0,0),new google.maps.Point(11,19));$.gmap.images["finish"]=new google.maps.MarkerImage("/images/marker-finish.png?v=1",new google.maps.Size(28,20),new google.maps.Point(0,0),new google.maps.Point(14,19));$.gmap.images["begin"]=new google.maps.MarkerImage("/images/marker-begin.png?v=1",new google.maps.Size(30,20),new google.maps.Point(0,0),new google.maps.Point(15,
19));$.gmap.images["end"]=new google.maps.MarkerImage("/images/marker-end.png?v=1",new google.maps.Size(30,20),new google.maps.Point(0,0),new google.maps.Point(15,19));$.gmap.images["stop"]=new google.maps.MarkerImage("/images/marker-stop.png?v=1",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["halt"]=new google.maps.MarkerImage("/images/marker-halt.png?v=1",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["alarm"]=
new google.maps.MarkerImage("/images/marker-alarm.png?v=3",new google.maps.Size(16,20),new google.maps.Point(0,0),new google.maps.Point(7,19));$.gmap.images["center"]=new google.maps.MarkerImage("/images/marker-center.png?v=1",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(15,15))})(jQuery);if(0)(function($,undefined){var alertcnt=0;var geocoder;if("google"in window)geocoder=new google.maps.Geocoder;window.config["informer"]={};config.updater.add("inform",function(msg){log("Inform: update",msg);if(msg.data.skey in window.config.informer){var infs=window.config.informer[msg.data.skey];for(var i in infs)if(infs[i].msg==msg.data.msg){infs[i].callback();delete infs[i]}}});var push_informer=function(skey,msg,callback){if(!(skey in window.config.informer))window.config.informer[skey]=[];window.config.informer[skey].push({"msg":msg,
"callback":callback})};window.config["alarm"]={};var remove_alert_icon=function(skey){$('div#alert_container>span[skey="'+skey+'"]').remove()};var show_alarm_window=function(skey,update){var data=window.config.alarm[skey];if(update){var sound=new Audio;sound.src="sound/alarm."+(sound.canPlayType("audio/ogg")?"ogg":sound.canPlayType("audio/mp3")?"mp3":"wav");sound.play()}if(update){data.dthistory=data.dthistory||[];data.dthistory.push(data.dt)}data.position=new google.maps.LatLng(data.lpos[0],data.lpos[1]);
if($("#alarmdlg_"+skey).length>0){if($(data.dialog).dialog("isOpen")){if(update)$(data.dialog).parent().children().first().children().first().effect("pulsate")}else $(data.dialog).dialog("open");data.map.panTo(data.position);data.marker.setPosition(data.position)}else{var messageBox=document.createElement("div");messageBox.id="alarmdlg_"+skey;messageBox.className="alertmsg";messageBox.innerHTML="Система: <b>"+window.config.sysbykey[skey].desc+"</b>"+"<br/>Идентификатор: <b>"+data.fid+"</b>";if(document.body.firstChild)document.body.insertBefore(messageBox,
document.body.firstChild);else document.body.appendChild(messageBox);data.datetime=document.createElement("div");messageBox.appendChild(data.datetime);data.addres=document.createElement("div");messageBox.appendChild(data.addres);var dmap=document.createElement("div");dmap.id="alarmmap_"+String((new Date).getTime());dmap.className="alertmap";messageBox.appendChild(dmap);var $map=$(dmap).gmap({pos:data.position,zoom:15,marker:"center"});data.map=$($map).gmap("option","map");data.marker=new google.maps.Marker({position:data.position,
map:data.map,title:"Последнее известное положение.",icon:$.gmap.images["alarm"],draggable:false});alertcnt++;window.config.alarm[skey].dialog=$(messageBox).dialog({title:'<span class="ui-icon ui-icon-alert" style="display:inline-block;"></span> <span style="color:red;">Внимание! Нажата тревожная кнопка.</span>',resizable:false,modal:false,autoOpen:true,width:630,height:420,buttons:[{text:"Подтверждение",click:function(event,ui){var btn=event.currentTarget;var cncl_btn=event.currentTarget.nextSibling;
var dialog=this;log($(dialog).dialog("option","buttons"));console.dir($(dialog).dialog("option","buttons"));$(btn).button("option",{icons:{primary:"ui-icon-gear"},label:"Отправка подтверждения...",disabled:true});$.getJSON("/api/alarm/confirm?imei="+config.sysbykey[skey].imei,function(data){if(data.answer&&data.answer==="ok"){$(btn).button("option",{icons:{primary:"ui-icon-zoomin"},label:"Ожидание ответа...",disabled:true});push_informer(skey,"ALARM_CONFIRM",function(){log("Inform: wait-callback done.");
$(btn).button("option",{icons:{primary:"ui-icon-flag"},label:"Подтверждено!",disabled:true});window.config.alarm[skey].confirmed=true;window.config.alarm[skey].confirmby=window.config.account.user.nickname;window.config.alarm[skey].confirmwhen=Date_to_url(new Date);$(cncl_btn).button("option",{disabled:false});add_alert_icon(skey)})}})}},{text:"Отбой тревоги",click:function(event,ui){var btn=event.currentTarget;var conf_btn=event.currentTarget.previousSibling;var dialog=this;$(btn).button("option",
{icons:{primary:"ui-icon-gear"},label:"Отправка отмены...",disabled:true});$.getJSON("/api/alarm/cancel?imei="+window.config.sysbykey[skey].imei,function(data){if(data.answer&&data.answer==="ok"){$(btn).button("option",{icons:{primary:"ui-icon-zoomin"},label:"Ожидание ответа...",disabled:true});push_informer(skey,"ALARM_CANCEL",function(){log("Inform: wait-callback done.");$(btn).button("option",{icons:{primary:"ui-icon-flag"},label:"Тревога отменена!",disabled:true});$(conf_btn).button("option",
{disabled:true});remove_alert_icon(skey);delete window.config.alarm[skey];$(dialog).dialog("destroy");$("#alarmdlg_"+skey).remove()})}})}},{text:"Центровать на большой карте",click:function(){$(this).dialog("close");if($("#tabs").tabs("option","selected")!=0){$("#tabs").bind("tabsshow",function(event,ui){log("binded tab show");config.map.panTo(data.position);config.map.setZoom(15);$("#tabs").unbind(event)});$("#tabs").tabs("select",0)}else{config.map.panTo(data.position);config.map.setZoom(15)}}}],
open:function(event,ui){var btns=$(this).parent().find("button");if(window.config.alarm[skey].confirmed){log("find key:",this,$(this)[0],$(this).parent().find("button"));$(btns[0]).button("option",{disabled:true});$(btns[1]).button("option",{disabled:false})}else $(btns[1]).button("option",{disabled:true});var position=$(this).dialog("option","position");position.offset=""+alertcnt*16+" "+alertcnt*16;$(this).dialog("option","position",position);$(this).parent().css("border","3px solid red");$(this).parent().children().first().children().first().effect("pulsate")},
close:function(event,ui){alertcnt--;if(alertcnt<0)alertcnt=0}})}var sp="";var title="Тревога в:";if(data.dthistory.length>0)for(var i in data.dthistory){title+="\r\n"+dt_to_datetime(data.dthistory[i]);sp+="+"}data.datetime.innerHTML="Время: <b>"+dt_to_datetime(data.dt)+'</b><span style="cursor: pointer;" title="'+title+'">'+sp+"</span>";if(data.position.lat()==0&&data.position.lng()==0){data.addres.innerHTML="Положение объекта неизвестно. Отсутствует сигнал GPS.  "+'<span style="display:inline-block;border:1px solid black;cursor:pointer;border-radius:4px;" spid="2" title="Определить по вышкам сотовой связи (приблизительно)">GSM</span>';
$(data.addres).find('span[spid="1"]').click(function(){log("Show last")});$(data.addres).find('span[spid="2"]').click(function(){log("Show GPRS",data.ceng);$.getJSON("/api/gmap/ceng?ceng="+data.ceng,function(rdata){if(rdata.answer&&rdata.answer==="ok"){data.position=new google.maps.LatLng(rdata.loc[0],rdata.loc[1]);data.addres.innerHTML="Положение объекта по вышкам GSM: "+rdata.loc;data.map.panTo(data.position);if(geocoder)geocoder.geocode({"latLng":data.position},function(results,status){if(status==
google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);data.addres.innerHTML="Адрес: <b>"+address+"</b>";data.addres.title="Нажмите чтобы центровать на миникарте.";data.addres.style.cursor="pointer";$(data.addres).bind("click",function(event){data.map.panTo(data.position)})}else;})}})})}else if(geocoder)geocoder.geocode({"latLng":data.position},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);data.addres.innerHTML="Адрес: <b>"+address+
"</b>";data.addres.title="Нажмите чтобы центровать на миникарте.";data.addres.style.cursor="pointer";$(data.addres).bind("click",function(event){data.map.panTo(data.position)})}else;})};var add_alert_icon=function(skey){var ttle="Тревога "+dt_to_datetime(window.config.alarm[skey].dt);if(window.config.alarm[skey].confirmed)ttle+="\r\nТревога подтверждена оператором "+window.config.alarm[skey].confirmby;if($('div#alert_container>span[skey="'+skey+'"]').length>0)$('div#alert_container>span[skey="'+skey+
'"]').remove();$("div#alert_container").append('<span skey="'+skey+'" title="'+ttle+'">!</span>');$('div#alert_container>span[skey="'+skey+'"]').click(function(){show_alarm_window(skey,false)}).mouseenter(function(ev){var msg="Система:<b>"+window.config.sysbykey[skey].desc+"</b><br/>"+"Время:<b>"+dt_to_datetime(window.config.alarm[skey].dt)+"</b><br/>";if(window.config.alarm[skey].confirmed)msg+="Тревога подтверждена оператором:<b>"+window.config.alarm[skey].confirmby+"</b><br />"+dt_to_datetime(window.config.alarm[skey].confirmwhen)+
"<br/>";$(map).append('<div id="alarm_popup">'+msg+"</div>")}).mouseleave(function(){$("#alarm_popup").remove()}).mousemove(function(ev){$("#alarm_popup").css("left",ev.clientX-$("#alarm_popup").width()/2+"px")})};var show_alert_icons=function(){$.getJSON("/api/alarm/get",function(data){if(data.answer&&data.answer==="ok"){log("alarms:",data);for(var i in data.alarms){var d=data.alarms[i];if(d.skey in window.config.sysbykey){window.config.alarm[d.skey]=window.config.alarm[d.skey]||{};$.extend(window.config.alarm[d.skey],
d);add_alert_icon(d.skey)}}}})};window.config.alarm.show_alert_icons=show_alert_icons;config.updater.add("addlog",function(msg){log("BASE: Alert message",msg);if(msg.data["mtype"]!="alarm")return;window.config.alarm[msg.data.skey]=window.config.alarm[msg.data.skey]||{};$.extend(window.config.alarm[msg.data.skey],msg.data.data);window.config.alarm[msg.data.skey].lpos=[msg.data.data.lat,msg.data.data.lon];add_alert_icon(msg.data.skey);show_alarm_window(msg.data.skey,true)})})(jQuery);(function(window,$){var document=window.document;var sendGet=function(url){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.send()};var sendPost=function(url,body){var xhr=new XMLHttpRequest;xhr.open("POST",url,true);xhr.send(body)};var saveconfig=function(it,val){$("#button_config_restart").button("option","disabled",true);if(val)config.ui[it]=val;$.ajax({url:"/api/system/config",dataType:"json",data:config.ui,type:"POST",success:function(){$("#button_config_restart").button("option","disabled",
false)}})};var span=function(tag,title){var span_el=document.createElement("span");span_el.className="ui-widget ui-state-default ui-corner-all ui-button ui-button-text-only tags";span_el.title=title;span_el.innerText=tag;return span_el};var ConfigList;var cancel_alarm=function(){var skey=this.parentNode.dataset.skey;$.getJSON("/api/alarm/cancel?skey="+skey,function(data){log("Alarm canceled.")})};var ch_desc=function(){var li=this.parentNode.parentNode;var imei=li.dataset.imei;var skey=li.dataset.skey;
var olddesc=li.querySelector(".description").innerText;var dialog_div=config.helper.element_by_html(""+'<div title="Администрирование">'+"\tВведите описание для системы:<b>"+imei.replace(/-.*/,"")+"</b><br>"+'\t<textarea style="width:98%; resize: none;" rows="1">'+olddesc+"</textarea>"+"</div>"+"");$(dialog_div).find("textarea").keypress(function(ev){if(ev.which==13){$(this).parents('div[role="dialog"]').find("button").first().click();return false}return true});$(dialog_div).dialog({width:500,height:150,
modal:true,autoOpen:true,buttons:{"Применить изменения.":function(){var dialog=$(this);var desc=dialog.find("textarea").val();if(desc!=olddesc){li.querySelector(".description").innerText=desc;$.getJSON("/api/sys/desc?skey="+skey+"&desc="+encodeURIComponent(desc),function(data){if(data.result){var result=data.result;if(result=="disabled"){alert("Изменение описание заблокировано.");li.querySelector(".description").innerText=olddesc}else if(result=="ok");else{alert("Ошибка изменения описания. Отменено.");
li.querySelector(".description").innerText=olddesc}}})}$(this).dialog("close")},"Отменить":function(){$(this).dialog("close")}},close:function(ev,ui){$(this).dialog("destroy");document.body.removeChild(dialog_div)}})};var bzone=function(){var li=this.parentNode.parentNode;var imei=li.dataset.imei;var skey=li.dataset.skey;var desc=li.querySelector(".description").innerText;$("#config_zone_link_imei").html(imei);$("#config_zone_link_desc").html(desc);var dialog=$("#config_zone_link");dialog[0].dataset.skey=
skey;dialog.dialog("open")};var bconf=function(){var li=this.parentNode.parentNode;var imei=li.dataset.imei;var skey=li.dataset.skey;var desc=li.querySelector(".description").innerText;if($("#config_params").length===0)var div=$("body").append('<div id="config_params"><div id="config_params_body">Загрузка данных с сервера...</div></div>');else $("#config_params_body").html("Загрузка данных с сервера...");$.getJSON("/api/sys/config?cmd=get&skey="+skey,function(data){if(data.answer=="ok")if(data.config.length===
0)$("#config_params_body").empty().html("Нет параметров. Возможно система еще не сохранила параметры.<br/>Можно послать SMS на номер системы с текстом <strong>saveconfig</strong> для принудительного сохранения параметров.");else{var rows='<table class="tview"><thead><tr><th>№</th><th>Имя</th><th>Описание<span id="config_params_show_all" title="Показать все" class="cursor_pointer">...</span></th><th>Значение</th><th>Заводская установка</th><th>Очередь</th></tr></thead><tbody>';var index=1;for(var i in data.config){var v=
data.config[i];rows+='<tr name="'+v[0]+'"'+(v[1].desc?"":' class="config_hide"')+">";rows+="<td>"+index+"</td>";rows+="<td>"+v[0]+"</td>";if(config.admin)rows+='<td class="cfg_changeble">'+(v[1].desc||"-")+"</td>";else rows+="<td>"+(v[1].desc||"-")+"</td>";rows+='<td class="cfg_changeble'+(v[1].wait?" wait":"")+'">'+v[1].value+"</td>";rows+="<td>"+v[1]["default"]+"</td><td>"+(v[1].wait?v[1].wait:"")+"</td></tr>";index+=1}rows+="</tbody></table>";$("#config_params_body").empty().append(rows);$("#config_params").dialog("option",
"position","center");$("#config_params_show_all").click(function(){$(".config_hide").removeClass("config_hide");$("#config_params").dialog("option","position","center")});var tb=$("#config_params_body table tbody");tb.find("tr").find("td:first").next().next().click(function(){if(config.admin){var name=$(this).parent().attr("name");var pvalue=$(this).html();var nvalue=prompt("Введите описание для '"+name+"'",pvalue);if(nvalue&&nvalue!=pvalue){$(this).html(nvalue);sendGet("/api/param/desc?name="+name+
"&value="+nvalue)}}}).next().click(function(){var name=$(this).parent().attr("name");var pvalue=$(this).html();var nvalue=prompt("Введите значение для '"+name+"'",pvalue);if(nvalue&&nvalue!=pvalue){$(this).next().next().html(nvalue);$(this).addClass("wait");sendGet("/api/sys/config?cmd=set&skey="+skey+"&name="+name+"&value="+nvalue)}})}});$("div#config_params_body").css("max-height",$(window).height()-200);$("#config_params").dialog({width:"90%",modal:true,autoOpen:true,title:desc,buttons:{"Отменить задание на изменение параметров":function(){sendGet("/api/sys/config?cmd=cancel&skey="+
skey);$(this).dialog("close")},"Закрыть":function(){$(this).dialog("close")}}})};var bpurge=function(){var li=this.parentNode.parentNode;var imei=li.dataset.imei;var skey=li.dataset.skey;var desc=li.querySelector(".description").innerText;if($("#config_purgegps").length===0){$("body").append('<div id="config_purgegps">'+"Удаление GPS данных для системы<br/><strong><label></label></strong><br/><br/>"+'<span style="color: red">Внимание!</span> Данные старее выбранной даты будут удалены.'+'<input type="text" id="config_purgegps_alternate" disabled=sidabled size="30"/>'+
'<div id="config_purgegps"></div>'+"</div>");var div=$("#config_purgegps");$("#config_purgegps").datepicker({altField:"#config_purgegps_alternate",altFormat:"dd.mm.yy DD"})}$("#config_purgegps label").first().html(imei+":"+desc);$("#config_purgegps").dialog({autoOpen:true,title:"Удаление GPS данных",modal:true,minHeight:390,buttons:{"Отмена":function(){$(this).dialog("close")},"Выполнить!":function(){var dateto=$.datepicker.formatDate("ymmdd000000",$("#config_purgegps").datepicker("getDate"));$.getJSON("/api/geo/del?skey="+
skey+"&to="+dateto,function(data){if(data.answer=="ok")alert("Удаление данных поставлено в очередь. Это может потребовать некоторого времени.");else alert("Ошибка:\r\n"+data.result)});$(this).dialog("close")}}})};var bico=function(){alert("В разработке")};var bdel=function(){var li=this.parentNode.parentNode;var imei=li.dataset.imei;var skey=li.dataset.skey;var desc=li.querySelector(".description").innerText;$("#config_dialog_delsys")[0].dataset.skey=skey;$("#config_del_imei").html(imei);$("#config_del_desc").html(desc);
$("#config_dialog_delsys").dialog("open")};var btags=function(){var skey=this.parentNode.parentNode.dataset.skey;var s=config.sysbykey[skey];var avail_tags={};for(var k in config.sysbykey)for(var t in config.sysbykey[k].tags)avail_tags[config.sysbykey[k].tags[t]]=1;log("Доступные ярлыки:",avail_tags);var tag_dialog=config.helper.element_by_html(""+'<div title="Назначение ярлыков.">'+"\tСистема <b>"+config.sysbykey[skey].desc+"</b><br>"+"\t<br>Назначенные ярлыки:"+'\t<div id="btag_div_set" class="ui-widget ui-widget-content tview">'+
"\t</div>"+"\t<br>Доступные ярлыки:"+'\t<div id="btag_div_avail" class="ui-widget ui-widget-content tview">'+"\t</div>"+'\t<br><button id="btag_button_new">Добавить новый ярлык</button>'+'<details><summary><span class="pln">?</span></summary><span class="pln">Ярлык должен представлять собой короткое информативное слово или фразу.</span></details>'+"</div>"+"");var tag_set=tag_dialog.querySelector("#btag_div_set");var tag_avail=tag_dialog.querySelector("#btag_div_avail");for(var k in s.tags)tag_set.appendChild(span(s.tags[k],
"Нажмите чтобы отвязать данный ярлык от системы"));for(var k in avail_tags)if(s.tags.indexOf(k)==-1)tag_avail.appendChild(span(k,"Нажмите чтобы прикрепить данный ярлык к системе"));tag_set.addEventListener("click",function(ev){if(ev.target.nodeName=="SPAN"){tag_avail.appendChild(ev.target);var index=s.tags.indexOf(ev.target.innerText);s.tags.splice(index,1)}});tag_avail.addEventListener("click",function(ev){if(ev.target.nodeName=="SPAN"){tag_set.appendChild(ev.target);s.tags.push(ev.target.innerText)}});
$(tag_dialog).dialog({height:300,modal:true,open:function(ev,ui){$("#btag_button_new").button().click(function(){var nvalue=prompt("Введите название ярлыка");tag_set.appendChild(span(nvalue,"Нажмите чтобы отвязать данный ярлык от системы"));s.tags.push(nvalue);log("sys:",s)})},close:function(ev,ui){log("tag_dialog:close:",s.tags);config.helper.postJSON("/api/sys/tags",{skey:skey,tags:s.tags},function(data){log("/api/sys/tags call successful",data)});$(this).dialog("destroy");document.body.removeChild(tag_dialog)},
buttons:{"Закрыть":function(){$(this).dialog("close")}}})};config.updater.tabs[4]=function(){log("Tab Config activated.");$("#config_list").accordion("resize");if(!ConfigList){var ctl_div=document.createElement("span");ctl_div.innerHTML=""+'<button class="key bdesc mm" title="Изменить описание">...</button>'+'<\!--button class="bico hl mm" title="Выбрать пиктограмму">P</button--\>'+(config.admin?'<button class="bpurge hl mm" title="Удалить GPS данные!">D</button>':"")+'<button class="bconf hl mm" title="Настроить систему">C</button>'+
'<button class="key bzone mm" title="Привязать ГЕО-зону">З</button>'+(config.admin?'<button class="key calarm mm" title ="Принудительная отмена тревоги">T</button>':"")+'<button class="key btags mm" title="Назначить ярлыки">Я</button>'+'<button class="key bdel mm" title="Отказаться от слежения за системой">X</button>'+"";$(ctl_div).find("button").button();$(ctl_div).find(".bdesc").button().click(ch_desc);$(ctl_div).find(".calarm").button().click(cancel_alarm);$(ctl_div).find(".bzone").button().click(bzone);
$(ctl_div).find(".btags").button().click(btags);$(ctl_div).find(".bconf").button().click(bconf);if(config.admin)$(ctl_div).find(".bpurge").button().css("color","red").click(bpurge);$(ctl_div).find(".bico").button().click(bico);$(ctl_div).find(".bdel").button().click(bdel);ConfigList=new SysList("config_sys_list",{element:function(s){var li=document.createElement("li");li.className="ui-widget ui-widget-content ui-widget-header";li.innerHTML='<span class="ui-icon ui-icon-arrowthick-2-n-s mm msp"></span>'+
'<span class="spanbrd" title="IMEI">'+s.imei.replace(/-.*/,"")+'</span><span class="spanbrd" title="Телефон">'+(s.phone!="None"?s.phone:"не определен")+"</span>"+'<span class="description" style="width:200px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;">'+s.desc+"</span>"+"";var tag_block=document.createElement("span");tag_block.className="tag_block";li.appendChild(tag_block);for(var k in s.tags)tag_block.appendChild(span(s.tags[k],""));li.addEventListener("mouseover",
function(){this.appendChild(ctl_div);tag_block.style.display="none";return false},false);li.addEventListener("mouseout",function(ev){if(ev.target!=ctl_div&&ev.toElement!=ctl_div&&ev.target.parentNode!=ctl_div&&ev.toElement.parentNode!=ctl_div&&ev.target.parentNode.parentNode!=ctl_div&&ev.toElement.parentNode.parentNode!=ctl_div)this.removeChild(ctl_div);tag_block.style.display="";return false},false);return li}});config.updater.add("change_tag",function(msg){var li=ConfigList.element.querySelector('li[data-skey="'+
msg.skey+'"]>span.tag_block');if(li){li.innerHTML="";for(var t in msg.data.tags)li.appendChild(span(msg.data.tags[t],""))}});if(window.config.account.user.admin)$(".admin").show();$("#config_button_sys_add").click(function(){$("#config_dialog_addsys").dialog("open")});$("#config_dialog_addsys").dialog({width:400,height:200,modal:true,autoOpen:false,buttons:{"Добавить систему.":function(){var imei=$("#config_dialog_addsys #config_addsys_imei").val();$.getJSON("/api/sys/add?imei="+imei,function(data){if(data.result){var result=
data.result;if(result=="not found")$("#dialog_addsys_not_found").dialog("open");else if(result=="already")$("#dialog_addsys_already").dialog("open");else if(result=="added"){log("manual add",data.system);ConfigList.handlers.additem.call(ConfigList,data.system)}}});$(this).dialog("close")},"Отменить":function(){$(this).dialog("close")}}});var add_zone_rule=function(){var tbody=$("#config_zone_link table tbody");var select_zone='<select name="config_select_zone_list" style="width:100%;" title="Выберите зону" onchange="/*UpdateGroupList();*/">'+
'\t<option value="zz0">Зона 1</option>'+'\t<option value="zz1">Зона 2</option>'+'\t<option value="zz2">Зона 3</option>'+"</select>";var select_event='<select name="config_select_event_list" style="width:100%;" title="Группа" onchange="/*UpdateGroupList();*/">'+'\t<option value="0" title="Cообщение будет отражено в отчетах и в событиях">"Тихое" оповещение при покидании зоны</option>'+'\t<option value="1" title="Cообщение будет выведено на экран всем пользователям, наблюдающим за системой">"Cрочное" оповещение при покидании зоны</option>'+
'\t<option value="2">"Тихое" оповещение о вхождении в зону</option>'+'\t<option value="3">"Срочное" оповещение о вхождении в зону</option>'+'\t<option value="4">Начало трека при покидании зоны</option>'+'\t<option value="5">Конец трека при вхождении в зону</option>'+'\t<option value="6">Событие 6</option>'+'\t<option value="7">Событие 7</option>'+'\t<option value="8">Событие 8</option>'+'\t<option value="9">Событие 9</option>'+'\t<option value="10">Событие 10</option>'+"</select>";tbody.append("<tr><td>"+
select_zone+"</td><td>"+select_event+'</td><td>00:00:00</td><td>23:59:59</td><td>норма</td><td><button class="key">.</button></td></tr>');$("#config_zone_link table tbody tr:last td:last button").button({text:false,icons:{primary:"ui-icon-close"}}).click(function(){$(this).parent().parent().remove()})};window["config_delete_zone_rule"]=function(){};$("#config_zone_link_add_rule").click(function(){add_zone_rule()});$("#config_zone_link").dialog({width:800,height:650,modal:true,autoOpen:false,open:function(event,
ui){$(this).dialog("option","position","center")},buttons:{"Закрыть":function(){$(this).dialog("close")}}});$("#dialog_addsys_not_found").dialog({modal:true,autoOpen:false,buttons:{Ok:function(){$(this).dialog("close")}}});$("#dialog_addsys_already").dialog({modal:true,autoOpen:false,buttons:{Ok:function(){$(this).dialog("close")}}});$("#popup-sys").dialog({modal:true,autoOpen:false});$("#popup-sys li").button();$("#config_dialog_delsys").dialog({modal:true,autoOpen:false,buttons:{"Нет":function(){$(this).dialog("close")},
"Да, отказаться от слежения":function(){var imei=$("#config_del_imei").html();var skey=this.dataset.skey;$.getJSON("/api/sys/del?skey="+skey,function(data){});var ul=ConfigList.element;var li=ConfigList.element.querySelector("li[data-skey="+skey+"]");if(ul&&li)ul.removeChild(li);$(this).dialog("close")}}});$("#config_list").accordion({fillSpace:true,collapsible:true});$("#config_sys_list").sortable({handle:".msp",revert:true,scrollSpeed:5,stop:function(event,ui){var skey=ui.item[0].dataset.skey;var index=
ui.item.index();$.getJSON("/api/sys/sort?skey="+skey+"&index="+index,function(data){if(data.result)log("Set new position for "+skey+" to "+index)})}});$('#config_list select#config_set_theme option[value="'+config.ui.theme+'"]').attr("selected","selected");$("#config_list #config_set_theme").bind("change",function(){var themename=$(this).attr("value");saveconfig("theme",themename);config.account.config.theme=themename;window.config.setTheme(config.account.config.theme)});config.ui.trackcolor=config.ui.trackcolor||
"#dc00dc";$("#colorpickerHolder div").css("backgroundColor",config.ui.trackcolor);$("#colorpickerHolder").ColorPicker({color:config.ui.trackcolor,onShow:function(colpkr){$(colpkr).fadeIn(100);return false},onHide:function(colpkr){$(colpkr).fadeOut(100);saveconfig("trackcolor",null);return false},onChange:function(hsb,hex,rgb){config.ui.trackcolor="#"+hex;$("#colorpickerHolder div").css("backgroundColor",config.ui.trackcolor)}});$("#button_config_restart").click(function(){window.location.href=window.location.href});
if(config.admin){$("button.dbg_send_msg").click(function(){var imei=$(this).attr("imei");var text=$(this).attr("value");sendGet("/addlog?imei="+imei+"&text="+text)});$("button.dbg_send_cfg").click(function(){var imei=$(this).attr("imei");var text="";for(var i=0;i<100;i++)text+="dbg.name."+i+" INT "+i*10+" 10\n";sendPost("/config?cmd=save&imei="+imei,text)})}$(".cfg_iframe").click(function(){if($(this).find("div").length==0)$(this).append('<div><iframe src="'+$(this).attr("value")+'" style="width:100%; height: 70%;">'+
'Ваш браузер не поддерживает iframe. Сожалеем, но единственным выходом является использование другого браузера. Мы рекомендуем <a href="http://www.google.com/chrome?hl=ru">Google Chrome.</a>'+"</iframe></div>");else $(this).find("div").remove()});$(window).resize(function(){if(config.tab==4)$("#config_list").accordion("resize")});setTimeout(function(){$("#config_list").accordion("resize")},1E3);var show_admin_opetaions=function(cursor){var url;if(cursor)url="/api/admin/operations?cursor="+cursor;
else url="/api/admin/operations";$.getJSON(url,function(data){if(data.answer&&data.answer=="ok"){log("Admin operations",data);var table=$("#table_admin_operations tbody");table.empty();for(var i in data.operations){var d=data.operations[i];var row="<tr><td>"+dt_to_datetime(d.time)+"</td><td>"+d.desc+"</td><td>"+d.account+"</td><td>"+JSON.stringify(d.params)+"</td></tr>";table.append(row)}var row='<tr><td colspan=5><button id="button_next_admin_operations">Показать более старые записи</button></td></tr>';
table.append(row)}var cursor=data.cursor;$("#button_next_admin_operations").button().click(function(){show_admin_opetaions(cursor)})})};$("#button_admin_operations").click(function(){show_admin_opetaions()})}}})(this,jQuery);(function(){var $gmap=null;var gmap=null;var gmarker;var $p=$("#geos_body table tr:first th:last")[0];var skey;var GeosSysList;config.updater.tabs[3]=function(){$("#geomap").css("left",$p.offsetLeft+$p.offsetWidth);if(!$gmap){$gmap=$("#geomap").gmap({zoom:15});gmap=$($gmap).gmap("option","map");gmarker=new google.maps.Marker({map:gmap,title:"Положение",icon:$.gmap.images["center"],draggable:false});GeosSysList=new SysList("geos_syslist");GeosSysList.selectSys=function(system){skey=system.skey;genReport()};
if(window.config.account.systems&&window.config.account.systems.length>0){skey=window.config.account.systems[0].skey;genReport()}}else{log("== resize");google.maps.event.trigger(gmap,"resize")}};var tbody=$("#geos_body table tbody");var skey;var fsource={"0":"-",1:"SUDDENSTOP",2:"STOPACC",3:"TIMESTOPACC",4:"SLOW",5:"TIMEMOVE",6:"START",7:"TIMESTOP",8:"ANGLE",9:"DELTALAT",10:"DELTALONG",11:"DELTA"};var td=function(value){var res="";$.each(value,function(i,v){res+="<td>"+v+"</td>"});return res};var genReport=
function(){log("GEOS: Update report");var type=$("#geos_type_last").attr("checked");var date;if(type)date=new Date;else{date=$("#geos_datepicker").datepicker("getDate");if(!date)return;log("date",date)}$.getJSON("/api/geo/report",{skey:skey,from:Date_to_url(Date_to_daystart(date)),to:Date_to_url(Date_to_daystop(date))},function(data){if(data.answer&&data.answer=="ok"){var vdata={vout:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0},vin:{data:new google.visualization.DataTable,vmin:1E3,
vmax:-1E3,vsum:0},speed:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0},sats:{data:new google.visualization.DataTable,vmin:1E3,vmax:-1E3,vsum:0}};vdata.vout.data.addColumn("string","x");vdata.vin.data.addColumn("string","x");vdata.speed.data.addColumn("string","x");vdata.sats.data.addColumn("string","x");vdata.vout.data.addColumn("number","Основное питание");vdata.vin.data.addColumn("number","Резервное питание");vdata.speed.data.addColumn("number","Скорость");vdata.sats.data.addColumn("number",
"Спутники");var phm="";var vcnt=0;var p;var _slice=5,_tail="";if(data.points.length>200){_slice=4;_tail="0"}var add_data=function(name,digits){var value=parseFloat((vdata[name].vsum/vcnt).toFixed(digits));vdata[name].data.addRow([dt_to_time(p[0]).slice(0,_slice)+_tail,value]);vdata[name].vsum=0;vdata[name].vmin=Math.min(vdata[name].vmin,value);vdata[name].vmax=Math.max(vdata[name].vmax,value)};tbody.empty();for(var i in data.points){p=data.points[i];var row="<tr>";row+=td([dt_to_time(p[0]),p[1].toFixed(5),
p[2].toFixed(5),p[3],p[6].toFixed(1),p[4].toFixed(1),p[5].toFixed(2),fsource[p[7]]]);row+="</tr>";tbody.prepend(row);vdata.vout.vsum+=p[4];vdata.vin.vsum+=p[5];vdata.speed.vsum+=p[6];vdata.sats.vsum+=p[3];vcnt+=1;if(phm!=dt_to_time(p[0]).slice(0,_slice)){phm=dt_to_time(p[0]).slice(0,_slice);add_data("vout",2);add_data("vin",3);add_data("speed",2);add_data("sats",2);vcnt=0}}var draw_data=function(name,title){$("#geos_vis_"+name).empty();if(vdata[name].data.getNumberOfRows()>0){var chart=new google.visualization.LineChart(document.getElementById("geos_vis_"+
name));chart.draw(vdata[name].data,{curveType:"function",title:title,width:700,height:400,vAxis:{minValue:vdata[name].vmin,maxValue:vdata[name].vmax},chartArea:{left:40,top:20,width:650,height:330},legend:"none",hAxis:{slantedTextAngle:90}})}};draw_data("vout","Основное питание");draw_data("vin","Резервное питание");draw_data("speed","Скорость (средняя)");draw_data("sats","Спутники (усредненное значение)")}var $p=$("#geos_body table tr:first th:last")[0];$("#geomap").css("left",$p.offsetLeft+$p.offsetWidth);
$("#geos_body table tr").unbind("mouseover");$("#geos_body table tr").bind("mouseover",function(){if($(this).children()[1]&&$(this).children()[2]){var lat=parseFloat($(this).children()[1].innerHTML);var lon=parseFloat($(this).children()[2].innerHTML);if(!isNaN(lat)&&!isNaN(lon)){var pos=new google.maps.LatLng(lat,lon);gmap.panTo(pos);gmarker.setPosition(pos)}}})})};$("span.showchart").click(function(){var name=$(this).attr("value");log("showchart",name);$(".geos_vis").hide();$("#geos_vis_"+name).show();
$("#geos_previev").show("fast")});config.updater.add("geo_change",function(msg){log("GEOS: geo_change: ",msg.data);if(skey==msg.data.skey)if($("#geos_type_last").attr("checked"))genReport()});$("#geos_viewtype").buttonset({}).change(function(){genReport()});$("#geos_datepicker").datepicker()})();(function(window,$,undefined){var document=window.document;window.config.zones=window.config.zones||{};var zones=window.config.zones;var once_map_style=true;var drawingManager;var selectedShape;var colors=["#1E90FF","#FF1493","#32CD32","#FF8C00","#4B0082"];var selectedColor;var colorButtons={};function clearSelection(){if(selectedShape){selectedShape.setEditable(false);if(selectedShape.dirty){SaveZoneToServer(selectedShape);selectedShape.dirty=false}selectedShape=null;cancelFromLocal()}}function setSelection(shape){clearSelection();
selectedShape=shape;shape.setEditable(true);selectColor(shape.get("fillColor")||shape.get("strokeColor"))}function deleteSelectedShape(){if(selectedShape){deleteZone(selectedShape.zkey);cancelFromLocal()}}function selectColor(color){selectedColor=color;for(var i=0;i<colors.length;++i){var currColor=colors[i];colorButtons[currColor].style.border=currColor==color?"2px solid #789":"2px solid #fff"}var polylineOptions=drawingManager.get("polylineOptions");polylineOptions.strokeColor=color;drawingManager.set("polylineOptions",
polylineOptions);var rectangleOptions=drawingManager.get("rectangleOptions");rectangleOptions.fillColor=color;drawingManager.set("rectangleOptions",rectangleOptions);var circleOptions=drawingManager.get("circleOptions");circleOptions.fillColor=color;drawingManager.set("circleOptions",circleOptions);var polygonOptions=drawingManager.get("polygonOptions");polygonOptions.fillColor=color;drawingManager.set("polygonOptions",polygonOptions)}function setSelectedShapeColor(color){if(selectedShape)if(selectedShape.type==
google.maps.drawing.OverlayType.POLYLINE)selectedShape.set("strokeColor",color);else selectedShape.set("fillColor",color)}function makeColorButton(color){var button=document.createElement("span");button.className="color-button";button.style.backgroundColor=color;google.maps.event.addDomListener(button,"click",function(){selectColor(color);setSelectedShapeColor(color)});return button}function buildColorPalette(){var colorPalette=document.getElementById("color-palette");for(var i=0;i<colors.length;++i){var currColor=
colors[i];var colorButton=makeColorButton(currColor);colorPalette.appendChild(colorButton);colorButtons[currColor]=colorButton}selectColor(colors[0])}function deleteZone(zkey){var zone=zones[zkey];selectedShape=null;$.getJSON("/api/zone/del",{zkey:zkey},function(data){log("ok deleted Geo-zone.",data)});zone.overlay.setMap(null);$("#map_zones_list li[zkey="+zkey+"]").remove();delete zone.overlay;zone=null;delete zones[zkey];cancelFromLocal()}var update_zone_list=function(){var zone_type_names={"polygon":"Фигура",
"polyline":"Линия","circle":"Окружность","rectangle":"Прямоугольник"};$("#map_zones_list").empty();for(var i in zones){var zone=zones[i];$("#map_zones_list").append('<li zkey="'+i+'"> '+(zone_type_names[zone.type]||"<Неподдерживаемый тип>")+'<span title="Удалить зону." class="ui-icon ui-icon-close" foo="del"></li>')}$("#map_zones_list li").click(function(ev){var zkey=$(this).attr("zkey");var zone=zones[zkey];var bounds=zone.overlay.getBounds();window.config.map.fitBounds(bounds);setSelection(zone.overlay)}).mouseover(function(ev){var zkey=
$(this).attr("zkey");var zone=zones[zkey];zone.overlay.setOptions({strokeWeight:4})}).mouseout(function(ev){var zkey=$(this).attr("zkey");var zone=zones[zkey];if(zone.type=="polyline")zone.overlay.setOptions({strokeWeight:2});else zone.overlay.setOptions({strokeWeight:1})});$("#map_zones_list li span[foo=del]").click(function(ev){var zkey=$(this).parent().attr("zkey");log("Delete Geo-zone ",zkey);deleteZone(zkey)})};function saveToLocal(overlay){var data;switch(overlay.type){case "polygon":case "polyline":data=
overlay.getPath().getArray().map(function(el){return el.toArray()});break;case "circle":data={center:overlay.getCenter().toArray(),radius:overlay.getRadius()};break;case "rectangle":data={bounds:overlay.getBounds().toArray()};break}var save={zkey:overlay.zkey,type:overlay.type,data:data};localStorage.setItem("zones.last.edit",JSON.stringify(save,"","  "))}function restoreFromLocal(){var data=localStorage.getItem("zones.last.edit");if(data){data=JSON.parse(data);log("-- Restore editing from local storage",
data);if(data.zkey in config.zones){var overlay=config.zones[data.zkey].overlay;zones_show();zones_activate();setSelection(overlay);switch(config.zones[data.zkey].type){case "polygon":case "polyline":var path=overlay.getPath();path.clear();data.data.map(function(el){path.push(new google.maps.LatLng(el[0],el[1]))});break;case "circle":overlay.setCenter(new google.maps.LatLng(data.data.center[0],data.data.center[1]));overlay.setRadius(data.data.radius);break;case "rectangle":overlay.setBounds(new google.maps.LatLngBounds(new google.maps.LatLng(data.data.bounds[0][0],
data.data.bounds[0][1]),new google.maps.LatLng(data.data.bounds[1][0],data.data.bounds[1][1])));break}}}}function cancelFromLocal(){log("-- cancelFromLocal()");localStorage.removeItem("zones.last.edit")}function configEdit(newShape){google.maps.event.addListener(newShape,"click",function(){setSelection(newShape)});if(newShape.type=="polygon"||newShape.type=="polyline"){var vertices=newShape.getPath();google.maps.event.addListener(vertices,"insert_at",function(index){newShape.dirty=true;saveToLocal(newShape)});
google.maps.event.addListener(vertices,"remove_at",function(index,el){newShape.dirty=true;saveToLocal(newShape)});google.maps.event.addListener(vertices,"set_at",function(index,el){newShape.dirty=true;saveToLocal(newShape)})}else if(newShape.type=="circle"){google.maps.event.addListener(newShape,"radius_changed",function(){newShape.dirty=true;saveToLocal(newShape)});google.maps.event.addListener(newShape,"center_changed",function(){newShape.dirty=true;saveToLocal(newShape)})}else if(newShape.type==
"rectangle")google.maps.event.addListener(newShape,"bounds_changed",function(){newShape.dirty=true;saveToLocal(newShape)})}function LoadZones(){$.getJSON("/api/zone/get",function(data){if(data.answer&&data.answer=="ok"){for(var i in zones){zones[i].overlay.setMap(null);delete zones[i]}for(var i in data.zones){var zone=data.zones[i];var newShape;if(zone.type=="polygon"){var path=[];for(var j in zone.points)path.push(new google.maps.LatLng(zone.points[j][0],zone.points[j][1]));newShape=new google.maps.Polygon({path:path,
clickable:false,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.35})}else if(zone.type=="circle")newShape=new google.maps.Circle({center:new google.maps.LatLng(zone.points[0][0],zone.points[0][1]),radius:zone.radius,clickable:false,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.35});else if(zone.type=="rectangle")newShape=new google.maps.Rectangle({bounds:new google.maps.LatLngBounds(new google.maps.LatLng(zone.points[0][0],
zone.points[0][1]),new google.maps.LatLng(zone.points[1][0],zone.points[1][1])),clickable:false,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:1,fillColor:"#FF0000",fillOpacity:0.35});else if(zone.type=="polyline"){var path=[];for(var j in zone.points)path.push(new google.maps.LatLng(zone.points[j][0],zone.points[j][1]));newShape=new google.maps.Polyline({path:path,clickable:false,strokeColor:"#FF0000",strokeOpacity:0.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.35})}else continue;zones[zone.zkey]=
zone;zones[zone.zkey]["overlay"]=newShape;newShape["zkey"]=zone.zkey;newShape["type"]=zone.type;configEdit(newShape)}update_zone_list();restoreFromLocal()}})}function SaveZoneToServer(overlay){var points=[];if(overlay.zkey)log("Complete editing zone. Saving...",overlay);else log("Complete drawing zone. Saving...",overlay);if(overlay.type=="polygon"||overlay.type=="polyline"){var vertices=overlay.getPath();for(var i=0;i<vertices.length;i++){var p=vertices.getAt(i);points.push([p.lat(),p.lng()])}}else if(overlay.type==
"circle"){var p=overlay.getCenter();points.push([p.lat(),p.lng()]);var b=overlay.getBounds();p=b.getSouthWest();points.push([p.lat(),p.lng()]);p=b.getNorthEast();points.push([p.lat(),p.lng()]);p=overlay.getRadius();points.push([p,p])}else if(overlay.type=="rectangle"){var p=overlay.getBounds().getSouthWest();points.push([p.lat(),p.lng()]);p=overlay.getBounds().getNorthEast();points.push([p.lat(),p.lng()])}else{log("Error! Unsupported zone type.");return}$.ajax({url:"/api/zone/add",dataType:"json",
data:{type:overlay.type,points:JSON.stringify(points),zkey:overlay.zkey,bounds:JSON.stringify(overlay.getBounds().toArray())},type:"post",success:function(data){if(data&&data.answer=="ok"){log("Add polygon to zkey or modify it");if(!overlay.zkey){zones[data.zkey]={};zones[data.zkey]["overlay"]=overlay;zones[data.zkey]["zkey"]=data.zkey;zones[data.zkey]["type"]=overlay.type;update_zone_list()}overlay.zkey=data.zkey}}})}function ZoneKit(){LoadZones();var polyOptions={strokeWeight:0,fillOpacity:0.45,
editable:true};drawingManager=new google.maps.drawing.DrawingManager({drawingControl:false,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.CIRCLE,google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.RECTANGLE]},polylineOptions:{editable:true},rectangleOptions:polyOptions,circleOptions:polyOptions,polygonOptions:polyOptions,map:config.map});google.maps.event.addListener(drawingManager,
"overlaycomplete",function(e){var newShape=e.overlay;if(e.type==google.maps.drawing.OverlayType.POLYGON)newShape.type="polygon";else if(e.type==google.maps.drawing.OverlayType.CIRCLE)newShape.type="circle";else if(e.type==google.maps.drawing.OverlayType.POLYLINE)newShape.type="polyline";else if(e.type==google.maps.drawing.OverlayType.RECTANGLE)newShape.type="rectangle";SaveZoneToServer(newShape);drawingManager.setDrawingMode(null);configEdit(newShape);setSelection(newShape)});if(0){drawingManager.setOptions({drawingControl:false});
drawingManager.setOptions({drawingControl:true})}google.maps.event.addListener(drawingManager,"drawingmode_changed",clearSelection);google.maps.event.addListener(map,"click",clearSelection);google.maps.event.addDomListener(document.getElementById("delete-button"),"click",deleteSelectedShape);buildColorPalette()}var zone_showed=false;var zones_show=function(){zone_showed=true;$("#map_zone_show>span").css("background-color","lime");for(var i in zones)zones[i].overlay.setMap(window.config.map)};var zones_hide=
function(){zone_showed=false;$("#map_zone_show>span").css("background-color","");for(var i in zones)zones[i].overlay.setMap(null)};ZoneKit.prototype.Show=function(){if(!zone_showed)zones_show();else zones_hide()};var track_edit_mode=false;var zones_activate=function(){for(var i in zones){var zone=zones[i];zone.overlay.setOptions({clickable:true});var eventsclick=google.maps.event.addListener(zone.overlay,"mouseover",function(event){if("zkey"in this)$("#map_zones_list li[zkey="+this.zkey+"]").addClass("highlight");
this.setOptions({strokeWeight:4})});var eventsleave=google.maps.event.addListener(zone.overlay,"mouseout",function(event){if("zkey"in this)$("#map_zones_list li[zkey="+this.zkey+"]").removeClass("highlight");if(this.type=="polyline")this.setOptions({strokeWeight:2});else this.setOptions({strokeWeight:1})})}};var zones_deactivate=function(){clearSelection();for(var i in zones){var zone=zones[i];if(zone.type=="polyline")zone.overlay.setOptions({clickable:false,strokeWeight:2});else zone.overlay.setOptions({clickable:false,
strokeWeight:1})}};ZoneKit.prototype.Edit=function(){var self=this;if($("#zone_panel").css("display")=="none"){$("#map_zone_edit>span").css("background-color","lime");$("#zone_panel").show("fast");$("#zone_edit_panel").show();zones_show();zones_activate();drawingManager.setOptions({drawingControl:true})}else{$("#map_zone_edit>span").css("background-color","");$("#zone_panel").hide("fast");$("#zone_edit_panel").hide();zones_deactivate();drawingManager.setOptions({drawingControl:false})}};window["ZoneKit"]=
ZoneKit})(window,jQuery);(function(window,$,undefined){var document=window.document;var directionsDisplay=null;var directionsService=new google.maps.DirectionsService;var map;var currentDirections=null;var dir_panel;var track_mode=false;var events={fclick:null,sclick:null};var points=[];var setMarker=function(point_data,position){if(point_data.marker)point_data.marker.setPosition(position);else{point_data.marker=new google.maps.Marker({position:position,map:window.config.map,title:"",draggable:true});google.maps.event.addListener(point_data.marker,
"dragend",function(event){log("moved",event,this);geocoder.geocode({"latLng":event.latLng},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=results[0].formatted_address;log(address,results);point_div.querySelector("input").value=address;point_data.address=address}})})}geocoder.geocode({"latLng":position},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=results[0].formatted_address;log(address,results);point_data.point_div.querySelector("input").value=
address;point_data.address=address}})};var initRoute=function(){directionsDisplay=new google.maps.DirectionsRenderer({"map":window.config.map,"hideRouteList":true,"draggable":true});google.maps.event.addListener(directionsDisplay,"directions_changed",function(){currentDirections=directionsDisplay.getDirections();if(currentDirections.routes.length>1)log("Предлагается более одного маршрута");var leg=currentDirections.routes[0].legs[0];log("currentDirections",currentDirections,leg);for(var i=0,l=leg.via_waypoint.length+
2-points.length;i<l;i++)add_way_point("");points[0].point_div.querySelector("input").value=leg.start_address;setMarker(points[0],leg.start_location);points[points.length-1].point_div.querySelector("input").value=leg.end_address;setMarker(points[points.length-1],leg.end_location);for(var i=0,l=leg.via_waypoints.length;i<l;i++){points[i+1].point_div.querySelector("input").value=leg.via_waypoints[i].toString();setMarker(points[i+1],leg.via_waypoints[i])}dir_panel.querySelector('span[name="distance"]').innerText=
currentDirections.routes[0].legs[0].distance.text;dir_panel.querySelector('span[name="duration"]').innerText=currentDirections.routes[0].legs[0].duration.text})};var calcRoute=function(start,end){var request={origin:"",destination:"",travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.METRIC,region:"de"};request.origin=points[0].marker?points[0].marker.position:points[0].address;request.destination=points[points.length-1].marker?points[points.length-1].marker.position:
points[points.length-1].address;if(points.length>2){request.waypoints=[];for(var i=1;i<points.length-1;i++)request.waypoints.push({location:points[i].marker?points[i].marker.position:points[i].address,stopover:false})}log("calcRoute",points,request);for(var i=0,l=points.length;i<l;i++)if(points[i].marker)points[i].marker.setMap(null);directionsService.route(request,function(response,status){log("Route done",response,status);if(status==google.maps.DirectionsStatus.OK)directionsDisplay.setDirections(response)})};
function DirKit(){}if("google"in window)geocoder=new google.maps.Geocoder;var add_way_point=function(title){var point_data={};var point_div=config.helper.element_by_html(""+'<div style="position: relative;">'+'<div style="position:absolute;left:0px;top:0px;"><button title="Указать на карте">.</button><\!--button title="Удалить">x</button><br--\></div>'+'<div style="margin-left:30px;"><input style="width:100%;" placeholder="'+title+'"></input></div>'+"</div>"+"");$(point_div).find("button").button({icons:{primary:"ui-icon-search"},
text:false});dir_panel.firstElementChild.appendChild(point_div);point_data.point_div=point_div;point_div.querySelector("button").addEventListener("click",function(){if(point_data.marker)config.map.panTo(point_data.marker.position);else{message("Укажите точку на карте.");google.maps.event.addListenerOnce(window.config.map,"click",function(event){setMarker(point_data,event.latLng)})}},false);points.push(point_data);var input=point_div.querySelector("input");var autocomplete=new google.maps.places.Autocomplete(input);
autocomplete.bindTo("bounds",config.map);google.maps.event.addListener(autocomplete,"place_changed",function(){var place=autocomplete.getPlace();if(!place)return;if(place.geometry.viewport)config.map.fitBounds(place.geometry.viewport);else{config.map.setCenter(place.geometry.location);config.map.setZoom(17)}point_data.address=input.value;setMarker(point_data,place.geometry.location);log("Адрес:",place)})};var show_dir_panel=false;DirKit.prototype.Route=function(){if(!dir_panel){dir_panel=config.helper.element_by_html(""+
'<div class="map_panel">'+'<div name="points">'+"</div>"+'<button name="addpoint" style="display:block;margin:auto" title="Добавить пункт назначения">+</button>'+'<div id="directions_panel" style="width:100%;"></div>'+'<button name="route">Проложить маршрут</button><br>'+'<div style="padding-top:10px;padding-bottom:10px;border-top:1px solid #ddd;border-bottom:1px solid #ddd;">'+'Протяженность: <span name="distance">?</span><br>'+'Время в пути: <span name="duration">?</span><br>'+"</div>"+'<button name="save">Сохранить</button>'+
'<button name="cancel">Очистить</button><br>'+"</div>"+"");$(dir_panel).find("button").button();$($(dir_panel).find("button")[0]).button({icons:{primary:"ui-icon-plus"},text:false});dir_panel.querySelector('button[name="save"]').addEventListener("click",function(){var label=prompt("Введите имя маршрута",""+points[0].address+" - "+points[points.length-1].address);alert("В разработке...")},false);dir_panel.querySelector('button[name="cancel"]').addEventListener("click",function(){for(var i in points)if(points[i].marker)points[i].marker.setMap(null);
points=[];dir_panel.firstElementChild.innerHTML="";add_way_point("Начальная точка");add_way_point("Конечная точка")},false);add_way_point("Начальная точка");add_way_point("Конечная точка");dir_panel.querySelector('button[name="addpoint"]').addEventListener("click",function(){add_way_point("Введите адрес")},false);dir_panel.querySelector('button[name="route"]').addEventListener("click",function(){calcRoute()},false);initRoute()}if(!show_dir_panel){show_dir_panel=true;this.firstChild.style.backgroundColor=
"lime";document.getElementById("panel").appendChild(dir_panel)}else{show_dir_panel=false;this.firstChild.style.backgroundColor="";document.getElementById("panel").removeChild(dir_panel)}};DirKit.prototype.oldRoute=function(){var start_marker=null;if(!track_mode){track_mode=true;message("Укажите начальную точку трека.");$("#map_track_calc>span").css("background-color","lime");events.fclick=google.maps.event.addListenerOnce(window.config.map,"click",function(event){var start=event.latLng;start_marker=
new google.maps.Marker({position:start,map:window.config.map,title:"",icon:$.gmap.images["start"],draggable:true});message("Укажите конечную точку трека.");events.sclick=google.maps.event.addListenerOnce(window.config.map,"click",function(event){var end=event.latLng;start_marker.setMap(null);start_marker=null;if(!directionsDisplay)initRoute();calcRoute(start,end);$("#dir_panel").show("fast")})})}else{track_mode=false;$("#dir_panel").hide("fast");google.maps.event.removeListener(events.fclick);if(events.sclick!=
null)google.maps.event.removeListener(events.sclick);if(start_marker){start_marker.setMap(null);start_marker=null}$("#map_track_calc>span").css("background-color","")}};window["DirKit"]=DirKit})(window,jQuery);(function(window,$){var doc=window.document;var map=null;var show_bounds=false;var geocoder;var ruler1=null;var skey=null;var prev_minp=-1;var flightPlanCoordinates=[];var showed_path=[];var flightPath=null;var flightPathBounds=null;var stop_markers=[];var PROFILE=false;function Profile(name){if(!PROFILE)return;this.name=name;this.start=new Date;log("Profile: "+name+" start ")}Profile.prototype.show=function(){if(!PROFILE)return;var end=new Date;var time=end.getTime()-this.start.getTime();log("Profile: "+
this.name+" - "+time+" ms")};var main_bound_rectangle=null;var sub_bounds=[];var sub_bound_rectangles=[];var sub_bound_indexes=[];var search_bound_rectangle=null;var GetPath=function(skey_,from,to){skey=skey_;ruler1.setSysKey(skey);$.getJSON("/api/geo/get?skey="+skey+"&from="+from+"&to="+to,function(data){if(data.answer&&data.points.length>0)ParcePath(data)})};var dt_to_Date=function(d){return new Date(Date.UTC(parseInt("20"+d[0]+d[1],10),parseInt(d[2]+d[3],10)-1,parseInt(d[4]+d[5],10),parseInt(d[6]+
d[7],10),parseInt(d[8]+d[9],10),parseInt(d[10]+d[11],10)))};var stop_infowindow;var marker_start=null;var marker_finish=null;var ParcePath=function(data){var profile=new Profile("GetPath");profile.show();flightPlanCoordinates=[];for(var i in data.points){var l=new google.maps.LatLng(data.points[i][1],data.points[i][2],false);l.date=data.points[i][0];l.angle=data.points[i][3];l.zoom=data.points[i][4];flightPlanCoordinates.push(l)}flightPathBounds=new google.maps.LatLngBounds(new google.maps.LatLng(data.bounds.sw[0],
data.bounds.sw[1]),new google.maps.LatLng(data.bounds.ne[0],data.bounds.ne[1]));map.fitBounds(flightPathBounds);profile.show();sub_bounds=[];sub_bound_indexes=[];for(var i in data.subbounds){sub_bounds.push(new google.maps.LatLngBounds(new google.maps.LatLng(data.subbounds[i].sw[0],data.subbounds[i].sw[1]),new google.maps.LatLng(data.subbounds[i].ne[0],data.subbounds[i].ne[1])));sub_bound_indexes.push(data.subbounds[i].i)}if(show_bounds){for(var i in sub_bounds)if(sub_bound_rectangles.length<=i)sub_bound_rectangles.push(new google.maps.Rectangle({bounds:sub_bounds[i],
map:map,clickable:false,fillColor:"#00FF00",fillOpacity:0.1,strokeColor:"#00FF00",strokeOpacity:1,strokeWeight:1}));else sub_bound_rectangles[i].setBounds(sub_bounds[i]);if(sub_bound_rectangles.length>sub_bounds.length)for(var i=sub_bounds.length;i<sub_bound_rectangles.length;i++)sub_bound_rectangles[i].setBounds(null)}profile.show();for(var i in stop_markers)stop_markers[i].setMap(null);stop_markers=[];for(var i in data.stops){var dstop=dt_to_Date(data.points[data.stops[i].i][0]);var dstart=dt_to_Date(data.points[data.stops[i].s][0]);
var dt=(dstart-dstop)/1E3;var tp="";var icon;if(dt>5*60){tp="стоянка ";icon=$.gmap.images["stop"]}else{tp="остановка ";icon=$.gmap.images["halt"]}var marker=new google.maps.Marker({position:new google.maps.LatLng(data.stops[i].p[0],data.stops[i].p[1]),map:map,title:tp+td_to_hms(dt)+"\n"+dt_to_datetime(data.points[data.stops[i].i][0])+"..."+dt_to_datetime(data.points[data.stops[i].s][0]),icon:icon,draggable:false});google.maps.event.addListener(marker,"click",function(moev){if(1){var position=this.position;
geocoder.geocode({"latLng":this.position},function(results,status){if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);if(stop_infowindow)stop_infowindow.close();stop_infowindow=new google.maps.InfoWindow({content:address,position:position});stop_infowindow.open(map)}else alert("Geocoder failed due to: "+status)})}});stop_markers.push(marker)}if(data.points.length>0){if(marker_start)marker_start.setMap(null);if(marker_finish)marker_finish.setMap(null);marker_start=new google.maps.Marker({position:new google.maps.LatLng(data.points[0][1],
data.points[0][2]),map:map,title:"Начало трека: "+dt_to_datetime(data.points[0][0]),icon:$.gmap.images["begin"],draggable:false});if($("#datepicker").datepicker("getDate").toDateString()!=(new Date).toDateString())marker_finish=new google.maps.Marker({position:new google.maps.LatLng(data.points[data.points.length-1][1],data.points[data.points.length-1][2]),map:map,title:"Конец трека: "+dt_to_datetime(data.points[data.points.length-1][0]),icon:$.gmap.images["end"],draggable:false})}profile.show();
DrawPlyline();PathRebuild()};var once=true;var PathRebuild=function(){var profile=new Profile("PathRebuild");var mapzoom=map.getZoom();showed_path=[];for(var i=0;i<flightPlanCoordinates.length;i++){var p=flightPlanCoordinates[i];if(p.zoom<=mapzoom)showed_path.push(p)}profile.show();if(flightPath)flightPath.setPath(showed_path);profile.show();if(config.admin)$("#mark1").html("Точек в треке: "+showed_path.length+"/"+flightPlanCoordinates.length);else $("#mark1").html("Точек в треке: "+flightPlanCoordinates.length)};
var UpdateMarker=function(moev){var start=new Date;if(showed_path.length==0)return;var mapzoom=map.getZoom();var size=0.0030*Math.pow(2,13-mapzoom);if(size<1.0E-4)size=1.0E-4;var clat=Math.cos(moev.latLng.lat()*Math.PI/180);if(clat<1.0E-4)clat=1.0E-4;var bound=new google.maps.LatLngBounds(new google.maps.LatLng(moev.latLng.lat()-size*clat,moev.latLng.lng()-size),new google.maps.LatLng(moev.latLng.lat()+size*clat,moev.latLng.lng()+size));if(show_bounds)if(!search_bound_rectangle)search_bound_rectangle=
new google.maps.Rectangle({bounds:bound,map:map,fillColor:"#00FFFF",fillOpacity:0.1,strokeColor:"#00FFFF",strokeOpacity:1,strokeWeight:1});else search_bound_rectangle.setBounds(bound);var total_points=0;var mind=1E9;var minp=0;if(sub_bound_indexes.length!=0)for(var i in sub_bounds)if(bound.intersects(sub_bounds[i])){if(show_bounds)sub_bound_rectangles[i].setOptions({strokeWeight:3,fillOpacity:0.3});total_points+=sub_bound_indexes[i].length;for(var j in sub_bound_indexes[i]){var p=flightPlanCoordinates[sub_bound_indexes[i][j]];
if(bound.contains(p)){var d=distance(moev.latLng,p);if(d<mind){mind=d;minp=sub_bound_indexes[i][j]}}}}else if(show_bounds)sub_bound_rectangles[i].setOptions({strokeWeight:1,fillOpacity:0.1});if(minp!=prev_minp){ruler1.setPosition(flightPlanCoordinates[minp]);prev_minp=minp;ruler1.HideInfo()}var end=new Date;var time=end.getTime()-start.getTime();if(config.admin)$("#mark2").html("in s/bounds: "+total_points+" time: "+time)};var CreateMap=function(){geocoder=new google.maps.Geocoder;var $map=$("#map").gmap({pos:new google.maps.LatLng(48.370848,
32.717285),zoom:6,markertitme:"aaa"});map=$($map).gmap("option","map");config.map=map;google.maps.event.addListener(map,"zoom_changed",function(){PathRebuild()});google.maps.event.addListener(map,"mousemove",UpdateMarker);ruler1=new MyMarker(map);var input=document.getElementById("input_map_address");var autocomplete=new google.maps.places.Autocomplete(input);autocomplete.bindTo("bounds",map);google.maps.event.addListener(autocomplete,"place_changed",function(){var place=autocomplete.getPlace();if(place.geometry.viewport)map.fitBounds(place.geometry.viewport);
else{map.setCenter(place.geometry.location);map.setZoom(17)}var address="";if(place.address_components)address=[place.address_components[0]&&place.address_components[0].short_name||"",place.address_components[1]&&place.address_components[1].short_name||"",place.address_components[2]&&place.address_components[2].short_name||""].join(" ");log("Address",place.name,address,place)})};var lastpos={};var CreateLastMarker=function(s){if(!("last"in s)){log("No last in data",s);return}var pos=new google.maps.LatLng(s.last.point.lat,
s.last.point.lon);if(lastpos[s.skey]){lastpos[s.skey].time=dt_to_Date(s.last.point.time).getTime();lastpos[s.skey].position=pos;lastpos[s.skey].marker.setPosition(s.last.point,pos);if(0)lastpos[s.skey].tail.setPath(tail_path)}else{if(0){var tailPath=new google.maps.Polyline({path:tail_path,strokeColor:config.ui.trackcolor||"#dc00dc",strokeOpacity:1,strokeWeight:3});tailPath.setMap(map)}var last_pos_marker=new LastMarker({point:s.last.point,position:pos,map:map,desc:s.desc,skey:s.skey});lastpos[s.skey]=
{position:pos,time:dt_to_Date(s.last.point.time).getTime(),marker:last_pos_marker}}};var dateInterval=function(){for(var i in lastpos){var now=+new Date;var dt=(now-lastpos[i].time)/1E3;var dt_days=Math.floor(dt/60/60/24);var dt_days_lab=dt_days%10==1&&dt_days!=11?" день ":dt_days%10 in{2:0,3:0,4:0}&&!(dt_days in{12:0,13:0,14:0})?" дня ":" дней ";dt=dt-dt_days*60*60*24;var dt_hours=Math.floor(dt/60/60);var dt_hours_lab=dt_hours%10==1&&dt_hours!=11?" час ":dt_hours%10 in{2:0,3:0,4:0}&&!(dt_hours in
{12:0,13:0,14:0})?" часа ":" часов ";dt=dt-dt_hours*60*60;var dt_mins=Math.floor(dt/60);var dt_mins_lab=dt_mins%10==1&&dt_mins!=11?" минута ":dt_mins%10 in{2:0,3:0,4:0}&&!(dt_mins in{12:0,13:0,14:0})?" минуты ":" минут ";if(MapSysList){var el=MapSysList.element.querySelector('li[data-skey="'+i+'"]>span:first-child');if(el)el.title="Поледнее известное положение\n"+dt_days+dt_days_lab+dt_hours+dt_hours_lab+dt_mins+dt_mins_lab+"назад"}}};setInterval(dateInterval,6E4);var GetLastPositions=function(){config.updater.add("geo_change_last",
function(msg){CreateLastMarker(msg.data);dateInterval()})};var distance=function(p1,p2){var R=6371;var dLat=(p2.lat()-p1.lat())*Math.PI/180;var dLon=(p2.lng()-p1.lng())*Math.PI/180;var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(p1.lat()*Math.PI/180)*Math.cos(p2.lat()*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d};var DrawPlyline=function(){if(flightPath)return;flightPath=new google.maps.Polyline({strokeColor:config.ui.trackcolor||
"#dc00dc",strokeOpacity:1,strokeWeight:3});flightPath.setMap(map);if(0){google.maps.event.addListener(flightPath,"click",function(moev){});google.maps.event.addListener(flightPath,"mouseover",function(moev){});google.maps.event.addListener(flightPath,"mouseout",function(moev){})}};var ClearPath=function(skey){var profile=new Profile("Clear path");showed_path=[];if(flightPath)flightPath.setPath(showed_path);for(var i in stop_markers)stop_markers[i].setMap(null);stop_markers=[];profile.show()};var prev_sender=
null;var SetDay=function(skey,start,stop){GetPath(skey,Date_to_url(start),Date_to_url(stop))};var dbg_data=null;var DayList=function(skey,month){$.getJSON("/api/geo/dates?skey="+skey+"&month="+month,function(data){dbg_data=data;if(data.answer){config.daylist=config.daylist||{};config.daylist.skey=skey;config.daylist.year=data.year;config.daylist.month=data.month;config.daylist.days=data.days;$("#datepicker").datepicker("refresh")}})};var params={changedEl:"select",scrollArrows:true};var UpdateDayList=
function(){var date=$("#datepicker").datepicker("getDate");if(!config.cur_month)config.cur_month=$.datepicker.formatDate("yymm",date);DayList(config.skey,config.cur_month)};var UpdateGroupList=function(){var group=$("#group_list").attr("value");log("Select group:"+group)};var Map_SysList=function(list){list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<li class="ui-widget ui-state-default" imei="'+s.imei+'" skey="'+s.skey+'">'+'  <span class="ui-icon ui-icon-zoomin" title="Центровать последнее положение на карте"></span>'+
s.desc+"</li>")}list.find("li").click(function(){}).mouseover(function(){}).mouseout(function(){$('.lastmarker[skey="'+$(this).attr("skey")+'"]').removeClass("lastup")}).find("span").click(function(){})};config.cur_month=null;CreateMap();$("#date_tabs").tabs();$("#nav_map").button("option","disabled",true);$.datepicker.setDefaults($.datepicker.regional["ru"]);$("#datepicker").datepicker({altField:"#alternate",altFormat:"yymmdd",minDate:"-12m +0w",maxDate:"+0m +0w",hideIfNoPrevNext:true,onSelect:function(dateText,
inst){var start=$(this).datepicker("getDate");var stop=new Date(start);stop.setHours(23);stop.setMinutes(59);stop.setSeconds(59);SetDay(config.skey,start,stop)},onChangeMonthYear:function(year,month,inst){config.cur_month=""+year+(month<10?"0"+month:month);UpdateDayList()},beforeShowDay:function(date){if(!config.daylist||config.daylist.year!=date.getFullYear()||config.daylist.month!=date.getMonth()+1)return[false,"","Загрузка информации с сервера..."];var da=date.getDate();if(config.daylist.days.indexOf(da)!=
-1)return[true];else return[false,"","В этот день система не выходила на связь"]}});$(".panel_control").click(function(){var panel=$(this).parent();if(panel.hasClass("stat-hided")){panel.removeClass("stat-hided");$(this).find("span").removeClass("ui-icon-circle-triangle-w").addClass("ui-icon-circle-triangle-e");$("#map").removeClass("stat-hided")}else{panel.addClass("stat-hided");$(this).find("span").removeClass("ui-icon-circle-triangle-e").addClass("ui-icon-circle-triangle-w");$("#map").addClass("stat-hided")}});
GetLastPositions();if(config.skey)UpdateDayList(config.skey);var MapSysList;config.updater.tabs[0]=function(){if(!MapSysList)MapSysList=new SysList("map_ul_sys",{element:function(s){var li=document.createElement("li");li.className="ui-widget ui-state-default";li.addEventListener("click",function(e){var skey=this.dataset.skey;[].forEach.call(this.parentNode.querySelectorAll("li"),function(el){el.classList.remove("ui-state-highlight")});this.classList.add("ui-state-highlight");config.skey=skey;UpdateDayList();
if(lastpos[config.skey])map.panTo(lastpos[config.skey].position)});li.addEventListener("mouseover",function(e){[].forEach.call(document.querySelectorAll(".lastmarker"),function(el){el.classList.remove("lastup")});document.querySelector('.lastmarker[skey="'+this.dataset.skey+'"]').classList.add("lastup")});li.addEventListener("mouseout",function(e){document.querySelector('.lastmarker[skey="'+this.dataset.skey+'"]').classList.remove("lastup")});li.innerHTML='<span class="ui-icon ui-icon-zoomin" title="Центровать последнее положение на карте"></span>'+
s.desc;CreateLastMarker(s);return li},taggroupid:"group_list",tagchange:function(tag,index){log("map tag change",this,tag,index);for(var k in config.sysbykey){var s=config.sysbykey[k];if(index==0||s.tags.indexOf(tag)!=-1)document.querySelector('.lastmarker[skey="'+k+'"]').style.display="";else document.querySelector('.lastmarker[skey="'+k+'"]').style.display="none"}}});google.maps.event.trigger(map,"resize")};document.getElementById("map_btn_cleartrack").addEventListener("click",function(){if(flightPath)flightPath.setPath([]);
if(marker_start)marker_start.setMap(null);if(marker_finish)marker_finish.setMap(null);flightPlanCoordinates=[];showed_path=[]});var zonekit=new ZoneKit;$("#map_zone_show").click(zonekit.Show);$("#map_zone_edit").click(zonekit.Edit);var dirkit=new DirKit;$("#map_track_calc").click(dirkit.Route)})(window,jQuery);(function(window,$){var geocoder;var adrlist=[];var getGeocode=function(adrlist,i,recur){if(adrlist[i].stop)log("stop: "+i);if(geocoder)geocoder.geocode({"latLng":new google.maps.LatLng(adrlist[i].pos[0],adrlist[i].pos[1])},function(results,status){if(adrlist[i].stop){log("stop2: "+i);return}if(status==google.maps.GeocoderStatus.OK){var address=geocode_to_addr(results);$("#"+adrlist[i].id).html(address).attr("title","");delete adrlist[i];var empty=true;for(var j in adrlist){empty=false;break}if(empty==
true)$(".control").show()}else if(recur)adrlist[i].cb=setTimeout(function(){getGeocode(adrlist,i,recur-1)},6E3);else log("Error geocoding at "+i+" with ")});else delete adrlist[i]};var genReport=function(skey,start,stop,title){for(var i in adrlist){clearInterval(adrlist[i].cb);adrlist[i].stop=true}$("#report_header").html("Отчет для системы "+config.sysbykey[skey].desc+" за "+title+"");$("#report tbody").empty();$.getJSON("/api/report/get?skey="+skey+"&from="+start+"&to="+stop,function(data){log("getJSON parce");
if(data.answer=="ok"){log("Show report...");$("#report_total_dist").html(ln_to_km(data.summary.length));$("#report_total_movetime").html(td_to_hms(data.summary.movetime));$("#report_total_avspeed").html(data.summary.speed.toFixed(1)+" км/ч");$("#report_total_stoptime").html(td_to_hms(data.summary.stoptime));$("#report_total_maxspeed").html(data.summary.maxspeed.toFixed(1)+" км/ч");var tbody=$("#report tbody");adrlist=[];var cur_date="";if(data.report.length==0)tbody.append("<tr><td>Нет данных.</td></tr>");
for(var i in data.report){var ad_id="ad_"+i;var rec=data.report[i];var tp;switch(rec.type){case "move":if(rec.duration==0)continue;tp="Движение</td><td>"+ln_to_km(rec.length)+", "+rec.speed.toFixed(1)+" км/ч";break;case "stop":if(rec.duration<5*60)tp="Остановка";else tp="Стоянка";adrlist.push({pos:rec.start.pos,id:ad_id,stop:false});tp+='</td><td id="'+ad_id+'" title="Дождитесь окончания обновления">'+rec.start.pos;break;default:tp="Неизвестное событие ("+rec.type+")"}var events="";for(var j in rec.events){log("Event: ",
j,rec.events[j]);switch(j){case "path_break":events+='<span class="ui-icon ui-icon-alert" style="float:right;" title="Разрыв или повреждение трека. Данные отчета могут быть не точными." value="'+rec.events[j]+'"></span>';break}}if(cur_date!=dt_to_date(rec.start.time)){cur_date=dt_to_date(rec.start.time);tbody.append('<tr><td colspan="4" style="padding-top: 8px; padding-bottom: 8px; font-weight: bold;">'+cur_date+"</td></tr>")}tbody.append("<tr>"+"<td>"+'\t<\!--button class="ctl" style="float: left;"><span class="ui-icon ui-icon-cancel" title="Убрать из отчета информацию о движении"></span></button>'+
'\t<button class="ctl" style="float: left;"><span class="ui-icon ui-icon-locked" title="Оставить в отчете только информацию о движении"></span></button--\>'+'\t<\!--button class="ctl" style="float: left;"><span class="ui-icon ui-icon-zoomin" title="Показать этот путь на карте" onclick="showMap('+rec.start.pos+",'Стоянка "+td_to_hms(rec.duration)+" с "+dt_to_time(rec.start.time)+" по "+dt_to_time(rec.stop.time)+"', "+rec.start.time+');"></span></button--\>'+'\t<button class="ctl" style="float: left;"><span class="ui-icon ui-icon-zoomin" title="Показать на карте" onclick="showMap2(\''+
rec.start.time+"','"+rec.stop.time+"', '"+rec.type+"');\"></span></button>"+tp+events+"</td>"+"<td>"+dt_to_time(rec.start.time)+" - "+dt_to_time(rec.stop.time)+"</td>"+"<td>"+""+td_to_time(rec.duration)+"</td>"+"</tr>")}$(tbody).children("tr").click(function(){$(this).css("font-weight","bold")});for(var i in adrlist){if(i==0)$(".control").hide();(function(i){adrlist[i].cb=setTimeout(function(){getGeocode(adrlist,i,50)},1E3)})(i)}$(".ctl").button()}})};var purgeReport=function(){$("#report tbody").empty()};
var showMap2=function(from,to,type){var map_div=$("#map_preview");if(map_div.length==0){var div=$("body").append('<div id="map_overlay" class="ui-widget-overlay"></div>').append('<div id="map_preview" style="">Загрузка карты, ожидайте...</div>');var map_div=$("#map_preview");$("#map_preview").append('<div id="rmap"></div>').append('<div id="map_close" style="position: absolute; top: -10px; left: 50%; margin-left: -20px;"><span class="ui-icon ui-icon-close"></span></div>');$("#map_close").button().click(function(){$("#rmap").gmap("destroy");
$("#map_preview").remove();$("#map_overlay").remove()});$.getJSON("/api/geo/get?skey="+config.skey+"&from="+from+"&to="+to+"&options=nosubbounds",function(data){if(data.answer&&data.points.length>0){log("ShowMap2:",data);var $map=$("#rmap").gmap({pos:new google.maps.LatLng(data.points[0][1],data.points[0][2]),zoom:15,marker:"center"});var map=$($map).gmap("option","map");if(type=="move"){map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(data.bounds.sw[0],data.bounds.sw[1]),new google.maps.LatLng(data.bounds.ne[0],
data.bounds.ne[1])));var path=[];for(var i in data.points){var l=new google.maps.LatLng(data.points[i][1],data.points[i][2],false);path.push(l)}var flightPath=new google.maps.Polyline({map:map,path:path,strokeColor:config.ui.trackcolor||"#dc00dc",strokeOpacity:1,strokeWeight:3});var marker_start=new google.maps.Marker({position:new google.maps.LatLng(path[0].lat(),path[0].lng()),map:map,title:"Старт: "+dt_to_datetime(data.points[0][0]),icon:$.gmap.images["begin"],draggable:false});var marker_finish=
new google.maps.Marker({position:new google.maps.LatLng(path[path.length-1].lat(),path[path.length-1].lng()),map:map,title:"Финиш: "+dt_to_datetime(data.points[path.length-1][0]),icon:$.gmap.images["end"],draggable:false})}else var marker_stop=new google.maps.Marker({position:new google.maps.LatLng(data.points[0][1],data.points[0][2]),map:map,title:"Стoянка: "+"\n"+dt_to_datetime(data.points[0][0])+"..."+dt_to_datetime(data.points[data.points.length-1][0]),icon:$.gmap.images["stop"],draggable:false})}})}};
window["showMap2"]=showMap2;if(0)var showMap=function(lat,lon,title){var map_div=$("#map_preview");if(map_div.length==0){div=$("body").append('<div id="map_overlay" class="ui-widget-overlay"></div>').append('<div id="map_preview" style="">Ошибка отображения карты</div>');var map_div=$("#map_preview");$("#map_preview").append('<div id="rmap"></div>').append('<div id="map_close" style="position: absolute; top: -10px; left: 50%; margin-left: -20px;"><span class="ui-icon ui-icon-close"></span></div>');
console.log();var $map=$("#rmap").gmap({pos:new google.maps.LatLng(lat,lon),zoom:15,marker:"center",markertitme:title});var map=$($map).gmap("option","map");$("#map_close").button().click(function(){$("#map_preview").gmap("destroy");$("#map_preview").remove();$("#map_overlay").remove()})}log(map_div)};var init;config.updater.tabs[1]=function(){log("Tab Reports activated.");if(!init){init=true;if("google"in window)geocoder=new google.maps.Geocoder;$("#nav_reports").button("option","disabled",true);
$("#button_report_type_div").buttonset();$("#button_report_type_day").bind("change",function(){$("#report_div_type_interval").hide("slow");$("#report_div_type_day").show("slow");log("Boo")});$("#button_report_type_interval").bind("change",function(){$("#report_div_type_day").hide("slow");$("#report_div_type_interval").show("slow");log("Boo")});$(".control").button();$.datepicker.setDefaults($.datepicker.regional["ru"]);$("#total tbody tr td").bind("click",function(me){log(me)});log("Загрузка закладки. Отчеты.",
$("#report_date_by_day"));$("#report_date_by_day").datepicker({altField:"#report_dlg_byday_alternate",altFormat:"DD, d MM, yy"});$("#report_dlg_byday").dialog({modal:true,autoOpen:false,buttons:{"Отмена":function(){$(this).dialog("close")},"Построить отчет":function(){$(this).dialog("close");var start=$("#report_date_by_day").datepicker("getDate");var stop=new Date(start);stop.setHours(23);stop.setMinutes(59);stop.setSeconds(59);log("start:",start,"stop:",stop);config.skey=$("#report_dlg_byday_syslist").val();
genReport(config.skey,Date_to_url(start),Date_to_url(stop),$.datepicker.formatDate("dd/mm/yy",start))}},open:function(event,ui){var list=$("#report_dlg_byday_syslist");list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+s.imei+'" value="'+s.skey+'"'+(s.skey==config.skey?" selected":"")+">"+s.desc+"</option>")}}});var dates=$("#report_date_by_int_from, #report_date_by_int_to").datepicker({altFormat:"DD, d MM, yy",onSelect:function(selectedDate){var option=
this.id=="report_date_by_int_from"?"minDate":"maxDate",instance=$(this).data("datepicker");date=$.datepicker.parseDate(instance.settings.dateFormat||$.datepicker._defaults.dateFormat,selectedDate,instance.settings);dates.not(this).datepicker("option",option,date)}});$("#report_date_by_int_from").datepicker("option","altField","#report_dlg_byint_alternate_from");$("#report_date_by_int_to").datepicker("option","altField","#report_dlg_byint_alternate_to");$("#report_dlg_byint").dialog({modal:true,autoOpen:false,
width:600,buttons:{"Отмена":function(){$(this).dialog("close")},"Построить отчет":function(){var start=$("#report_date_by_int_from").datepicker("getDate");var stop=$("#report_date_by_int_to").datepicker("getDate");var time_from=$("#report_dlg_byint_time_from").val();var time_to=$("#report_dlg_byint_time_to").val();log(time_from,/^\d\d:\d\d:\d\d$/.test(time_from),time_to,/^\d\d:\d\d:\d\d$/.test(time_to));if(!/^\d\d:\d\d:\d\d$/.test(time_from)||!/^\d\d:\d\d:\d\d$/.test(time_to)){alert("Время должно задаваться в формате ЧЧ:MM:CC");
return}$(this).dialog("close");config.skey=$("#report_dlg_byint_syslist").val();start.setHours(parseInt(time_from.slice(0,2),10));start.setMinutes(parseInt(time_from.slice(3,5),10));start.setSeconds(parseInt(time_from.slice(6,8),10));stop.setHours(parseInt(time_to.slice(0,2),10));stop.setMinutes(parseInt(time_to.slice(3,5),10));stop.setSeconds(parseInt(time_to.slice(6,8),10));genReport(config.skey,Date_to_url(start),Date_to_url(stop)," интервал с "+Date_to_datetime(start)+" по "+Date_to_datetime(stop))}},
open:function(event,ui){var list=$("#report_dlg_byint_syslist");list.empty();for(var i in config.systems){var s=config.systems[i];list.append('<option imei="'+s.imei+'" value="'+s.skey+'"'+(s.skey==config.skey?" selected":"")+">"+s.desc+"</option>")}}});$("#report_btn_do_by_day").button({icons:{primary:"ui-icon-note"}}).click(function(){$("#report_dlg_byday").dialog("open")}).next().button({icons:{primary:"ui-icon-note"}}).click(function(){$("#report_dlg_byint").dialog("open")});if(1)$("#report_export_xls").button().click(function(){var tbody=
$("#report tbody");log("export to XLS tbody:",tbody);var rows=[];var format5=function(n){if(n<10)return"0000"+n;else if(n<100)return"000"+n;else if(n<1E3)return"00"+n;else if(n<1E4)return"0"+n;else return""+n};$("#report tbody tr").each(function(ind,el){var line=[];$(el).children("td").each(function(tdi,tdel){line.push(tdel.textContent)});rows.push(line)});log("rows:",rows);$.ajax({url:"/export/xls",type:"post",data:{data:JSON.stringify(rows)},success:function(data,textStatus,jqXHR){var val=$.parseJSON(data);
log("ok, data:",data,"val:",val);$("#export_iframe").attr("src","/export/get/"+encodeURI($("#report_header").text().replace(/[\/:?\\<*>|"']/gi,"-"))+".xls?key="+val.key);log("header",$("#report_header").html())}})})}};$(document).ready(function(){})})(window,jQuery);(function(window){var document=window.document,skey,table,tfoot,config=window.config,cursor;var delete_log_listener=function(){this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);config.helper.postJSON("/api/logs/del",{skey:skey,lkey:this.dataset.lkey},function(data){})};var log_line=function(d){var element=document.createElement("tr");var row="<td>";if(config.admin)row+='<span class="ui-icon ui-icon-close del_log" style="display: inline-block;" title="Удалить сообщение\nБез подтверждения!" data-lkey="'+
d.key+'"></span>';row+=dt_to_datetime(d.time)+"</td><td>"+d.text+"<\!--td>"+d.label+"</td--\>";element.innerHTML=row;if(config.admin)element.querySelector("td>span").addEventListener("click",delete_log_listener,false);return element};var load_next_lines=function(newcursor){var url="/api/logs/get?skey="+skey;if(newcursor)url+="&cursor="+newcursor;tfoot.style.display="none";config.helper.getJSON(url,function(data){if(data.answer&&data.answer=="ok"){if(data.logs.length==0){var tr=document.createElement("tr");
tr.innerHTML='<td colspan="2">Нет событий</td>';table.appendChild(tr)}[].forEach.call(data.logs,function(l){table.appendChild(log_line(l))});cursor=data.cursor;tfoot.style.display=data.logs.length==0||data.done?"none":""}else;})};var UpdateLog=function(){config.helper.empty(table);load_next_lines()};var LogSysList;config.updater.tabs[2]=function(){log("Tab Logs activated.");if(!LogSysList){table=document.querySelector("#log_table tbody");tfoot=document.querySelector("#log_table tfoot");tfoot.addEventListener("click",
function(){load_next_lines(cursor)},false);LogSysList=new SysList("log_syslist",{select:function(system){skey=system.skey;UpdateLog()}});if(window.config.account.systems&&window.config.account.systems.length>0){skey=window.config.account.systems[0].skey;UpdateLog()}config.updater.add("addlog",function(msg){if(msg.data.skey==skey)table.insertBefore(log_line(msg.data),table.firstChild)})}}})(window);(function(window){$("button").button();var show=function(index){log("TAB: show: ",index,$(this));log("config:",config.updater);config.tab=index;if("tabs"in config.updater&&config.updater.tabs[index])if(config.inits){log("TAB: show in inits: ",index,$(this));config.inits.push(function(){log("TAB: show in inits: ",index,$(this));config.updater.tabs[index]()})}else{log("TAB: show direct: ",index,$(this));config.updater.tabs[index]()}else log("TAB: no tabs",config.updater,config.updater.tabs[index])};
log("tabs init");var $tabs=$("#tabs").tabs({cookie:{expires:30,name:"maintab"},cache:true,spinner:"Retrieving data...",show:function(){show($(this).tabs("option","selected"))}})})(window);
