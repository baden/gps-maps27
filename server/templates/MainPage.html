<!doctype html>  
<html>

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ --> 
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>GPS наблюдение</title>
  <meta name="description" content="GPS monitoring">
  <meta name="author" content="Batrak Denis (denis@batrak.net">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">	<!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <link rel="stylesheet" href="/stylesheets/style.css?v=1">	<!-- CSS : implied media="all" -->
  <!--link rel="stylesheet" media="handheld" href="css/handheld.css?v=2"-->	<!-- Uncomment if you are specifically targeting less enabled mobile browsers -->

  <!--link id="themecss" type="text/css" href="/plugins/jquery-ui-themes-1.8.16/jquery-ui-themes-1.8.16/themes/{{ account.pconfig.theme }}/jquery.ui.all.css" rel="stylesheet"-->
  <link id="themecss" type="text/css" href="/plugins/jquery-ui-themes-1.8.16/jquery-ui-themes-1.8.16/themes/{{ account.pconfig.theme }}/jquery-ui.css" rel="stylesheet">
  <link type="text/css" href="/stylesheets/e.css" rel="stylesheet">
  <!--link type="text/css" href="/stylesheets/tabs.css" rel="stylesheet"-->

  <script src="/js/loader.js?version={{ version }}"></script>
  <script>
	loader.setVersion('{{ version }}');
	loader.require('/stylesheets/tabs.css');
	/*loader.require('/js/jquery.min.js');
	loader.require('/js/jquery.cookie.js');
	loader.require('/js/jquery-ui.min-1.8.7.js');
	loader.require('/js/jquery.ui.datepicker-ru.js');*/
	loader.require('/js/alert.js');
  </script>

  <script type="text/javascript" src="/js/jquery.min-1.7.js"></script>
  <script type="text/javascript" src="/js/jquery.cookie.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.16/jquery-ui-1.8.16/ui/jquery-ui.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.16/jquery-ui-1.8.16/ui/i18n/jquery.ui.datepicker-ru.js"></script>

  <link type="text/css" href="/plugins/jquery-ui-timepicker-0.2.9/jquery.ui.timepicker.css" rel="stylesheet">
  <script type="text/javascript" src="/plugins/jquery-ui-timepicker-0.2.9/jquery.ui.timepicker.js"></script>

  <script type="text/javascript" src="/_ah/channel/jsapi"></script>

  <!--script src="/js/googlemaps/js.js" type="text/javascript"></script-->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language=ru"></script>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript">
	if(('google' in window) && ('maps' in google)){
	} else {
		var fileref=document.createElement('script');
		fileref.setAttribute('type', 'text/javascript');
		fileref.setAttribute('src', '/js/googlemaps/js.js');
		document.getElementsByTagName('head')[0].appendChild(fileref);
	}

	if(('google' in window) && ('load' in google)) {
		google.load('visualization', '1', {packages: ['corechart']});
	} else {
		alert('Сервер Google недоступен. \n1. Проверьте интернет-соединение. \n2. Обновите страницу (F5).');
	}
  </script>

  <script src="/js/base.js?v=2"></script>

  <script>
	loader.require('/js/mymarker.js');
	loader.require('/js/lastmarker.js');
	loader.require('/js/gmap.js');
	loader.require('/js/alarm.js');
  </script>

  <!--script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20843583-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script-->

  <script>
	var config = config || {};
	config.username = "{{ user.nickname() }}";
	//config.skey = "{ account.systems.0.key }";
	config.akey = "{{ account.key() }}";
	{% if admin %}
	config.admin = true;
	{% else %}
	config.admin = false;
	{% endif %}
	
	config.systems = [];
	config.sysbykey = {};

	{% for sys in account.systems %}
	config.systems.push({
		'skey': '{{ sys.key() }}',
		'imei': '{{ sys.imei }}',
		'desc': '{{ sys.desc }}'
	});
	config.sysbykey['{{ sys.key() }}'] = {'imei': '{{ sys.imei }}', 'desc': '{{ sys.desc }}'};
	{% endfor %}

	if(config.systems.length == 0) config.skey = '';
	else config.skey = config.systems[0].skey;

	config.ui = {{ account.config|safe }};
	//log("ConfigUI: ", config.ui);

	//log('CONFIG==', config);
	$(document).ready(function() {
		$("button").button();
		var $tabs = $("#tabs").tabs({
			cookie: { expires: 30, name: 'maintab' },
			effect: 'ajax',
			cache: true,
			spinner: 'Retrieving data...',
			show: function(){
				var index = $(this).tabs( "option", "selected" );
				//log('TAB: show: ', index, $(this));
				log('config:', config);
				config.tab = index;
				if(('tabs' in config.updater) && (config.updater.tabs[index])) config.updater.tabs[index]();
			},
			load: function(){
				//log('TAB: tab loaded: ', $(this).tabs( "option", "selected" ));
				$("button").button();

			}
		});

		$("button#tabreload").click(function(){
			log('Reload tab...');
			$tabs.tabs('load', $tabs.tabs('option', 'selected'));
		});

		//var connected = false;
	
		// Установим chanel-соединение
		// Получим токен для установки соединения
		var uuid = new Date().getTime();
		$.getJSON('/api/channel/gettoken?uuid={{ user.user_id() }}_' + uuid, function (data) {
			if(data.token){
				var token = data.token;
				log("Token goted:" + token, 'uuid={{ user.user_id() }}');

				var onOpened = function() {
					log('goog.appengine.Channel: onOpened ('+token+')');
					//connected = true;
				}

				var onMessage = function(m) {
					var msg = JSON.parse(m.data);
					config.updater.process(msg);
					//config.updater.process({msg: '*'});
				}

				var onError = function() {
					log("goog.appengine.Channel: onError");
				}

				var onClose = function() {
					log("goog.appengine.Channel: onClose (TBD! Reconnect?)");
					//connected = false;
				}
				if(window.location.hostname == 'localhost'){
					goog.appengine.Socket.POLLING_TIMEOUT_MS = 10000;
				}

				var channel = new goog.appengine.Channel(token);
				var socket = channel.open();
				socket.onopen = onOpened;
				socket.onmessage = onMessage;
				socket.onerror = onError;
				socket.onclose = onClose;
			}
		});

		$('#test').click(function(){
			log('Test');
			//window.location.reload();
			window.location.href = window.location.href;
		});

	});
	//$("#draggable").draggable();
  </script>
  <style>
	div#logout {
		position: absolute;
		top: 6px;
		right: 10px;
	}

	{% if not admin %}
	.admin {
		display: none;
	}
	{% endif %}

  </style>
</head>

<body>
	<div id="tabs">
	  <!--div style="position: absolute; left:0px; top:0px;">C</div-->
	  <ul>
	    <li><a href="/html/Tab_Map.html?version={{ version }}"><span class="ui-icon ui-icon-zoomin"></span>Карта</a></li>
	    <li><a href="/html/Tab_Reports.html?version={{ version }}"><span class="ui-icon ui-icon-info"></span>Отчеты</a></li>
	    <li><a href="/html/Tab_Logs.html?version={{ version }}"><span class="ui-icon ui-icon-alert"></span>События</a></li>
	    <li><a href="/html/Tab_Geos.html?version={{ version }}"><span class="ui-icon ui-icon-document"></span>Экспорт GPS</a></li>
	    <li><a href="/html/Tab_Config.html?version={{ version }}"><span class="ui-icon ui-icon-gear"></span>Настройка</a></li>
	    <li><a href="/html/Tab_Help.html?version={{ version }}"><span class="ui-icon ui-icon-help"></span>Помощь</a></li>
	  </ul>
	</div>
	<div id="logout">
		<!--a style="margin-right: 5px;" href="https://siteheart.com/webconsultation/34969?" target="siteheart_sitewindow_34969" onclick="o=window.open;o('https://siteheart.com/webconsultation/34969?', 'siteheart_sitewindow_34969', 'width=550,height=400,top=30,left=30,resizable=yes'); return false;"><img src="http://webindicator.siteheart.com/webindicator/livehelp10?ent=34969&company=34969" border="0" alt="SiteHeart" /></a-->
		<audio id="sound_alarm" loop="loop"><source src="sound/alarm.ogg" /><source src="sound/alarm.mp3" /></audio>
		<div style="display: none;">{{ environ }}</div>
		<div style="display: none;">{{ version }}</div>
		<a href="{{ login_url }}">{{ user.nickname() }}</a>
		<!--button id="tabreload">Reload</button-->
		<!--button id="test">Test</button-->
	</div>
</body>
</html>
